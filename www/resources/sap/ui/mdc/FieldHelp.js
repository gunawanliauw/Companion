/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/base/ObjectPool','sap/m/Popover','sap/ui/core/XMLTemplateProcessor','sap/ui/model/base/ManagedObjectModel'],function(q,C,O,R,X,M){"use strict";var F=C.extend("sap.ui.mdc.FieldHelp",{constructor:function(i,s,S){C.apply(this,arguments);},metadata:{library:"sap.ui.mdc",properties:{type:{type:"string",defaultValue:""},value:{type:"any",defaultValue:null},currentValue:{type:"any",defaultValue:null},height:{type:"sap.ui.core.CSSSize",defaultValue:"auto"},width:{type:"sap.ui.core.CSSSize",defaultValue:"auto"},icon:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:null},closeOnSelect:{type:"boolean",defaultValue:false},liveChanging:{type:"boolean",defaultValue:false},focusOnOpen:{type:"boolean",defaultValue:true},verticalScrolling:{type:"boolean",defaultValue:false},dataType:{type:"any",defaultValue:"string"},dataTypeOptions:{type:"object"}},events:{select:{},close:{},liveChange:{}},aggregations:{content:{type:"sap.ui.core.Control",multiple:true}},associations:{triggerClose:{type:"string"},triggerSelect:{type:"string"},triggerSelectClose:{type:"string"}},publicMethods:[],defaultAggregation:"content",defaultProperty:"value"},renderer:function(){}});F.DefaultTypes=["Auto"];F.TypeMapping={};var f={};F._registerDataTypes=function(s,t,a){if(typeof t==="string"){t=t.replace(/ /gi,"").split("");}if(t&&t.length){for(var i=0;i<t.length;i++){F.TypeMapping[t[i]]=s;}}if(a){if(F.DefaultTypes.indexOf(s)===-1){F.DefaultTypes.push(s);}}};F._loadSettings=function(n){var x=X.loadTemplate(n,"defaults");if(x&&x.childNodes){var a=x.querySelectorAll("FieldHelp");for(var i=0;i<a.length;i++){var N=a[i];if(N.namespaceURI==="sap.ui.mdc"){var t=x.cloneNode();t.appendChild(N);var d=N.getAttribute("defaultType"),D=N.getAttribute("defaultDataTypes");if(d){N.removeAttribute("defaultType");N.setAttribute("type",d);N.removeAttribute("defaultDataTypes");F._registerDataTypes(d,D||"",true);}f[N.getAttribute("type")]={xml:t,icon:N.getAttribute("icon"),dataType:N.getAttribute("dataType")};}}}};F._loadSettings("sap.ui.mdc.FieldHelp");F._isDefaultType=function(t){return this.DefaultTypes.indexOf(t)>-1;};F._getId=function(t){if(this._isDefaultType()){return"FieldHelp-"+t;}return t;};F._getTypeFromDataType=function(d){if(d.getName){var n=d.getName();return F.TypeMapping[n];}else{return F.TypeMapping[d];}};F._getIcon=function(t,d){if(!t){return null;}if(t==="Auto"&&d){t=this._getTypeFromDataType(d);if(!f[t]){return null;}}var i=null;if(f[t]){i=f[t].icon;}if(!i&&t){i="sap-icon://value-help";}return i;};F._getDataType=function(t,d){if(!t){return null;}if(t==="Auto"&&d){t=this._getTypeFromDataType(d);}var D=null;if(f[t]){D=f[t].dataType;}return D;};F.Free={_count:0};F.open=function(c,s){function a(h,c){return function(g){h.call(c,g);};}var e=F.getMetadata().getEvents();for(var n in e){if(s[n]){s[n]=a(s[n],c);}}var o=F.borrowInstance(s,c);o.open(c);var b=o.getTriggerClose();var t;var E;if(b){t=sap.ui.getCore().byId(b.substring(0,b.indexOf("#"))+o.getId().substring(o.getId().lastIndexOf("-")));E=b.substring(b.indexOf("#")+1);if(t){t.attachEventOnce(E,o.close.bind(o));}}var S=o.getTriggerSelect();if(S){t=sap.ui.getCore().byId(S.substring(0,S.indexOf("#"))+o.getId().substring(o.getId().lastIndexOf("-")));E=S.substring(S.indexOf("#")+1);if(t){t.attachEventOnce(E,o.selectionChange.bind(o));}}var d=o.getTriggerSelectClose();if(d){t=sap.ui.getCore().byId(d.substring(0,d.indexOf("#"))+o.getId().substring(o.getId().lastIndexOf("-")));E=d.substring(d.indexOf("#")+1);if(t){t.attachEventOnce(E,o.selectClose.bind(o));}}return o;};F.createTemplate=function(t){var T=sap.ui.getCore().byId(t);if(T){return T;}if(f.hasOwnProperty(t)){if(!f[t].template&&f[t].xml){f[t].template=sap.ui.xmlfragment({sId:"sap.ui.mdc.FieldHelp."+t,fragmentContent:f[t].xml,oController:this});}T=f[t].template;}if(!T){q.sap.log.error("Opening a FieldHelp with "+t+" has no valid FieldHelp control reference nor it is a default field help");}return T;};F.borrowInstance=function(s,c){if(!s||!s.type){q.sap.log.error("Opening a FieldHelp with no type or settings is not possible");return null;}var o,t=s.type;if(!F.Free[t]){F.Free[t]=[];}if(F.Free[t].length>0){return F.Free[t].pop().applySettings(s);}var T=F.createTemplate(t);if(T){o=T.clone();o.applySettings(s);return o;}q.sap.log.error("FieldHelp could not be created");return null;};F.returnInstance=function(I){var t=I._sCustomType||I.getType(),e=F.getMetadata().getEvents();for(var n in e){var h=I.mEventRegistry[n];if(h){for(var i=0;i<h.length;i++){I.detachEvent(n,h[i].fFunction,h[i].oListener);}}}if(!F.Free[t]){F.Free[t]=[];}F.Free[t].push(I);};F.prototype.applySettings=function(s){C.prototype.applySettings.apply(this,arguments);var d=this.getDataType();if(d){q.sap.require("sap.ui.mdc.FieldDataTypes");var a=sap.ui.mdc.FieldDataTypes;a.enrichFieldHelp(this,d);}return this;};F.prototype.setSelectedItem=function(v,t,p,b){var r=b.getContext().getObject();if(this.getRows().indexOf(r)===this._iSelectedIndex){return true;}return false;};F.prototype.getSelectedItem=function(v,t,p,b){var r=b.getContext().getObject();for(var i=0;i<r.cells.length;i++){if(v){this.setCurrentValue(r.cells[i].text);}}return v;};F.prototype.setCurrentValue=function(v){if(this._checkCurrentValue){this._checkCurrentValue(v);}this.setProperty("currentValue",v,true);if(this.getLiveChanging()&&this.hasListeners("liveChange")&&v!==this.getValue()){this.fireLiveChange({value:v});}if(this.getCloseOnSelect()){this._iSelectedIndex=undefined;this._fireSelectValue();}};F.prototype.selectClose=function(){this.select();this.close();};F.prototype.selectionChange=function(e){};F.prototype.select=function(){var v=this.getCurrentValue();if(this.getValue()!==v){this.setValue(v);this.fireSelect({value:v});}};F.prototype._fireSelectValue=function(){this.select();if(this.getCloseOnSelect()){this.close();}};F.prototype.isOpen=function(){return this._oPopover.isOpen();};F.prototype._activateManagedObjectModel=function(){if(this._oPopover){if(!this._oPopover.getModel("$fieldHelp")){this._oManagedObjectModel=new M(this);this._oPopover.setModel(this._oManagedObjectModel,"$fieldHelp");this._oPopover.bindElement("$fieldHelp>/");}var t=this;this._oManagedObjectModel.bindProperty("/currentValue").attachChange(function(e){t.setCurrentValue(e.getSource().getExternalValue());});this.setCurrentValue(this.getValue());}};F.prototype._deactivateManagedObjectModel=function(){if(this._oPopover){this._oPopover.setModel(null,"$fieldHelp");}};F.prototype.close=function(){if(this._oPopover){this._oPopover.close();}};F.prototype.open=function(c,s){if(!this._oPopover){this._oPopover=new sap.m.ResponsivePopover();this._oPopover.addStyleClass("sapUiMdcCompFieldHelp");}this._oOpener=c;var w=this.getWidth(),d;if(w==="auto"&&(d=c.getDomRef())){w=Math.max(200,Math.min(d.offsetWidth-25,300))+"px";}if(!this._mPopoverSettings){this._mPopoverSettings={placement:"VerticalPreferredBottom",showArrow:false,showHeader:false,content:this.getContent(),contentWidth:w,contentHeight:this.getHeight(),verticalScrolling:this.getVerticalScrolling(),horizontalScrolling:this.getWidth()!=="auto",initialFocus:!this.getFocusOnOpen()?this._oOpener.getId():""};}if(!this.getFocusOnOpen()){this._oOpener.addDelegate(this,true);}if(this.getWidth()==="auto"){var t=this;this._oPopover.attachAfterOpen(function(){var d=t._oPopover.getContent()[0].getDomRef();var W=d.scrollWidth;t._oPopover.setContentWidth(W+"px");});}this._oPopover.applySettings(this._mPopoverSettings);this._activateManagedObjectModel();q.sap.delayedCall(0,this._oPopover,"openBy",[c]);this._oPopover.attachAfterClose(this._closePopover,this);if(this._extendOpen){this._extendOpen();}};F.prototype._closePopover=function(){this._oPopover.detachAfterClose(this._closePopover,this);this._deactivateManagedObjectModel();this.fireClose();F.returnInstance(this);};return F;},true);
