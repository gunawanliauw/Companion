/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/model/json/JSONModel','sap/ui/model/Filter','sap/ui/mdc/FilterOperatorConfig'],function(q,J,F,b){"use strict";var C=J.extend("sap.ui.mdc.ConditionModel",{constructor:function(){J.apply(this,arguments);this._oMessageBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");sap.ui.getCore().attachLocalizationChanged(function(){this._oMessageBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");}.bind(this));if(!this.getProperty("/conditions")){this.setProperty("/conditions",[]);}if(!this.getProperty("/fieldPath")){this.setProperty("/fieldPath",{});}}});C._mModels={};C.prototype.destroy=function(){J.prototype.destroy.apply(this,arguments);delete this._mFieldPath;delete this._oMessageBundle;};C.getFor=function(l,n){var k=l.getModel().getId()+"--"+l.getPath()+"#"+(n===undefined?"":n);var c=C._mModels[k];if(!c){c=new C();c._oListBinding=l;C._mModels[k]=c;}else if(c._oListBinding!==l){c._oListBinding=l;}return c;};C.destroyCM=function(c,n){var l=c._oListBinding;var k=l.getModel().getId()+"--"+l.getPath()+"#"+(n===undefined?"":n);delete C._mModels[k];c.destroy();};C._getAll=function(l){var o=[];var k=l.getModel().getId()+"--"+l.getPath();for(var m in C._mModels){if(m.indexOf(k)===0){var c=C._mModels[m];o.push(c);}}return o;};C._getAllKeys=function(l){var o=[];var k=l.getModel().getId()+"--"+l.getPath();for(var m in C._mModels){if(m.indexOf(k)===0){o.push(m);}}return o;};C.prototype.getConditions=function(f){var r=[];var c=this.getProperty("/conditions");c.forEach(function(p){if(!f||p.fieldPath===f){r.push(p);}});return r;};C.prototype.addCondition=function(f,o,v){var n;if(typeof f==="string"){n={fieldPath:f,operator:o,values:v};}else{n=f;f=n.fieldPath;}var c=this.getProperty("/conditions");c.push(n);this.checkUpdate(true,true);this._checkMaxConditions(f);};C.prototype.removeCondition=function(f,i){var c=this.getProperty("/conditions");if(c.some(function(p,a,c){if(p.fieldPath===f){if(i===0){c.splice(a,1);return true;}i--;return false;}return false;})){this.checkUpdate(true,true);this._checkMaxConditions(f);}};C.prototype.removeAllConditions=function(f){var I=[];var c=this.getProperty("/conditions");c.forEach(function(p,i){if(!f||p.fieldPath===f){I.push(i);}});I.sort();for(var i=I.length-1;i>-1;i--){c.splice(I[i],1);}this.checkUpdate(true,true);};C.prototype.deleteConditions=function(c,B){var f;if(!c||!B){return;}if(!q.isArray(c)){c=[c];}var d=B.oModel.getProperty(B.getPath(),B.getContext())||[];if(q.isArray(c)&&d.length>0){var I=[],a,i,n;if(Array.isArray(d)){for(i=0;i<c.length;i++){I.push(d.indexOf(c[i].getProperty()));}I.sort();a=function(e){f=d[e].fieldPath;d.splice(parseInt(e,10),1);};}else if(typeof oData==="object"){for(n in d){var s=c[i].getPath();s=s.substring(c[i].getPath().lastIndexOf("/")+1);I.push(n);}a=function(s){delete d[s];};}for(i=I.length-1;i>-1;i--){a(I[i]);}}B.getModel().checkUpdate(true,true);this._checkMaxConditions(f);};C.prototype._checkRequiredConditions=function(f){var a=f?[f]:Object.keys(this._mFieldPath||{});var e=false;a.forEach(function(f){if(this._mFieldPath&&this._mFieldPath[f]){var o=this._mFieldPath[f];var m=this._oMessageBundle.getText("conditionmodel.REQUIRED_CONDITION_MISSING");if(o.getRequired()&&this.getConditions(f).length<=0){this.addFieldPathMessage(f,m);e=true;}else{this.removeFieldPathMessage(f,m);}}},this);return!e;};C.prototype._checkMaxConditions=function(f){var a=f?[f]:Object.keys(this._mFieldPath||{});var e=false;a.forEach(function(f){if(this._mFieldPath&&this._mFieldPath[f]){var o=this._mFieldPath[f];var m=this._oMessageBundle.getText("conditionmodel.TOO_MANY_CONDITIONS");if(o.getMaxConditions()>=0&&this.getConditions(f).length>o.getMaxConditions()){this.addFieldPathMessage(f,m);e=true;}else{this.removeFieldPathMessage(f,m);}}},this);return!e;};C.prototype.addFilterField=function(f){var s=f.getFieldPath();if(!this._mFieldPath){this._mFieldPath={};}this._mFieldPath[s]=f;var o=this.getProperty("/fieldPath");if(!o[s]){o[s]={valueState:"None",valueStateText:"",messages:[]};}};C.prototype.removeFilterField=function(f){var s=f.getFieldPath();if(this._mFieldPath&&this._mFieldPath[s]){delete this._mFieldPath[s];}var o=this.getProperty("/fieldPath");if(o[s]){delete o[s];}};C.prototype._getFieldPathProperty=function(f){return this.getProperty("/fieldPath/")[f];};C.prototype.addFieldPathMessage=function(f,m){var o=this._getFieldPathProperty(f);if(!o.messages.some(function(I,i){if(I===m){return true;}return false;})){o.messages.push(m);}this._updateValueState(f);};C.prototype.setUIMessage=function(f,m){var o=this._getFieldPathProperty(f);o.uiMessage=m;this._updateValueState(f);};C.prototype.removeFieldPathMessage=function(f,m){var I;var o=this._getFieldPathProperty(f);if(o.messages.some(function(s,i){if(s===m){I=i;return true;}return false;})){o.messages.splice(I,1);}this._updateValueState(f);};C.prototype.removeUIMessage=function(f){var o=this._getFieldPathProperty(f);delete o.uiMessage;this._updateValueState(f);};C.prototype._updateValueState=function(f){var u=false,o=this._getFieldPathProperty(f),v="None",V="";if(o.uiMessage){v="Error";V=o.uiMessage;}else if(o.messages.length>0){v="Error";V=o.messages[o.messages.length-1];}if(o.valueState!==v){o.valueState=v;u=true;}if(o.valueStateText!==V){o.valueStateText=V;u=true;}if(u){this.checkUpdate(true,true);}};C.prototype.applyFilters=function(){var f=this.getAllFilters();if(this._checkRequiredConditions()){if(f){this._oListBinding.filter(f);}else{this._oListBinding.filter();}}return this;};C.prototype.getAllFilters=function(){var o=C._getAll(this._oListBinding);var O=[];o.forEach(function(c){var f=c.getFilters();if(f){O.push(f);}});var f=null;if(O.length===1){f=O[0];}else if(O.length>1){f=new F({filters:O,and:true});}return f;};C.prototype.getFilterOperatorConfig=function(){var m=this._oListBinding&&this._oListBinding.getModel();return b.getFor(m);};C.prototype.getFilters=function(){var i,l,o=[],t,s,n,p;var f=this.getFilterOperatorConfig();var a={};var c=this.getProperty("/conditions")||[];for(i=0;i<c.length;i++){a[c[i].fieldPath]=true;}for(var d in a){l=[];t=null;for(i=0;i<c.length;i++){if(c[i].fieldPath===d){var O=f.getOperator(c[i].operator);var e=O.getModelFilter(c[i]);if(e.sPath.indexOf('*/')>-1){s=e.sPath.split('*/');if(s.length===2){n=s[0];p=s[1];e.sPath='L1/'+p;if(!t){t={path:n,operator:'Any',variable:'L1'};}l.push(e);}else{throw new Error("Not Implemented");}}else{l.push(e);}}}if(t){if(l.length===1){t.condition=l[0];}else if(l.length>1){t.condition=new F({filters:l,and:false});}l=[new F(t)];}if(l.length===1){o.push(l[0]);}else if(l.length>1){o.push(new F({filters:l,and:false}));}}if(o.length===1){return o[0];}else if(o.length>1){return new F({filters:o,and:true});}else{return null;}};C.prototype.serialize=function(){return'{"conditions":'+JSON.stringify(this.getData().conditions)+"}";};C.prototype.parse=function(o){var d=function(k,v){var a;if(!isNaN(parseInt(k,10))&&(typeof v==='string')){a=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}).(\d{3})Z$/.exec(v);if(a){return new Date(v);}}return v;};var r=this.getData();r.conditions=JSON.parse(o,d).conditions;this.setData(r);};C.serialize=function(l){var o=C._getAllKeys(l);var r="";o.forEach(function(c){var a=C._mModels[c];if(a.getData().conditions&&a.getData().conditions.length>0){r+=">>>"+c+"<<<";r+=a.serialize();}});return r;};C.parse=function(o){var c=o.split(">>>");c.forEach(function(s){var p=s.split("<<<");if(p.length>1){if(C._mModels[p[0]]){C._mModels[p[0]].parse(p[1]);}else{var a=new C();a.parse(p[1]);C._mModels[p[0]]=a;}}});};return C;},true);
