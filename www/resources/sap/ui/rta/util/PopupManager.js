/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','sap/m/Dialog','sap/m/Popover','sap/m/InstanceManager','sap/ui/core/Popup','sap/ui/dt/OverlayRegistry','sap/ui/fl/Utils','sap/ui/core/Component'],function(q,M,D,P,I,a,O,U,C){"use strict";var b=M.extend("sap.ui.rta.util.PopupManager",{metadata:{properties:{rta:"any"},events:{open:{parameters:{oControl:{type:"sap.ui.core.Control"}}},close:{parameters:{oControl:{type:"sap.ui.core.Control"}}}},library:"sap.ui.rta"}});b.prototype._overrideInstanceFunctions=function(){this._applyPopupMethods(this._createPopupOverlays);this._overrideAddPopupInstance();this._overrideRemovePopupInstance();};b.prototype.getRelevantPopups=function(){var o,c;o=c=[];o=I.getOpenDialogs();c=I.getOpenPopovers();var r={aDialogs:this._getValidatedPopups(o),aPopovers:this._getValidatedPopups(c)};return r;};b.prototype._getValidatedPopups=function(o){if(o.length>0){o.forEach(function(p,i){if(!this._getSupportedPopup(p)||(this.oRtaRootAppComponent!==this._getAppComponentForControl(p)&&!this._getComponentInsidePopup(p))){o.splice(i,1);}}.bind(this));}return(o.length>0)?o:false;};b.prototype._getComponentInsidePopup=function(p){return p.getContent().some(function(c){if(c.getMetadata().getName()==="sap.ui.core.ComponentContainer"){return this.oRtaRootAppComponent===this._getAppComponentForControl(sap.ui.getCore().getComponent(c.getComponent()));}}.bind(this));};b.prototype._getSupportedPopup=function(p){return(p instanceof sap.m.Dialog||p instanceof sap.m.Popover);};b.prototype.setRta=function(r){if(r&&r._oDesignTime){this.setProperty("rta",r);var R=sap.ui.getCore().byId(r.getRootControl());this.oRtaRootAppComponent=this._getAppComponentForControl(R);this._overrideInstanceFunctions();}};b.prototype._overrideAddPopupInstance=function(){this._fnOriginalAddDialogInstance=I.addDialogInstance;I.addDialogInstance=this._overrideAddFunctions(this._fnOriginalAddDialogInstance);this._fnOriginalAddPopoverInstance=I.addPopoverInstance;I.addPopoverInstance=this._overrideAddFunctions(this._fnOriginalAddPopoverInstance);};b.prototype._overrideAddFunctions=function(o){var t=this;return function(p){var v=o.apply(this,arguments);if(t.getRta()._oDesignTime&&t.oRtaRootAppComponent===t._getAppComponentForControl(p)&&t._getSupportedPopup(p)){p.attachAfterOpen(t._createPopupOverlays,t);t.fireOpen(p);}return v;};};b.prototype._applyPopupMethods=function(p){var r=this.getRelevantPopups();Object.keys(r).forEach(function(k){if(r[k]){r[k].forEach(function(o){p.call(this,o);}.bind(this));}}.bind(this));};b.prototype.modifyBrowserEvents=function(p){var o=p.oPopup;this.fnPopupOriginalAfterRendering=o.onAfterRendering;var t=this;o.onAfterRendering=function(){var v=t.fnPopupOriginalAfterRendering.apply(this,arguments);t._removeDefaultBlurEvents.call(this);return v;};this._removeDefaultBlurEvents.call(o);o._bOriginalAutoClose=o.getAutoClose();this.fnBlurHandling=this._blurHandling.bind(p,this.getRta());if(p instanceof sap.m.Popover){o.oContent.getDomRef().addEventListener("blur",this.fnBlurHandling,true);}};b.prototype._removeDefaultBlurEvents=function(){this.oContent.getDomRef().removeEventListener("blur",this.fEventHandler,true);this.oLastBlurredElement=new sap.ui.core.Control();};b.prototype._blurHandling=function(r,e){this.oPopup.setAutoClose(false);if(r.getMode()==='adaptation'){return;}q.sap.delayedCall(0,this,function(){if(document.activeElement&&q.sap.containsOrEquals(r._oToolsMenu.getDomRef(),document.activeElement)){q.sap.focus(this.oPopup.oContent);return;}if(q.sap.containsOrEquals(this.oPopup.oContent.getDomRef(),document.activeElement)){return;}this.oPopup.close(0,"autocloseBlur");});};b.prototype._overrideRemovePopupInstance=function(){this._fnOriginalRemoveDialogInstance=I.removeDialogInstance;I.removeDialogInstance=this._overrideRemoveFunctions(this._fnOriginalRemoveDialogInstance);this._fnOriginalRemovePopoverInstance=I.removePopoverInstance;I.removePopoverInstance=this._overrideRemoveFunctions(this._fnOriginalRemovePopoverInstance);};b.prototype._overrideRemoveFunctions=function(o){var t=this;return function(p){var v=o.apply(this,arguments);if(t.getRta()._oDesignTime&&t.oRtaRootAppComponent===t._getAppComponentForControl(p)&&t._getSupportedPopup(p)){t.getRta()._oDesignTime.removeRootElement(p);t.fireClose(p);}return v;};};b.prototype._getAppComponentForControl=function(c){var o,A;if(c instanceof sap.ui.core.Component){o=c;}else{o=this._getComponentForControl(c);}if(o){A=U.getAppComponentForControl(o);}return A;};b.prototype._getComponentForControl=function(c){var o,i=0;do{i++;o=C.getOwnerComponentFor(c);if(o){return o;}if(c&&typeof c.getParent==="function"){c=c.getParent();}else{return;}}while(c&&i<100&&!(c instanceof sap.ui.core.UIArea));return o;};b.prototype._createPopupOverlays=function(e){if(!e){return;}var p=(e instanceof sap.ui.core.Control)?e:e.getSource();if(this.getRta()._oDesignTime.getRootElements().indexOf(p.getId())===-1&&!this._getComponentInsidePopup(p)){this.getRta()._oDesignTime.addRootElement(p);}p.detachAfterOpen(this._createPopupOverlays,this);this.modifyBrowserEvents(p);};b.prototype._restoreInstanceFunctions=function(){if(this._fnOriginalAddDialogInstance){I.addDialogInstance=this._fnOriginalAddDialogInstance;}if(this._fnOriginalRemoveDialogInstance){I.removeDialogInstance=this._fnOriginalRemoveDialogInstance;}if(this._fnOriginalAddPopoverInstance){I.addPopoverInstance=this._fnOriginalAddPopoverInstance;}if(this._fnOriginalRemovePopoverInstance){I.removePopoverInstance=this._fnOriginalRemovePopoverInstance;}this._applyPopupMethods(this._disablePopupSettings);};b.prototype._disablePopupSettings=function(p){var o=p.oPopup;var v=o.oContent.getDomRef();if(this.fnPopupOriginalAfterRendering){o.onAfterRendering=this.fnPopupOriginalAfterRendering;}v.removeEventListener("blur",this.fnBlurHandling,true);if(typeof o._bOriginalAutoClose==="boolean"){o.setAutoClose(o._bOriginalAutoClose);delete o._bOriginalAutoClose;}v.addEventListener("blur",o.fEventHandler,true);o.oLastBlurredElement=undefined;q.sap.focus(o.oContent);};b.prototype.exit=function(){this._restoreInstanceFunctions();};return b;},true);
