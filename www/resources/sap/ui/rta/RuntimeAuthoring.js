/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","sap/ui/rta/toolbar/Fiori","sap/ui/rta/toolbar/Standalone","sap/ui/rta/toolbar/Personalization","sap/ui/dt/ElementUtil","sap/ui/dt/DesignTime","sap/ui/dt/OverlayRegistry","sap/ui/dt/Overlay","sap/ui/rta/command/Stack","sap/ui/rta/command/CommandFactory","sap/ui/rta/command/LREPSerializer","sap/ui/rta/plugin/Rename","sap/ui/rta/plugin/DragDrop","sap/ui/rta/plugin/RTAElementMover","sap/ui/rta/plugin/CutPaste","sap/ui/rta/plugin/Remove","sap/ui/rta/plugin/CreateContainer","sap/ui/rta/plugin/additionalElements/AdditionalElementsPlugin","sap/ui/rta/plugin/additionalElements/AddElementsDialog","sap/ui/rta/plugin/additionalElements/AdditionalElementsAnalyzer","sap/ui/rta/plugin/Combine","sap/ui/rta/plugin/Split","sap/ui/rta/plugin/Selection","sap/ui/rta/plugin/Settings","sap/ui/dt/plugin/ContextMenu","sap/ui/dt/plugin/TabHandling","sap/ui/fl/FlexControllerFactory","sap/ui/rta/ui/SettingsDialog","./Utils","sap/ui/fl/transport/Transports","sap/ui/fl/transport/TransportSelection","sap/ui/fl/Utils","sap/ui/fl/registry/Settings","sap/m/MessageBox","sap/m/MessageToast","sap/ui/rta/util/PopupManager","sap/ui/core/BusyIndicator","sap/ui/dt/DOMUtil","sap/ui/rta/util/StylesLoader"],function(q,M,F,S,P,E,D,O,a,C,b,L,R,c,d,e,f,g,A,h,i,j,k,l,m,n,T,o,p,U,r,s,t,u,v,w,x,B,y,z){"use strict";var G="sap-ui-fl-max-layer";var H=M.extend("sap.ui.rta.RuntimeAuthoring",{metadata:{library:"sap.ui.rta",associations:{"rootControl":{type:"sap.ui.core.Control"}},properties:{"customFieldUrl":"string","showCreateCustomField":"boolean","showToolbars":{type:"boolean",defaultValue:true},"triggeredFromDialog":{type:"boolean",defaultValue:false},"showSettingsDialog":{type:"boolean",defaultValue:true},"showWindowUnloadDialog":{type:"boolean",defaultValue:true},"commandStack":{type:"any"},"plugins":{type:"any",defaultValue:{}},"flexSettings":{type:"object"},"mode":{type:"string",defaultValue:"adaptation"}},events:{"start":{parameters:{editablePluginsCount:{type:"int"}}},"stop":{},"failed":{},"selectionChange":{parameters:{selection:{type:"sap.ui.dt.Overlay[]"}}},"undoRedoStackModified":{}}},_sAppTitle:null});H.prototype.getDefaultPlugins=function(){if(!this._mDefaultPlugins){var b1=new b({flexSettings:this.getFlexSettings()});this._mDefaultPlugins={};this._mDefaultPlugins["selection"]=new l({commandFactory:b1,multiSelectionRequiredPlugins:[j.getMetadata().getName(),f.getMetadata().getName()],elementEditableChange:this._onElementEditableChange.bind(this)});var c1=new d({commandFactory:b1});this._mDefaultPlugins["dragDrop"]=new c({elementMover:c1,commandFactory:b1,dragStarted:this._handleStopCutPaste.bind(this)});this._mDefaultPlugins["cutPaste"]=new e({elementMover:c1,commandFactory:b1});this._mDefaultPlugins["remove"]=new f({commandFactory:b1});this._mDefaultPlugins["additionalElements"]=new A({commandFactory:b1,analyzer:i,dialog:new h()});this._mDefaultPlugins["rename"]=new R({commandFactory:b1,editable:this._handleStopCutPaste.bind(this)});this._mDefaultPlugins["settings"]=new m({commandFactory:b1});this._mDefaultPlugins["createContainer"]=new g({commandFactory:b1});this._mDefaultPlugins["combine"]=new j({commandFactory:b1});this._mDefaultPlugins["split"]=new k({commandFactory:b1});this._mDefaultPlugins["contextMenu"]=new n();this._mDefaultPlugins["tabHandling"]=new T();}return q.extend({},this._mDefaultPlugins);};H.prototype._destroyDefaultPlugins=function(b1){for(var c1 in this._mDefaultPlugins){var d1=this._mDefaultPlugins[c1];if(d1&&!d1.bIsDestroyed){if(!b1||b1[c1]!==d1){d1.destroy();}}}if(!b1){this._mDefaultPlugins=null;}};H.prototype.init=function(){this._onCommandStackModified=this._onStackModified.bind(this);this.iEditableOverlaysCount=0;this.setFlexSettings({layer:"CUSTOMER",developerMode:true});this.oPopupManage=new x({open:this.onPopupOpen.bind(this),close:this.onPopupClose.bind(this)});};H.prototype.onPopupOpen=function(b1){if(b1.getParameters()instanceof sap.m.Dialog&&this._oToolsMenu instanceof F){this._oToolsMenu.setColor("contrast");}this._oToolsMenu.bringToFront();};H.prototype.onPopupClose=function(b1){if(b1.getParameters()instanceof sap.m.Dialog){this._oToolsMenu.setColor();}};H.prototype.setPlugins=function(b1){if(this._oDesignTime){throw new Error('Cannot replace plugins: runtime authoring already started');}this.setProperty("plugins",b1);};H.prototype.setFlexSettings=function(b1){var c1=q.sap.getUriParameters();var d1=c1.mParams["sap-ui-layer"];if(d1&&d1.length>0){b1.layer=d1[0];}this.setProperty("flexSettings",q.extend(this.getFlexSettings(),b1));};H.prototype.getLayer=function(b1){return this.getFlexSettings().layer;};H.prototype._getFlexController=function(){var b1=this._oRootControl||sap.ui.getCore().byId(this.getRootControl());return o.createForControl(b1);};H.prototype._getTextResources=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");};H.prototype.start=function(){if(!this._oDesignTime){this._oRootControl=sap.ui.getCore().byId(this.getRootControl());return this._handlePersonalizationChangesOnStart().then(function(b1){if(!b1){if(!this.getPlugins()||!Object.keys(this.getPlugins()).length){this.setPlugins(this.getDefaultPlugins());}this._destroyDefaultPlugins(this.getPlugins());Object.keys(this.getPlugins()).forEach(function(e1){if(this.getPlugins()[e1].attachElementModified){this.getPlugins()[e1].attachElementModified(this._handleElementModified,this);}}.bind(this));if(this.getPlugins()["settings"]){this.getPlugins()["settings"].setCommandStack(this.getCommandStack());}this._buildContextMenu();var c1=Object.keys(this.getPlugins());var d1=c1.map(function(e1){return this.getPlugins()[e1];},this);q.sap.measure.start("rta.dt.startup","Measurement of RTA: DesignTime start up");this._oDesignTime=new D({rootElements:[this._oRootControl],plugins:d1});q(a.getOverlayContainer()).addClass("sapUiRta");if(this.getLayer()==="USER"){q(a.getOverlayContainer()).addClass("sapUiRtaPersonalize");}this._oDesignTime.attachSelectionChange(function(e1){this.fireSelectionChange({selection:e1.getParameter("selection")});},this);this._oDesignTime.attachEventOnce("synced",function(){this.fireStart({editablePluginsCount:this.iEditableOverlaysCount});q.sap.measure.end("rta.dt.startup","Measurement of RTA: DesignTime start up");},this);this._oDesignTime.attachEventOnce("syncFailed",function(){this.fireFailed();},this);this._$document=q(document);this.fnKeyDown=this._onKeyDown.bind(this);this._$document.on("keydown",this.fnKeyDown);this.oPopupManage.setRta(this);this._oldUnloadHandler=window.onbeforeunload;window.onbeforeunload=this._onUnload.bind(this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);}return Promise.resolve(b1);}.bind(this)).then(function(b1){if(this.getShowToolbars()&&!b1){return u.getInstance(t.getComponentClassName(this._oRootControl)).then(function(c1){return!c1.isProductiveSystem()&&!c1.hasMergeErrorOccured();}).catch(function(c1){return false;}).then(function(c1){this._createToolsMenu(c1);return this._oToolsMenu.show();}.bind(this));}}.bind(this)).then(function(){var b1=this.oPopupManage.getRelevantPopups();if(b1.aDialogs||b1.aPopovers){return this._oToolsMenu.bringToFront();}return true;}.bind(this)).then(function(){z.loadStyles('InPageStyles').then(function(b1){var c1=b1.replace(/%scrollWidth%/g,y.getScrollbarWidth()+'px');y.insertStyles(c1);});return true;});}};var I=function(b1){var c1=b1.stack||b1.message||b1.status||b1;var d1=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");q.sap.log.error("Failed to transfer runtime adaptation changes to layered repository",c1);var e1=d1.getText("MSG_LREP_TRANSFER_ERROR")+"\n"+d1.getText("MSG_ERROR_REASON",c1);v.error(e1);};H.prototype._onAppClosed=function(){this.stop(true,true);};H.prototype.setCommandStack=function(b1){var c1=this.getProperty("commandStack");if(c1){c1.detachModified(this._onCommandStackModified);}if(this._oInternalCommandStack){this._oInternalCommandStack.destroy();delete this._oInternalCommandStack;}var d1=this.setProperty("commandStack",b1);if(b1){b1.attachModified(this._onCommandStackModified);}if(this.getPlugins()&&this.getPlugins()["settings"]){this.getPlugins()["settings"].setCommandStack(b1);}return d1;};H.prototype.getCommandStack=function(){var b1=this.getProperty("commandStack");if(!b1){b1=new C();this._oInternalCommandStack=b1;this.setCommandStack(b1);}return b1;};H.prototype._onStackModified=function(){var b1=this.getCommandStack();var c1=b1.canUndo();var d1=b1.canRedo();var e1=U.getUshellContainer();if(this.getShowToolbars()&&this._oToolsMenu){this._oToolsMenu.setUndoRedoEnabled(c1,d1);this._oToolsMenu.setPublishEnabled(this._bChangesExist||c1);this._oToolsMenu.setRestoreEnabled(this._bChangesExist||c1);}this.fireUndoRedoStackModified();if(e1){if(c1){e1.setDirtyFlag(true);}else{e1.setDirtyFlag(false);}}};H.prototype._closeToolBars=function(){if(this.getShowToolbars()&&this._oToolsMenu){return this._oToolsMenu.hide();}else{return Promise.resolve();}};H.prototype.getSelection=function(){if(this._oDesignTime){return this._oDesignTime.getSelection();}else{return[];}};H.prototype.stop=function(b1,c1){return((b1)?Promise.resolve():this._serializeToLrep()).then(this._closeToolBars.bind(this)).then(c1?Promise.resolve():this._handlePersonalizationChangesOnExit.bind(this)).then(function(){this.exit();this.fireStop();}.bind(this))['catch'](I);};H.prototype.restore=function(){this._onRestore();};H.prototype.transport=function(){this._onTransport();};H.prototype.undo=function(){this._onUndo();};H.prototype.redo=function(){this._onRedo();};H.prototype.canUndo=function(){return this.getCommandStack().canUndo();};H.prototype.canRedo=function(){return this.getCommandStack().canRedo();};H.prototype._onKeyDown=function(b1){var c1=sap.ui.Device.os.macintosh?b1.metaKey:b1.ctrlKey;if((b1.keyCode===q.sap.KeyCodes.Z)&&(b1.shiftKey===false)&&(b1.altKey===false)&&(c1===true)){this._onUndo();b1.stopPropagation();}else if((b1.keyCode===q.sap.KeyCodes.Y)&&(b1.shiftKey===false)&&(b1.altKey===false)&&(c1===true)){this._onRedo();b1.stopPropagation();}};H.prototype._onUnload=function(){var b1=this.getCommandStack();var c1=b1.canUndo()||b1.canRedo();if(c1&&this.getShowWindowUnloadDialog()){var d1=this._getTextResources().getText("MSG_UNSAVED_CHANGES");return d1;}else{window.onbeforeunload=this._oldUnloadHandler;}};H.prototype._serializeToLrep=function(){var b1=new L({commandStack:this.getCommandStack(),rootControl:this.getRootControl()});return b1.saveCommands();};H.prototype._onUndo=function(){this._handleStopCutPaste();this.getCommandStack().undo();};H.prototype._onRedo=function(){this._handleStopCutPaste();this.getCommandStack().redo();};H.prototype._createToolsMenu=function(b1){if(!this._oToolsMenu){var c1;if(this.getLayer()==="USER"){c1=P;}else if(U.getFiori2Renderer()){c1=F;}else{c1=S;}if(this.getLayer()==="USER"){this._oToolsMenu=new c1({textResources:this._getTextResources(),exit:this.stop.bind(this,false,false),restore:this._onRestore.bind(this)});}else{this._oToolsMenu=new c1({modeSwitcher:this.getMode(),publishVisible:b1,textResources:this._getTextResources(),exit:this.stop.bind(this,false,false),transport:this._onTransport.bind(this),restore:this._onRestore.bind(this),undo:this._onUndo.bind(this),redo:this._onRedo.bind(this),modeChange:this._onModeChange.bind(this)});}this._checkChangesExist().then(function(d1){this._bChangesExist=d1;this._oToolsMenu.setPublishEnabled(d1);this._oToolsMenu.setRestoreEnabled(d1);}.bind(this));}};H.prototype.exit=function(){if(this._oDesignTime){q(a.getOverlayContainer()).removeClass("sapUiRta");this._oDesignTime.destroy();this._oDesignTime=null;this._$document.off("keydown",this.fnKeyDown);this._destroyDefaultPlugins();this.setPlugins(null);}if(this._oToolsMenu){this._oToolsMenu.destroy();this._oToolsMenu=null;}this.setCommandStack(null);var b1=U.getUshellContainer();if(b1){b1.setDirtyFlag(false);}if(this.oPopupManage){this.oPopupManage.destroy();}window.onbeforeunload=this._oldUnloadHandler;sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);};H.prototype._onTransport=function(){var b1=function(c1){B.hide();if(c1.message!=='createAndApply failed'){t.log.error("transport error"+c1);return this._showMessage(v.Icon.ERROR,"HEADER_TRANSPORT_ERROR","MSG_TRANSPORT_ERROR",c1);}}.bind(this);this._handleStopCutPaste();return this._openSelection().then(this._checkTransportInfo).then(function(c1){if(c1){return this._serializeToLrep().then(function(){return this._getFlexController().getComponentChanges({currentLayer:this.getLayer()}).then(function(d1){if(d1.length>0){B.show(0);return this._createAndApplyChanges(d1).then(this._transportAllLocalChanges.bind(this,c1))['catch'](b1);}}.bind(this));}.bind(this))['catch'](I);}}.bind(this));};H.prototype._checkTransportInfo=function(b1){if(b1&&b1.transport&&b1.packageName!=="$TMP"){return b1;}else{return false;}};H.prototype._openSelection=function(){return new s().openTransportSelection(null,this._oRootControl);};H.prototype._createAndApplyChanges=function(b1){return Promise.resolve().then(function(){function c1(d1){return d1&&d1.selector&&d1.selector.id;}b1.filter(c1).forEach(function(d1){var e1=sap.ui.getCore().byId(d1.selector.id);this._getFlexController().createAndApplyChange(d1,e1);});})['catch'](function(c1){t.log.error("Create and apply error: "+c1);return c1;}).then(function(c1){return this._getFlexController().saveAll().then(function(){if(c1){throw c1;}});}.bind(this))['catch'](function(c1){t.log.error("Create and apply and/or save error: "+c1);return this._showMessage(v.Icon.ERROR,"HEADER_TRANSPORT_APPLYSAVE_ERROR","MSG_TRANSPORT_APPLYSAVE_ERROR",c1);}.bind(this));};H.prototype._deleteChanges=function(){var b1=new s();var c1=this.getLayer();this._getFlexController().getComponentChanges({currentLayer:c1}).then(function(d1){return u.getInstance(t.getComponentClassName(this._oRootControl)).then(function(e1){if(!e1.isProductiveSystem()&&!e1.hasMergeErrorOccured()){return b1.setTransports(d1,this._oRootControl);}}.bind(this)).then(function(){return this._getFlexController().discardChanges(d1,c1==="USER");}.bind(this)).then(function(){return window.location.reload();});}.bind(this))["catch"](function(d1){return this._showMessage(v.Icon.ERROR,"HEADER_RESTORE_FAILED","MSG_RESTORE_FAILED",d1);}.bind(this));};H.prototype._showMessage=function(b1,c1,d1,e1){var f1=this._getTextResources().getText(d1,e1?[e1.message||e1]:undefined);var g1=this._getTextResources().getText(c1);return new Promise(function(h1){v.show(f1,{icon:b1,title:g1,onClose:h1});});};H.prototype._showMessageToast=function(b1){var c1=this._getTextResources().getText(b1);w.show(c1);};H.needsRestart=function(b1){var c1=!!window.localStorage.getItem("sap.ui.rta.restart."+b1);return c1;};H.enableRestart=function(b1){window.localStorage.setItem("sap.ui.rta.restart."+b1,true);};H.disableRestart=function(b1){window.localStorage.removeItem("sap.ui.rta.restart."+b1);};H.prototype._onRestore=function(){var b1=this.getLayer()==="USER"?this._getTextResources().getText("FORM_PERS_RESET_MESSAGE_PERSONALIZATION"):this._getTextResources().getText("FORM_PERS_RESET_MESSAGE");var c1=this.getLayer()==="USER"?this._getTextResources().getText("BTN_RESTORE"):this._getTextResources().getText("FORM_PERS_RESET_TITLE");var d1=function(e1){if(e1==="OK"){this.getCommandStack().removeAllCommands();H.enableRestart(this.getLayer());this._deleteChanges();}}.bind(this);this._handleStopCutPaste();v.confirm(b1,{icon:v.Icon.WARNING,title:c1,onClose:d1});};H.prototype._transportAllLocalChanges=function(b1){return this._getFlexController().getComponentChanges({currentLayer:this.getLayer()}).then(function(c1){var d1=new r();var e1=d1._convertToChangeTransportData(c1);var f1={};f1.package=b1.packageName;f1.transportId=b1.transport;f1.changeIds=e1;return d1.makeChangesTransportable(f1).then(function(){c1.forEach(function(g1){if(g1.getPackage()==='$TMP'){var h1=g1.getDefinition();h1.packageName=b1.packageName;g1.setResponse(h1);}});}).then(function(){B.hide();this._showMessageToast("MSG_TRANSPORT_SUCCESS");}.bind(this));}.bind(this));};H.prototype._isEqualParentInfo=function(b1,c1){var d1=!!b1&&!!c1;if(d1&&(b1.parent&&c1.parent)){d1=b1.parent.getId()===c1.parent.getId();}if(d1&&(b1.index||c1.index)){d1=b1.index===c1.index;}if(d1&&(b1.aggregation||c1.aggregation)){d1=b1.aggregation===c1.aggregation;}return d1;};H.prototype._handleElementModified=function(b1){this._handleStopCutPaste();var c1=b1.getParameter("command");if(c1 instanceof sap.ui.rta.command.BaseCommand){this.getCommandStack().pushAndExecute(c1);}};H.prototype._onElementEditableChange=function(b1){var c1=b1.getParameter("editable");if(c1){this.iEditableOverlaysCount+=1;}else{this.iEditableOverlaysCount-=1;}};H.prototype._handleRemoveElement=function(b1){this.getPlugins()["remove"].removeElement(b1);};H.prototype._openSettingsDialog=function(b1){var c1=(b1.mParameters)?b1.getParameter("selectedOverlays"):b1;var d1=c1[0].getElementInstance();this._handleStopCutPaste();if(!this._oSettingsDialog){this._oSettingsDialog=new p();}this._oSettingsDialog.setCommandStack(this.getCommandStack());this._oSettingsDialog.open(d1);};var J=function(b1){return this._oDesignTime.getSelection().length<2;};var K=function(b1){return b1.getMovable();};var N=function(b1){return this.getPlugins()["remove"].isRemoveAvailable(b1);};var Q=function(b1){return this.getPlugins()["remove"].isRemoveEnabled(b1);};var V=function(b1){return this.getPlugins()["rename"].isRenameAvailable(b1);};var W=function(b1){return this.getPlugins()["rename"].isRenameEnabled(b1);};var X=function(b1){return this.getPlugins()["settings"].isSettingsAvailable(b1);};var Y=function(b1){return this.getPlugins()["settings"].isSettingsEnabled(b1);};var Z=function(b1){return this.getPlugins()["combine"].isCombineAvailable(b1);};var $=function(b1){return this.getPlugins()["combine"].isCombineEnabled(b1);};var _=function(b1){return this.getPlugins()["split"].isSplitAvailable(b1);};var a1=function(b1){return this.getPlugins()["split"].isSplitEnabled(b1);};H.prototype._buildContextMenu=function(){var b1=this.getPlugins()["contextMenu"];if(!b1){return;}var c1=this.getPlugins()["additionalElements"];var d1=this.getPlugins()["createContainer"];if(this.getPlugins()["rename"]){b1.addMenuItem({id:"CTX_RENAME_LABEL",text:this._getTextResources().getText("CTX_RENAME"),handler:this._handleRename.bind(this),available:V.bind(this),enabled:function(e1){return(J.call(this,e1)&&W.call(this,e1));}.bind(this)});}if(c1){b1.addMenuItem({id:"CTX_ADD_ELEMENTS_AS_SIBLING",text:c1.getContextMenuTitle.bind(c1,true),handler:c1.showAvailableElements.bind(c1,true),available:c1.isAvailable.bind(c1,true),enabled:function(e1){return J.call(this,e1)&&c1.isEnabled(true,e1);}.bind(this)});b1.addMenuItem({id:"CTX_ADD_ELEMENTS_AS_CHILD",text:c1.getContextMenuTitle.bind(c1,false),handler:c1.showAvailableElements.bind(c1,false),available:c1.isAvailable.bind(c1,false),enabled:function(e1){return J.call(this,e1)&&c1.isEnabled(false,e1);}.bind(this)});}if(d1){b1.addMenuItem({id:"CTX_CREATE_CHILD_CONTAINER",text:d1.getCreateContainerText.bind(d1,false),handler:this._createContainer.bind(this,false),available:d1.isCreateAvailable.bind(d1,false),enabled:d1.isCreateEnabled.bind(d1,false)});b1.addMenuItem({id:"CTX_CREATE_SIBLING_CONTAINER",text:d1.getCreateContainerText.bind(d1,true),handler:this._createContainer.bind(this,true),available:d1.isCreateAvailable.bind(d1,true),enabled:d1.isCreateEnabled.bind(d1,true)});}if(this.getPlugins()["remove"]){b1.addMenuItem({id:"CTX_REMOVE",text:this._getTextResources().getText("CTX_REMOVE"),handler:this._handleRemoveElement.bind(this),available:N.bind(this),enabled:Q.bind(this)});}b1.addMenuItem({id:"CTX_CUT",text:this._getTextResources().getText("CTX_CUT"),handler:this._handleCutElement.bind(this),available:K,enabled:function(){return this._oDesignTime.getSelection().length===1;}.bind(this)});if(this.getPlugins()["cutPaste"]){b1.addMenuItem({id:"CTX_PASTE",text:this._getTextResources().getText("CTX_PASTE"),handler:this._handlePasteElement.bind(this),available:K,enabled:function(e1){return this.getPlugins()["cutPaste"].isElementPasteable(e1);}.bind(this)});}b1.addMenuItem({id:"CTX_GROUP_FIELDS",text:this._getTextResources().getText("CTX_GROUP_FIELDS"),handler:this._handleCombineElements.bind(this),available:Z.bind(this),enabled:$.bind(this)});b1.addMenuItem({id:"CTX_UNGROUP_FIELDS",text:this._getTextResources().getText("CTX_UNGROUP_FIELDS"),handler:this._handleSplitElements.bind(this),available:_.bind(this),enabled:a1.bind(this)});if(this.getPlugins()["settings"]){b1.addMenuItem({id:"CTX_SETTINGS",text:this._getTextResources().getText("CTX_SETTINGS"),handler:this._handleSettings.bind(this),available:X.bind(this),enabled:Y.bind(this)});}};H.prototype._createContainer=function(b1,c1){this._handleStopCutPaste();var d1=c1[0];var e1=this.getPlugins()["createContainer"].handleCreate(b1,d1);if(this.getPlugins()["rename"]){var f1={"onAfterRendering":function(){setTimeout(function(){this.getPlugins()["rename"].startEdit(e1);}.bind(this),0);e1.removeEventDelegate(f1);}.bind(this)};e1.addEventDelegate(f1);}};H.prototype._handleRename=function(b1){var c1=b1[0];this.getPlugins()["rename"].startEdit(c1);};H.prototype._handleCutElement=function(b1){var c1=b1[0];this.getPlugins()["cutPaste"].cut(c1);};H.prototype._handlePasteElement=function(b1){var c1=b1[0];this.getPlugins()["cutPaste"].paste(c1);};H.prototype._handleStopCutPaste=function(){this.getPlugins()["cutPaste"].stopCutAndPaste();};H.prototype._handleCombineElements=function(){this._handleStopCutPaste();var b1=this.getPlugins()["contextMenu"].getContextElement();this.getPlugins()["combine"].handleCombine(b1);};H.prototype._handleSplitElements=function(){this._handleStopCutPaste();var b1=this.getPlugins()["contextMenu"].getContextElement();this.getPlugins()["split"].handleSplit(b1);};H.prototype._handleSettings=function(b1){this.getPlugins()["settings"].handleSettings(b1);};H.prototype._getSmartFormForElement=function(b1){while(b1&&!E.isInstanceOf(b1,"sap.ui.comp.smartform.SmartForm")){b1=b1.getParent();}return b1;};H.prototype._getApplicationTitle=function(){var b1="";var c1=sap.ui.core.Component.getOwnerComponentFor(this._oRootControl);if(c1){b1=c1.getMetadata().getManifestEntry("sap.app").title;}return b1;};H.prototype._checkChangesExist=function(){if(this._getFlexController().getComponentName().length>0){return this._getFlexController().getComponentChanges({currentLayer:this.getLayer()}).then(function(b1){return b1.length>0;});}else{return Promise.resolve(false);}};H.prototype._getURLParsedHash=function(){var b1=sap.ushell.Container.getService("URLParsing");if(b1.parseShellHash&&b1.getHash){return b1.parseShellHash(b1.getHash(window.location.href));}};H.prototype._buildNavigationArguments=function(b1){return{target:{semanticObject:b1.semanticObject,action:b1.action,context:b1.contextRaw},params:b1.params,appSpecificRoute:b1.appSpecificRoute};};H.prototype._hasCustomerLayerParameter=function(b1){return b1.params&&b1.params[G]&&b1.params[G][0]==="CUSTOMER";};H.prototype._reloadWithoutPersonalizationChanges=function(b1,c1){if(!this._hasCustomerLayerParameter(b1)){if(!b1.params){b1.params={};}b1.params[G]=["CUSTOMER"];H.enableRestart("CUSTOMER");c1.toExternal(this._buildNavigationArguments(b1));return Promise.resolve(true);}};H.prototype._reloadWithPersonalizationChanges=function(b1,c1){if(this._hasCustomerLayerParameter(b1)){delete b1.params[G];c1.toExternal(this._buildNavigationArguments(b1));return Promise.resolve(true);}};H.prototype._handlePersonalizationMessageBoxOnStart=function(){return this._showMessage(v.Icon.INFORMATION,"HEADER_PERSONALIZATION_EXISTS","MSG_PERSONALIZATION_EXISTS");};H.prototype._handlePersonalizationChangesOnStart=function(){var b1=U.getUshellContainer();if(b1&&this.getLayer()!=="USER"){var c1=this._getURLParsedHash();return this._getFlexController().isPersonalized({ignoreMaxLayerParameter:false}).then(function(d1){if(d1){return this._handlePersonalizationMessageBoxOnStart().then(function(){var e1=sap.ushell.Container.getService("CrossApplicationNavigation");if(e1.toExternal&&c1){return this._reloadWithoutPersonalizationChanges(c1,e1);}}.bind(this));}}.bind(this));}else{return Promise.resolve(false);}};H.prototype._handlePersonalizationMessageBoxOnExit=function(){return new Promise(function(b1){var c1=this._getTextResources().getText("MSG_LOAD_PERSONALIZATION_CHANGES");var d1=this._getTextResources().getText("HEADER_LOAD_PERSONALIZATION_CHANGES");var e1=this._getTextResources().getText("MSG_PERSONALIZATION_CONFIRM_BUTTON_TEXT");var f1=this._getTextResources().getText("MSG_PERSONALIZATION_CANCEL_BUTTON_TEXT");var g1=function(h1){if(h1===e1){return b1(true);}else if(h1===f1){return b1(false);}};v.confirm(c1,{icon:v.Icon.QUESTION,title:d1,actions:[e1,f1],onClose:g1});}.bind(this));};H.prototype._handlePersonalizationChangesOnExit=function(){var b1=U.getUshellContainer();sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);if(b1&&this.getLayer()!=="USER"){return this._getFlexController().isPersonalized({ignoreMaxLayerParameter:true}).then(function(c1){if(c1){return this._handlePersonalizationMessageBoxOnExit().then(function(d1){if(d1){var e1=sap.ushell.Container.getService("CrossApplicationNavigation");var f1=this._getURLParsedHash();if(e1.toExternal&&f1){return this._reloadWithPersonalizationChanges(f1,e1);}}}.bind(this));}}.bind(this));}else{return Promise.resolve(false);}};H.prototype._onModeChange=function(b1){this.setMode(b1.getParameter('key'));};H.prototype.setMode=function(b1){if(this.getProperty('mode')!==b1){var c1=this._oToolsMenu.getControl('modeSwitcher');var d1=b1==='adaptation';if(c1){c1.setSelectedButton(c1.getItems().filter(function(e1){return e1.getKey()===b1;}).pop().getId());}this._oDesignTime.setEnabled(d1);this.getPlugins()['tabHandling'][d1?'_removeTabIndex':'_restoreTabIndex']();this.setProperty('mode',b1);if(b1==='navigation'&&this.oPopupManage.getRelevantPopups().aPopovers){q.sap.focus(this.oPopupManage.getRelevantPopups().aPopovers[0].oPopup.oContent);}else if(b1==='navigation'&&this.oPopupManage.getRelevantPopups().aDialogs){q.sap.focus(this.oPopupManage.getRelevantPopups().aDialogs[0].oPopup.oContent);}}};return H;},true);
