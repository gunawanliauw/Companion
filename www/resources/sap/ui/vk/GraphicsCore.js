/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/base/EventProvider","./ve/thirdparty/html2canvas","./ve/dvl","./Scene","./NodeHierarchy","./ContentResource","./DownloadManager","./ViewStateManager","./DvlException","./Messages"],function(q,l,E,H,D,S,N,C,a,V,b,M){"use strict";var c=q.sap.log;function g(s){return s instanceof File?"local":"remote";}function d(s){return s instanceof File?s.name:s;}var e=function(s){Object.defineProperties(this,{source:{value:s,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}});};e.prototype.isInUse=function(){return this._refCount>0;};e.prototype.addRef=function(){++this._refCount;return this;};e.prototype.release=function(){--this._refCount;return this;};e.prototype.destroy=function(){};var f=function(s,v,i){e.call(this,s);Object.defineProperties(this,{content:{value:i,writable:false,enumerable:true},vdsSourceDatum:{value:v,writable:false,enumerable:true}});};f.prototype=Object.create(e.prototype);f.prototype.constructor=f;f.prototype.destroy=function(){if(this.vdsSourceDatum){this.vdsSourceDatum.release();}e.prototype.destroy.call(this);};var h=function(i,s,r){Object.defineProperties(this,{dvlSceneId:{value:i,writable:false,enumerable:true},sourceDatum:{value:s,writable:false,enumerable:true},root:{value:!!r,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}});};h.prototype.isInUse=function(){return this._refCount>0;};h.prototype.addRef=function(){++this._refCount;return this;};h.prototype.release=function(){--this._refCount;return this;};h.prototype.destroy=function(){if(this.sourceDatum){this.sourceDatum.release();}};var j=function(i,m){Object.defineProperties(this,{source:{value:i.getSource()},sourceType:{value:i.getSourceType()},sourceId:{value:i.getSourceId(),writable:true},name:{value:i.getName()},localMatrix:{value:i.getLocalMatrix(),writable:true},password:{value:i.getPassword()},children:{value:i.getContentResources().map(function(i){return new j(i);})},dvlSceneDatum:{value:null,writable:true},nodeProxy:{value:null,writable:true},fake:{value:!!m},sourceProperties:{value:null,writable:true}});i._shadowContentResource=this;};j.prototype.destroy=function(){if(this.dvlSceneDatum){this.dvlSceneDatum.release();}};var k=function(v,s){Object.defineProperties(this,{vkScene:{value:v},shadowContentResource:{value:s}});};var G=E.extend("sap.ui.vk.GraphicsCore",{metadata:{publicMethods:["buildSceneTree","createViewStateManager","destroyScene","destroyViewStateManager","getApi","loadContentResourcesAsync","showDebugInfo"]},constructor:function(r,w){E.apply(this);var s=q.extend({},r,{filePackagePrefixURL:q.sap.getResourcePath("sap/ve")+"/"});this._dvlClientId=q.sap.uid();this._dvl=sap.ve.dvl.createRuntime(s);this._dvl.CreateCoreInstance(this._dvlClientId);sap.ui.vk.dvl.checkResult(this._dvl.Core.Init(this._DVLMajorVersion,this._DVLMinorVersion));var u=sap.ui.getCore();u.attachLocalizationChanged(this._onlocalizationChanged,this);sap.ui.vk.dvl.checkResult(this._dvl.Core.SetLocale(u.getConfiguration().getLanguageTag()));this._canvas=this._createRenderingCanvasAndContext(w);this._rendererId=sap.ui.vk.dvl.getPointer(this._dvl.Core.CreateRenderer());this._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*window.devicePixelRatio,this._rendererId);this._sourceData=[];this._dvlSceneData=[];this._vkSceneData=[];this._viewports=[];this._renderLoopRequestId=null;this._renderLoopFunction=this._renderLoop.bind(this);this._viewStateManagers=[];},_DVLMajorVersion:7,_DVLMinorVersion:0});G.prototype.destroy=function(){sap.ui.getCore().detachLocalizationChanged(this._onlocalizationChanged,this);var v=this._viewports.slice();v.reverse();v.forEach(function(i){i.control.setGraphicsCore(null);});this._viewports=null;this._cleanupVkSceneData();this._vkSceneData=null;this._cleanupDvlSceneData();this._dvlSceneData=null;this._cleanupSourceData();this._sourceData=null;this._viewStateManagers.slice().forEach(this.destroyViewStateManager.bind(this));this._viewStateManagers=null;this._webGLContext=null;this._canvas=null;this._dvl.Core.DeleteRenderer(this._rendererId);this._rendererId=null;this._dvl.Core.Release();this._dvl=null;E.prototype.destroy.apply(this);};G.prototype._createRenderingCanvasAndContext=function(w){var i=document.createElement("canvas");i.id=q.sap.uid();this._webGLContext=this._dvl.Core.CreateWebGLContext(i,w);return i;};G.prototype._getCanvas=function(){return this._canvas;};G.prototype._getWebGLContext=function(){return this._webGLContext;};G.prototype._getDvl=function(){return this._dvl;};G.prototype._getDvlClientId=function(){return this._dvlClientId;};G.prototype._findSourceData=function(i){var m=Object.getOwnPropertyNames(i);return this._sourceData.filter(function(r){return m.every(function(s){return i[s]===r[s];});});};G.prototype._destroySourceDatum=function(s){if(!(s instanceof f)){this._dvl.Core.DeleteFileByUrl(d(s.source),g(s.source));}s.destroy();return this;};G.prototype._cleanupSourceData=function(){var m=false;for(var i=this._sourceData.length-1;i>=0;--i){var s=this._sourceData[i];if(!s.isInUse()){var r=s instanceof f?s.vdsSourceDatum:null;this._sourceData.splice(i,1);this._destroySourceDatum(s);if(r&&!r.isInUse()){m=true;}}}if(m){this._cleanupSourceData();}return this;};G.prototype._findDvlSceneData=function(i){var m=Object.getOwnPropertyNames(i);return this._dvlSceneData.filter(function(r){return m.every(function(s){return i[s]===r[s];});});};G.prototype._destroyDvlSceneDatum=function(i){this._dvl.Scene.Release(i.dvlSceneId);i.destroy();return this;};G.prototype._cleanupDvlSceneData=function(){for(var i=this._dvlSceneData.length-1;i>=0;--i){var m=this._dvlSceneData[i];if(!m.isInUse()){this._dvlSceneData.splice(i,1);this._destroyDvlSceneDatum(m);}}};G.prototype._findVkSceneData=function(i){var m=Object.getOwnPropertyNames(i);return this._vkSceneData.filter(function(r){return m.every(function(s){return i[s]===r[s];});});};G.prototype._cleanupVkSceneData=function(){for(var i=this._vkSceneData.length-1;i>=0;--i){this.destroyScene(this._vkSceneData[i].vkScene);}};G.prototype._destroyShadowContentResource=function(v,s){if(s.children){s.children.forEach(this._destroyShadowContentResource.bind(this,v));}if(s.nodeProxy){this._dvl.Scene.DeleteNode(v._getDvlSceneId(),s.nodeProxy.getNodeId());v.getDefaultNodeHierarchy().destroyNodeProxy(s.nodeProxy);}s.destroy();};G.prototype._filterContentResources=function(i,m){var r=[];i.forEach(function enumerate(s){if(m(s)){r.push(s);}s.getContentResources().forEach(enumerate);});return r;};G.prototype._getContentResourcesWithMissingPasswords=function(i){var l=this._dvl.Library;return this._filterContentResources(i,function(m){var s=m.getSource();return s&&(l.RetrieveInfo(d(s),g(s)).flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED)&&!m.getPassword();});};G.prototype._getContentResourcesWithEncryptedVds3=function(i){var l=this._dvl.Library;return this._filterContentResources(i,function(m){var s=m.getSource();if(s){var r=l.RetrieveInfo(d(s),g(s));return r.major<=3&&(r.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED);}else{return false;}});};G.prototype._collectSourceProperties=function(s){var i=this._dvl.Library.RetrieveInfo(d(s.source),g(s.source));s.sourceProperties={version:{major:i.major,minor:i.minor}};if(i.flags&(sap.ve.dvl.DVLFILEFLAG.PAGESCOMPRESSED|sap.ve.dvl.DVLFILEFLAG.WHOLEFILECOMPRESSED)){s.sourceProperties.compressed=true;}if(i.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED){s.sourceProperties.encrypted=true;}return this;};G.prototype.loadContentResourcesAsync=function(i,r,s){var t=this,u=[],v=new Map();i.forEach(function enumerate(m){var z=m.getSource();if(z&&u.indexOf(z)<0&&t._findSourceData({source:z}).length===0){u.push(z);if(m.getSourceType()==="vdsl"){v.set(z,{});}}m.getContentResources().forEach(enumerate);});var w=[];if(u.length>0){var x;var y=new a(u).attachItemSucceeded(function(z){var A=z.getParameter("source");var B=z.getParameter("response");if(v.has(A)){var F=sap.ui.vk.utf8ArrayBufferToString(B);if(F.trim().length===0){x=x||[];x.push({source:A,status:M.VIT22.code,statusText:sap.ui.vk.getResourceBundle().getText(M.VIT22.summary)});c.error(sap.ui.vk.getResourceBundle().getText(M.VIT22.summary),M.VIT22.code,"sap.ui.vk.GraphicsCore");return;}else{var I=F.split(/\n|\r\n/);var m=I[0].match(/^file=(.+)$/);if(!m){x=x||[];x.push({source:A,status:M.VIT23.code,statusText:sap.ui.vk.getResourceBundle().getText(M.VIT23.summary)});c.error(sap.ui.vk.getResourceBundle().getText(M.VIT23.summary),M.VIT23.code,"sap.ui.vk.GraphicsCore");return;}else{var J=v.get(A);J.content=I;var K=m[1];var L=K;var O=new URI(L);if(O.is("relative")){if(A instanceof File){x=x||[];x.push({source:A,status:M.VIT24.code,statusText:sap.ui.vk.getResourceBundle().getText(M.VIT24.summary)});c.error(sap.ui.vk.getResourceBundle().getText(M.VIT24.summary),M.VIT24.code,"sap.ui.vk.GraphicsCore");return;}else{var P=new URI(A);K=O.absoluteTo(P).href();}}J.referencedSource=K;J.content[0]=J.content[0].replace(L,this._dvl.Core.GetFilename(J.referencedSource,"remote"));if(u.indexOf(J.referencedSource)<0&&this._findSourceData({source:J.referencedSource}).length===0){u.push(J.referencedSource);y.queue(J.referencedSource);}}}}else{var Q=A instanceof File;var R=Q?A.name:A;var T=g(A);this._dvl.Core.CreateFileFromArrayBuffer(B,R,T);w.push(new e(A));}},this).attachAllItemsCompleted(function(m){if(x){w.forEach(this._destroySourceDatum.bind(this));}else{Array.prototype.push.apply(this._sourceData,w);v.forEach(function(z,A){var B=this._findSourceData({source:z.referencedSource})[0];var F=new f(A,B,z.content.join("\n"));this._sourceData.push(F);B.addRef();}.bind(this));}if(r){r(x);}},this).attachItemFailed(function(m){x=x||[];x.push({source:m.getParameter("source"),status:m.getParameter("status"),statusText:m.getParameter("statusText")});},this);if(s){y.attachItemProgress(s,this);}y.start();}else if(r){r();}return this;};G.prototype._mergeContentResource=function(i,m,r,s,t){var u=this._dvl.Scene.CreateNode(i,r,t.name,s);t.nodeProxy=m.createNodeProxy(u);if(t.localMatrix){t.nodeProxy.setLocalMatrix(t.localMatrix);}if(t.source){var v=this._findSourceData({source:t.source})[0];var w=this._findDvlSceneData({sourceDatum:v,root:false})[0];if(!w){w=new h(sap.ui.vk.dvl.getPointer(v instanceof f?this._dvl.Core.LoadSceneFromVDSL(v.content,t.password):this._dvl.Core.LoadSceneByUrl(d(t.source),t.password,g(t.source))),v,false);this._dvlSceneData.push(w);v.addRef();this._collectSourceProperties(t);if(t.sourceProperties.version.major>=4){c.warning(sap.ui.vk.getResourceBundle().getText(M.VIT20.summary),M.VIT20.code,"sap.ui.vk.GraphicsCore");}}t.dvlSceneDatum=w;w.addRef();this._dvl.Scene.RetrieveSceneInfo(w.dvlSceneId,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN).ChildNodes.forEach(function(x){this._dvl.Scene.CreateNodeCopy(i,x,u,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN);}.bind(this));}t.children.forEach(this._mergeContentResource.bind(this,i,m,u,undefined));};G.prototype.buildSceneTree=function(i){if(i.length===0){return null;}var r;var m;var s=i.map(function(w){return new j(w);});if(s.length===1){m=s[0];if(m.source){var t=this._findSourceData({source:m.source})[0];r=new h(sap.ui.vk.dvl.getPointer(t instanceof f?this._dvl.Core.LoadSceneFromVDSL(t.content,m.password):this._dvl.Core.LoadSceneByUrl(d(m.source),m.password,g(m.source))),t,true);t.addRef();this._collectSourceProperties(m);if(m.sourceProperties.version.major>=4){c.warning(sap.ui.vk.getResourceBundle().getText(M.VIT20.summary),M.VIT20.code,"sap.ui.vk.GraphicsCore");}}else{r=new h(this._dvl.Core.CreateEmptyScene(),null,true);}}else{var u=new C({sourceType:"vds",sourceId:q.sap.uid()});m=new j(u,true);u.destroy();u=null;Array.prototype.push.apply(m.children,s);s=[m];r=new h(this._dvl.Core.CreateEmptyScene(),null,true);}this._dvlSceneData.push(r);m.dvlSceneDatum=r;r.addRef();var v=new S(this,r.dvlSceneId);this._vkSceneData.push(new k(v,m));m.children.forEach(this._mergeContentResource.bind(this,r.dvlSceneId,v.getDefaultNodeHierarchy(),null,undefined));return v;};G.prototype.updateSceneTree=function(v,m,r){if(m.length===0){return null;}var s=this._getContentResourcesWithEncryptedVds3(m);if(s.length>0){c.error(sap.ui.vk.getResourceBundle().getText(M.VIT25.summary),M.VIT25.code,"sap.ui.vk.GraphicsCore");if(r){r({contentResourcesWithEncryptedVds3:s});}return null;}var t=this._getContentResourcesWithMissingPasswords(m);if(t.length>0){c.error(sap.ui.vk.getResourceBundle().getText(M.VIT21.summary),M.VIT21.code,"sap.ui.vk.GraphicsCore");if(r){r({contentResourcesWithMissingPasswords:t});}return null;}if(!v){return this.buildSceneTree(m);}var u=this._findVkSceneData({vkScene:v})[0].shadowContentResource;var w=!!u.source;var x=m.length===1&&!!m[0].getSource();if(!(w&&x&&u.source===m[0].getSource()||!w&&!x&&u.fake===m.length>1)){return this.buildSceneTree(m);}var y=this;var z=v._getDvlSceneId();var A=v.getDefaultNodeHierarchy();function B(F,m,I){function J(O,P){if(!O&&!P){return true;}else if(!!O^!!P){return false;}else{return O.source===P.getSource()&&O.sourceType===P.getSourceType()&&O.name===P.getName()&&O.password===P.getPassword();}}function K(O,P){P._shadowContentResource=O;O.sourceId=P.getSourceId();O.localMatrix=P.getLocalMatrix();if(O.nodeProxy){O.nodeProxy.setLocalMatrix(O.localMatrix);}}var i=0;var L=q.sap.arrayDiff(F,m,J,true);L.forEach(function(O){for(;i<O.index;++i){B(F[i].children,m[i].getContentResources(),F[i].nodeProxy.getNodeId());K(F[i],m[i]);}if(O.type==="delete"){y._destroyShadowContentResource(v,F[O.index]);F.splice(O.index,1);}else if(O.type==="insert"){var P;if(i<F.length&&F[i].nodeProxy){P=F[i].nodeProxy.getNodeId();}var Q=new j(m[O.index]);y._mergeContentResource(z,A,I,P,Q);F.splice(O.index,0,Q);++i;}});for(;i<F.length;++i){B(F[i].children,m[i].getContentResources(),F[i].nodeProxy&&F[i].nodeProxy.getNodeId());K(F[i],m[i]);}}B(u.fake?u.children:[u],m,0);A.fireChanged();return v;};G.prototype.destroyScene=function(v){var i;for(i=0;i<this._vkSceneData.length;++i){if(this._vkSceneData[i].vkScene===v){break;}}if(i===this._vkSceneData.length){c.warning("Scene with id '"+v.getId()+"' is not created by this GraphicsCore.");return this;}var m=this._vkSceneData.splice(i,1)[0];this._destroyShadowContentResource(v,m.shadowContentResource);v.destroy();return this;};var n=function(m,r,t){for(var i=0,s=m.length;i<s;++i){if(r.call(t,m[i],i,m)){return i;}}return-1;};var o=function(v,i){return n(v,function(m){return m.control===i;});};var p=function(v,r){return n(v,function(i){return i.rendererId===r;});};G.prototype._registerViewport=function(v){if(o(this._viewports,v)>=0){return false;}var i={control:v,canvas:null,rendererId:null};if(this._viewports.length===0){i.canvas=this._canvas;i.rendererId=this._rendererId;this._startRenderLoop();}else{if(this._viewports.length===1){var m=this._viewports[0];m.control._setCanvas(m.canvas=document.createElement("canvas"));this._dvl.Client.attachFrameFinished(this._handleFrameFinished,this);}i.canvas=document.createElement("canvas");i.rendererId=this._dvl.Core.CreateRenderer();}v._setCanvas(i.canvas);v._setRenderer(i.rendererId);v.attachResize(this._handleViewportResize,this);this._viewports.push(i);return true;};G.prototype._deregisterViewport=function(v){var i=o(this._viewports,v);if(i<0){return false;}var m=this._viewports.splice(i,1)[0];if(this._viewports.length===0){this._stopRenderLoop();}else{if(this._viewports.length===1){this._dvl.Client.detachFrameFinished(this._handleFrameFinished,this);var r=this._viewports[1-i];r.control._setCanvas(r.canvas=this._canvas);}this._dvl.Core.DeleteRenderer(m.rendererId);}v.detachResize(this._handleViewportResize,this);v._setRenderer(null);v._setCanvas(null);return true;};G.prototype._getViewportCount=function(){return this._viewports.length;};G.prototype._handleViewportResize=function(i){if(this._viewports.length>1){this._canvas.width=Math.max.apply(null,this._viewports.map(function(v){return v.canvas.width;}));this._canvas.height=Math.max.apply(null,this._viewports.map(function(v){return v.canvas.height;}));}};G.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};G.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=null;}return this;};G.prototype._renderLoop=(function(){var i;return function(){var m=this._viewports.length>1;this._viewports.forEach(function(v){var r=v.canvas,s=v.rendererId;this._dvl.Renderer._processCommandQueue(s);if(r.width>0&&r.height>0&&this._dvl.Renderer.ShouldRenderFrame(s)){if(m&&i!==s){this._dvl.Renderer.SetDimensions(r.width,r.height,s);}this._dvl.Renderer.RenderFrame(s);i=s;}},this);this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};})();G.prototype._handleFrameFinished=function(i){if(this._viewports.length>1){var m=p(this._viewports,i.rendererId);if(m>=0){var t=this._viewports[m].canvas,r=t.getContext("2d"),s=t.width,u=t.height;r.drawImage(this._canvas,0,this._canvas.height-u,s,u,0,0,s,u);}}};G.prototype.createViewStateManager=function(i,s,m){var v=new V(i,s,m);this._viewStateManagers.push(v);return v;};G.prototype.destroyViewStateManager=function(v){var i=this._viewStateManagers.indexOf(v);if(i>=0){this._viewStateManagers.splice(i,1)[0].destroy();}return this;};G.prototype.showDebugInfo=function(i){this._viewports.forEach(function(v){v.control.setShowDebugInfo(i);});return this;};G.prototype.getApi=function(i){switch(i){case sap.ui.vk.GraphicsCoreApi.LegacyDvl:return this._dvl;default:return null;}};G.prototype.collectGarbage=function(){this._cleanupDvlSceneData();this._cleanupSourceData();return this;};G.prototype._onlocalizationChanged=function(i){if(i.getParameter("changes").language){sap.ui.vk.dvl.checkResult(this._dvl.Core.SetLocale(sap.ui.getCore().getConfiguration().getLanguageTag()));}};G.prototype.setDecryptionHandler=function(i){this._dvl.Client.setDecryptionHandler(i);return this;};G.prototype.getDecryptionHandler=function(){return this._dvl.Client.getDecryptionHandler();};return G;});
