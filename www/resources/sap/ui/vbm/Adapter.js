/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(['sap/ui/core/Element','./library'],function(E,l){"use strict";var c=jQuery.sap.log;var A=E.extend("sap.ui.vbm.Adapter",{metadata:{library:"sap.ui.vbm",publicMethods:["load"],associations:{map:{type:"sap.ui.vbm.GeoMap"}},events:{submit:{parameters:{data:{type:"string"}}}}}});A.prototype.init=function(){this._eventHandlers=[];this._mapConfiguration={};this._clusterVOs=[];this._dataTypes={};this._data={};this._groupedActions={};this._clickHandler=this._genericClickHandler;this._handler=this._genericGeomapHandler;this._idKeyMap={};};A.prototype.exit=function(){this._detachHandlers();};A.prototype.setMap=function(m){var o=sap.ui.getCore().byId(this.getMap())||null;var n=sap.ui.getCore().byId(m instanceof sap.ui.vbm.GeoMap?m.getId():m);if((o!=n)&&(o!=null)){this._detachHandlers();this.init();}this.setAssociation("map",m,true);if(n!=null){var M=new sap.ui.model.json.JSONModel();n.setModel(M);}};A.prototype._map=function(){return sap.ui.getCore().byId(this.getMap());};A.prototype._attachHandler=function(e,a,b){if((e in this.mEventRegistry)&&(this.mEventRegistry[e].length>0)){return this;}else{if(!b._eventHandlers.some(function(d){return d===a;})){b._eventHandlers.push(a);}this.attachEvent(e,a,b);return this;}};A.prototype._detachHandlers=function(){var t=this;var d=function(s){if(this.hasListeners(s)){var b=this.mEventRegistry[s];for(var i=0,L=b.length;i<L;i++){var j=t._eventHandlers.indexOf(b[i].fFunction);if(j!==-1){this.detachEvent(s,b[i].fFunction,b[i].oListener);}}}};var g=sap.ui.getCore().byId(this.getMap());if(g!=null){var m=g.mEventRegistry;for(var e in m){if(m.hasOwnProperty(e)){d.call(g,e);}}var a=function(v){var V=v.mEventRegistry;for(var b in V){if(V.hasOwnProperty(b)){d.call(v,b);}}};g.getVos().forEach(a);}return this;};A.prototype.load=function(d){var o=null;if(typeof d==='string'){try{o=JSON.parse(d);}catch(e){c.debug("sap.ui.vbm.Adapter: attempt to load invalid JSON string.");return this;}}else if(typeof d==='object'){o=d;}if(!o){c.debug("sap.ui.vbm.Adapter: nothing to load.");return this;}if(!o.SAPVB){c.debug("sap.ui.vbm.Adapter:invalid object supplied for load.");return this;}if(o.SAPVB.Config){this._processConfiguration(o.SAPVB.Config);}if(o.SAPVB.Resources){this._processResources(o.SAPVB.Resources);}if(o.SAPVB.DataTypes){this._processDataTypes(o.SAPVB.DataTypes);}if(o.SAPVB.Clustering){this._processClusters(o.SAPVB.Clustering);}if(o.SAPVB.MapProviders){this._processMapProviders(o.SAPVB.MapProviders);}if(o.SAPVB.MapLayerStacks){this._processMapLayerStacks(o.SAPVB.MapLayerStacks);}if(o.SAPVB.Scenes){this._processScenes(o.SAPVB.Scenes);}if(o.SAPVB.Data){this._processData(o.SAPVB.Data);}if(o.SAPVB.Actions){this._processActions(o.SAPVB.Actions);}if(o.SAPVB.Automation&&o.SAPVB.Automation.Call){this._processAutomation(o.SAPVB.Automation,o.SAPVB.Menus);}if(o.SAPVB.Windows){this._processDetailWindows(o);}return this;};A.prototype._processConfiguration=function(a){return this;};A.prototype._processResources=function(r){if(r.Set){var g=sap.ui.getCore().byId(this.getMap());g.destroyResources();[].concat(r.Set.Resource).forEach(function(a){g.addResource(new sap.ui.vbm.Resource({"name":a.name,"value":a.value}));},this);}return this;};A.prototype._processDataTypes=function(d){if(d.Set){if(d.Set.name&&d.Set.type&&(d.Set.type==="N")){[].concat(d.Set.N).foreach(function(a){this._dataTypes.forEach(function(_){if(_.name==a.name){_=a;}});});}else{this._dataTypes=[].concat(d.Set.N);}}return this;};var f=function(s,p){if(s==null){return undefined;}var a=s.length;if(a<=0){return undefined;}if(typeof p!=='function'){return undefined;}for(var k=0;k<a;k++){var b=s[k];if(p(b)){return b;}}return undefined;};var h=function(s,p){if(s==null){return-1;}var a=s.length;if(a<=0){return-1;}if(typeof p!=='function'){return undefined;}for(var k=0;k<a;k++){var b=s[k];if(p(b)){return k;}}return-1;};A.prototype._processData=function(b){var g=function(a,n){var e=f(this._dataTypes,function(_){return _.name==n;});if((e==null)||!(e.A)){return undefined;}else{var o=f(e.A,function(_){return _.alias==a;});if(o!=null){return o.name;}else{return undefined;}}};var i=function(n){if(n.name&&n.E){this._data[n.name]=[].concat(n.E).map(function(e){var d={};for(var a in e){if((a!=="xmlns:VB")&&(a!=="n.name")&&e.hasOwnProperty(a)){if(a==="VB:c"){d["changeable"]=e[a];}else if(a==="VB:s"){d["select"]=e[a];}else{var s=g.call(this,a,n.name);if((s!=null)&&(s!=="")){d[s]=e[a];}else{d[a]=e[a];}}}}return d;},this);}};var u=function(e){var d={};for(var a in e){if((a!=="xmlns:VB")&&(a!=="n.name")&&e.hasOwnProperty(a)){if(a==="VB:c"){d["changeable"]=e[a];}else if(a==="VB:s"){d["select"]=e[a];}else{var s=g.call(this,a,e["n.name"]);if((s!=null)&&(s!=="")){d[s]=e[a];}else{d[a]=e[a];}}}}if(!this._data[e["n.name"]]){this._data[e["n.name"]]=[];}if(this._data[e["n.name"]].some(function(_){return _.Key==e.K;})){var j=h(this._data[e["n.name"]],function(_){return _.Key===e.K;});if(j!==-1){this._data[e["n.name"]][j]=d;}}else{this._data[e["n.name"]].push(d);}};if(b.Remove){[].concat(b.Remove).filter(function(r){return(r.N&&r.N.E);}).forEach(function(r){[].concat(r.N.E).forEach(function(e){var a=h(this._data[r.name],function(_){return _.Key===e.K;});if(a!==-1){this._data[r.name].splice(a,1);}},this);},this);}if(b.Set&&(typeof b.Set==='object')&&!(jQuery.isEmptyObject(b.Set))){if(!Array.isArray(b.Set)&&!(b.Set.name)&&!(b.Set.type)){this._data={};if(b.Set.N!==null){[].concat(b.Set.N).forEach(i,this);}}else{[].concat(b.Set).filter(function(s){return(s.name)&&(s.type);}).map(function(s){return[].concat(s.N);}).reduce(function(a,B){return a.concat(B);}).map(function(n){var e=[].concat(n.E);return e.map(function(_){_["n.name"]=n.name;return _;});}).reduce(function(a,B){return a.concat(B);}).forEach(u,this);}}sap.ui.getCore().byId(this.getMap()).getModel().setData(this._data,false);return this;};A.prototype._processMapProviders=function(p){if(p.Set&&p.Set.MapProvider){this._mapConfiguration.MapProvider=[].concat(p.Set.MapProvider).map(function(a){return{name:a.name,tileX:a.tileX,tileY:a.tileY,minLOD:a.minLOD,maxLOD:a.maxLOD,copyright:a.copyright,Source:a.Source?[].concat(a.Source).map(function(s){return{id:s.id,url:s.url};}):a.Source};});this._updateMapconfiguration();}return this;};A.prototype._processMapLayerStacks=function(s){if(s.Set&&s.Set.MapLayerStack){this._mapConfiguration.MapLayerStacks=[].concat(s.Set.MapLayerStack).map(function(a){return{name:a.name,MapLayer:a.MapLayer?[].concat(a.MapLayer).map(function(b){return{name:b.name,refMapProvider:b.refMapProvider,opacity:b.opacity,colBkgnd:b.colBkgnd};}):a.MapLayer};});this._updateMapconfiguration();}return this;};A.prototype._updateMapconfiguration=function(){if(this._mapConfiguration.MapProvider&&this._mapConfiguration.MapLayerStacks){sap.ui.getCore().byId(this.getMap()).setMapConfiguration(this._mapConfiguration);}return this;};A.prototype._processScenes=function(s){if(s.Set&&s.Set.SceneGeo){var m=this._map();if(s.Set.SceneGeo.refMapLayerStack){m.setRefMapLayerStack(s.Set.SceneGeo.refMapLayerStack);}var v=s.Set.SceneGeo.VO;m.destroyVos();var a={};a["Spot.pos"]="position";a["Spot.dragdata"]="dragData";a["Link.posarray"]="position";a["Link.dragdata"]="dragData";if(!v){return this;}v.forEach(function(b){var p="";var d="";var g="";var e="";if(this._clusterVOs.indexOf(b.id)!=-1){return;}switch(b.id){case"Area":break;case"Link":var r=new sap.ui.vbm.Route();for(e in b){if(jQuery.sap.endsWith(e,".bind")){g=e.substring(0,e.indexOf('.bind'));if(b.id+'.'+g in a){p=a[b.id+'.'+g];}else{p=g;}d=""+b[e].substring(b[e].indexOf('.')+1)+"";r.bindProperty(p,{parts:[{path:d}]});}else if(b.id+'.'+g in a){r[a[b.id+'.'+e]]=b[e];}else{r[e]=b[e];}}var _=h(this._dataTypes,function(o){return o.name===b.datasource;});if(_!==-1){var i=this._dataTypes[_];r.bindProperty("key",{parts:[{path:i.key}]});}m.addVo(new sap.ui.vbm.Routes("Route",{items:{path:"/"+b.datasource+"",template:r}}));break;case"ExtLink":break;case"Circle":break;case"CircleGeoDist":break;case"Spot":var j=new sap.ui.vbm.Spot();for(e in b){if(jQuery.sap.endsWith(e,".bind")){g=e.substring(0,e.indexOf('.bind'));if(b.id+'.'+g in a){p=a[b.id+'.'+g];}else{p=g;}d=""+b[e].substring(b[e].indexOf('.')+1)+"";j.bindProperty(p,{parts:[{path:d}]});}else if(b.id+'.'+g in a){j[a[b.id+'.'+e]]=b[e];}else{j[e]=b[e];}}var k=h(this._dataTypes,function(o){return o.name===b.datasource;});if(k!=-1){var n=this._dataTypes[k];j.bindProperty("key",{parts:[{path:n.key}]});}m.addVo(new sap.ui.vbm.Spots("Spot",{items:{path:"/"+b.datasource+"",template:j}}));break;case"ExtArea":break;case"Box":break;case"PieChart":break;default:break;}},this);}return this;};A.prototype._processActions=function(b){var d=function(q){return function(a){switch(a.refEvent){case"Click":if(!this._eventHandlers.some(function(t){return t===this._handler;},this)){this._eventHandlers.push(this._handler);}q.attachClick(this._handler,this);break;case"ContextMenu":if(!this._eventHandlers.some(function(t){return t===this._handler;},this)){this._eventHandlers.push(this._handler);}q.attachContextMenu(this._handler,this);break;case"DoubleClick":if(!this._eventHandlers.some(function(t){return t===this._clickHandler;},this)){this._eventHandlers.push(this._clickHandler);}q.attachClick(this._clickHandler,this);break;default:break;}};};if((b.Set!=null)&&(b.Set.Action!=null)){var e=sap.ui.getCore().byId(this.getMap()).getVos();var i=e.map(function(v){return v.getTemplateObject().type;});this._groupedActions=[].concat(b.Set.Action).reduce(function(g,a){var t=a.refVO;if(!a.refVO){t="General";}g[t]=g[t]||[];g[t].push(a);return g;},{});var k=function(t){return t.refEvent==="KeyPress";};var j=function(a){return a.refEvent==="Click";};var m=function(a){return a.refEvent==="DoubleClick";};var n=function(a){return a.refEvent!=="Click";};for(var g in this._groupedActions){var o;switch(g){case"Spot":o="{00100000-2012-0004-B001-64592B8DB964}";break;case"Link":o="{00100000-2012-0004-B001-C46BD7336A1A}";break;default:o="";break;}var p=i.indexOf(o);var q=e[p];if(q){var r=this._groupedActions[g];if(r.some(m)){if(r.some(j)){r.filter(n).forEach(d(q),this);}else{r.forEach(d(q),this);}}else{r.forEach(d(q),this);}}if(g==="General"){var s=f(this._groupedActions[g],k);if(s!=null){this._setupKeyboardEvents(s);}}}}return this;};A.prototype._setupKeyboardEvents=function(a){var t=this;var g=sap.ui.getCore().byId(this.getMap());g.setAllowKeyEventRepeat(false);g.setKeyEventDelay(250);var b=function(e){var p=e.mParameters;if(p.key=="Shift"||p.code==16||p.key=="Control"||p.code==17||p.key=="Alt"||p.code==18||p.key=="Meta"||p.code==91){return t;}var d={"version":"2.0","xmlns:VB":"VB","Action":{"name":a.name,"Params":{"Param":[{"name":"code","#":p.code},{"name":"shift","#":p.shift},{"name":"ctrl","#":p.ctrl},{"name":"alt","#":p.alt},{"name":"meta","#":p.meta}]}}};t.fireSubmit({data:JSON.stringify(d)});};if(!this._eventHandlers.some(function(e){return e===b;},this)){this._eventHandlers.push(b);}sap.ui.getCore().byId(this.getMap()).attachKeyDown(b);return this;};A.prototype._processAutomation=function(a,m){var b={};if(a.Call.handler==="CONTEXTMENUHANDLER"){var t=this;var V=sap.ui.getCore().byId(this.getMap()).getVos().map(function(v){return v.getItems();}).reduce(function(v,d){return v.concat(d);});var i=h(V,function(v){return v.getKey()===a.Call.instance.split('.')[1];});if(i!==-1){var o=V[i];if(o){a.Call.instance=o.getUniqueId();if(m.Set.Menu){[].concat(m.Set.Menu).forEach(function(M){t._attachHandler.call(o,M.action,function(e){var d=e.mParameters.data;d.Action.instance=d.Action.object+'.'+e.oSource.getKey();this.fireSubmit({data:JSON.stringify(d)});},t);});}}}}b["Automation"]=a;b["Menus"]=m;var L={};L["SAPVB"]=b;sap.ui.getCore().byId(this.getMap()).load(L);return this;};A.prototype._processClusters=function(a){this._clusterVOs=[];if(a.Set){var m=this._map();m.destroyClusters();[].concat(a.Set.Cluster).forEach(function(i){this._clusterVOs.push(i.VO);var b=null;switch(i.type){case"distance":b=new sap.ui.vbm.ClusterDistance(i.id);if(i.distance){b.setDistance(parseFloat(i.distance));}break;case"grid":b=new sap.ui.vbm.ClusterGrid(i.id);if(i.limit){b.setLimit(parseInt(i.limit,10));}if(i.limitOnSum){b.setLimitTotal(parseInt(i.limitOnSum,10));}if(i.order){b.setOrderIndex(parseInt(i.order,10));}if(i.areabordersize){b.setCellSpacing(-parseInt(i.areabordersize,10));}if(i.distanceX&&i.distanceY){b.setGridSize(i.distanceX+";"+i.distanceY);}if(i.offsetX&&i.offsetY){b.setOffset(i.offsetX+";"+i.offsetY);}break;case"tree":b=new sap.ui.vbm.ClusterTree(i.id,{});break;default:c.debug("sap.ui.vbm.Adapter: unsupported clustering type \""+i.type+"\"");break;}if(b){if(i.rule){b.setRule(i.rule);}b.setTextSettings({textcolor:i.textcolor,textfont:i.textfont,textfontsize:i.textfontsize,textoffset:i.textoffset,textoffsetY:i.textoffsetY});b.setVizTemplate(new sap.ui.vbm.Cluster());m.addCluster(b);}},this);}return this;};A.prototype._processDetailWindows=function(o){var g=sap.ui.getCore().byId(this.getMap());var t=this;if(o.SAPVB.Windows.Set.name){var b=function(p,n){return function(d){return d[p]===n;};};var w=[].concat(o.SAPVB.Windows.Set).map(function(a){var m=g.getModel().getData();var W=a;for(var s in a.Window){if(a.Window.hasOwnProperty(s)){if(jQuery.sap.endsWith(s,".bind")){if(jQuery.sap.startsWith(s,"pos")){var p=a.Window[s].split(".");if(p[0]in m){var i=h(m[p[0]],b("Key",p[1]));if(i!==-1){var d=m[p[0]][i];if(p[2]in d){delete W.Window[s];W.Window[s.split(".")[0]]=d[p[2]];}}}}}}}return W;},this);o.SAPVB.Windows.Set=w;if(o.SAPVB.Scenes&&o.SAPVB.Scenes.Set&&o.SAPVB.Scenes.Set.name&&o.SAPVB.Scenes.Set.Scene&&o.SAPVB.Scenes.Set.Scene.VO){var V=[].concat(o.SAPVB.Scenes.Set.Scene.VO).map(function(v){var d=v;var e=function(d,i,p){return function(s){if(s.name&&s.type){var D=s[s.type];if(D.name===s.name){var a=f([].concat(this._dataTypes),b("name",D.name));var j=f([].concat(f([].concat(a.N),b("name",p[2])).A),b("name",p[4])).alias;var k=[].concat(D.E)[p[1]];var S=[].concat(f([].concat(k.N),b("name",p[2])).E)[p[3]];d[i.split(".")[0]]=S[j];delete d[i];}}};};for(var i in v){if(v.hasOwnProperty(i)){if(jQuery.sap.endsWith(i,".bind")){var p=v[i].split(".");if(o.SAPVB.Data&&o.SAPVB.Data.Set){[].concat(o.SAPVB.Data.Set).forEach(e(d,i,p),this);}}}}if(o.SAPVB.Actions&&o.SAPVB.Actions.Set){[].concat(o.SAPVB.Actions.Set).filter(function(a){return a.Action.refVO===d.id;}).forEach(function(a){t._attachHandler.call(g,a.Action.name,t._handler,t);});}return d;},this);o.SAPVB.Scenes.Set.Scene.VO=V;}g.load(o);}return this;};A.prototype._genericGeomapHandler=function(d){var p=d.getParameters();var o=p.data?p.data:p;if(o.Action&&o.Action.object){if(o.Action.object==="Route"){o.Action.object="Link";}var g=f(this._groupedActions[o.Action.object],function(a){return a.refEvent.toLowerCase()===o.Action.name.toLowerCase();});if(g){if(o.Action&&o.Action.instance){o.Action.instance=o.Action.instance.split('.')[0]+'.'+p.instance.getKey();o.Action.name=g.name;}if((o.Data)&&(o.Data.Merge)&&(o.Data.Merge.N)){var j=function(){this._map().getVos().map(function(a){return a.getItems();}).reduce(function(a,b){return a.concat(b);}).forEach(function(i){this._idKeyMap[i.getUniqueId()]=i.getKey();},this);}.bind(this);var k=o.Data.Merge.N.map(function(n){return n.E;}).reduce(function(a,b){return a.concat(b);}).map(function(e){return e.K;});if(jQuery.isEmptyObject(this._idKeyMap)){j();}if(k.some(function(u){return!this._idKeyMap.hasOwnProperty(u);},this)){j();}var m=function(e){e.K=this._idKeyMap[e.K];};[].concat(o.Data.Merge.N).map(function(n){return n.E;}).reduce(function(a,b){return a.concat(b);}).forEach(m,this);}this.fireSubmit({data:JSON.stringify(o)});}}this.timeout=undefined;};A.prototype._genericClickHandler=function(e){if(this.timeout){e.getParameters().data.Action.name="doubleclick";clearTimeout(this.timeout);this._genericGeomapHandler.call(this,e);}else{this.oEvent=jQuery.extend(true,{},e);this.timeout=setTimeout(this._genericGeomapHandler.bind(this,this.oEvent),500);}};return A;});
