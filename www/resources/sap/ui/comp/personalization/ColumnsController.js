/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','./Util'],function(q,B,l,U){"use strict";var C=B.extend("sap.ui.comp.personalization.ColumnsController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.columns);},metadata:{properties:{triggerModelChangeOnColumnInvisible:{type:"boolean",group:"Misc",defaultValue:false}},events:{afterColumnsModelDataChange:{}}}});C.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(U.getTableBaseType(t)===sap.ui.comp.personalization.TableType.Table){t.detachColumnMove(this._onColumnMove,this);t.detachColumnVisibility(this._onColumnVisibility,this);t.detachColumnResize(this._onColumnResize,this);t.attachColumnMove(this._onColumnMove,this);t.attachColumnVisibility(this._onColumnVisibility,this);t.attachColumnResize(this._onColumnResize,this);}};C.prototype.reducePersistentModel=function(){this.syncTable2PersistentModel();};C.prototype._getTable2Json=function(){return this.getUnionData(this.getPersistentDataRestore(),this.getPersistentData());};C.prototype._getDataSuiteFormat2Json=function(d){var j=this._mapDataSuiteFormat2Json(d);return j;};C.prototype._mapDataSuiteFormat2Json=function(d){var p=U.copy(this.getPersistentDataRestore());if(d.Total&&d.Total.length){d.Total.forEach(function(c){var o=U.getArrayElementByKey("columnKey",c,p.columns.columnsItems);if(o){o.total=true;}});}if(d.Visualizations&&d.Visualizations.length){var L=d.Visualizations.filter(function(v){return v.Type==="LineItem";});if(L.length){p.columns.columnsItems.forEach(function(c){c.visible=false;});L[0].Content.forEach(function(c,i){var o=U.getArrayElementByKey("columnKey",c.Value,p.columns.columnsItems);if(!o){return;}o.visible=true;var I=U.getIndexByKey("columnKey",c.Value,p.columns.columnsItems);this._moveModelItems(I,i,p.columns.columnsItems);},this);}}return p;};C.prototype._moveModelItems=function(i,I,a){if(i<0||I<0||i>a.length-1||I>a.length-1){return;}var m=a.splice(i,1);a.splice(I,0,m[0]);a.forEach(function(M,b){M.index=b;});};C.prototype._getTable2JsonRestore=function(c){if(!c){return B.prototype._getTable2JsonRestore.apply(this,arguments);}var j=this.createPersistentStructure();var i=this.getIgnoreColumnKeys();var o=this.getColumnMap();var I=0;c.forEach(function(s){if(i.indexOf(s)>-1){return;}var a=o[s];j.columns.columnsItems.push({columnKey:s,index:I,visible:a?a.getVisible():false,width:a?a.getWidth():undefined,total:(a&&a.getSummed)?a.getSummed():undefined});I++;});return j;};C.prototype.syncTable2PersistentModel=function(){B.prototype.syncTable2PersistentModel.apply(this,arguments);var d=this.getModel("$sapuicomppersonalizationBaseController").getData();var D=this.getChangeData(d.persistentData,this.getTableRestoreJson());if(D){d.persistentData.columns=D.columns;}else{d.persistentData.columns.columnsItems=[];}};C.prototype.syncTable2TransientModel=function(){this._syncTable2TransientModel();};C.prototype._determineTooltipText=function(o){var t=null;if(o&&o.getTooltip){if(o.getTooltip()instanceof sap.ui.core.TooltipBase){t=o.getTooltip().getTooltip_Text();}else{t=o.getTooltip_Text();}if(!t&&o instanceof sap.ui.table.AnalyticalColumn){t=o.getTooltip_AsString();}if(!t&&o.getLabel&&o.getLabel().getTooltip_Text){t=o.getLabel().getTooltip_Text();}}return t;};C.prototype._syncTable2TransientModel=function(){var t=this.getTable();var i=[];var c;var o;if(t){var a=this.getColumnMap(true);if(U.getTableBaseType(t)===sap.ui.comp.personalization.TableType.Table){for(c in a){o=a[c];var T=this._determineTooltipText(o);i.push({columnKey:c,text:o.getLabel().getText(),tooltip:T,visible:o.getVisible(),width:o.getWidth(),total:(o&&o.getSummed)?o.getWidth():undefined});}}else{if(U.getTableType(t)===sap.ui.comp.personalization.TableType.ResponsiveTable){for(c in a){o=a[c];i.push({columnKey:c,text:o.getHeader().getText(),tooltip:(o.getHeader().getTooltip()instanceof sap.ui.core.TooltipBase)?o.getHeader().getTooltip().getTooltip_Text():o.getHeader().getTooltip_Text(),visible:o.getVisible(),width:o.getWidth()});}}}}var I=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.columns.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.columns.items=i;}};C.prototype._setNewColumnItemIndex=function(d,c,n){var i=-1;if(c&&n!==null&&n!==undefined&&n>-1){i=U.getIndexByKey("columnKey",U.getColumnKey(c),d.persistentData.columns.columnsItems);if(i>-1){d.persistentData.columns.columnsItems[i].index=n;}else{d.persistentData.columns.columnsItems.push({columnKey:U.getColumnKey(c),index:n});}}};C.prototype._onColumnMove=function(e){var i=0,n=null,t=null;var T=null,d=null,c=null;var N=null,o=null;c=e.getParameter("column");N=e.getParameter("newPos");this.fireBeforePotentialTableChange();if(c){T=this.getTable();o=T.indexOfColumn(c);}if(o!==null&&N!==null){d=this.getModel("$sapuicomppersonalizationBaseController").getData();if(o>N){for(i=N;i<=o;i++){if(i<o){t=T.getColumns()[i];n=i+1;}else{t=c;n=e.getParameter("newPos");}this._setNewColumnItemIndex(d,t,n);}}else{for(i=o;i<=N;i++){if(i===o){t=c;n=e.getParameter("newPos");}else{t=T.getColumns()[i];n=i-1;}this._setNewColumnItemIndex(d,t,n);}}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();}};C.prototype._onColumnVisibility=function(e){var d=this.getModel("$sapuicomppersonalizationBaseController").getData();var c=e.getParameter("column");var v=e.getParameter("newVisible");this.fireBeforePotentialTableChange();var i=U.getIndexByKey("columnKey",U.getColumnKey(c),d.persistentData.columns.columnsItems);if(i>-1){d.persistentData.columns.columnsItems[i].visible=v;}else{d.persistentData.columns.columnsItems.push({columnKey:U.getColumnKey(c),visible:v});}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnTotal=function(p){var d=this.getModel("$sapuicomppersonalizationBaseController").getData();var c=p.column;var i=p.isSummed;this.fireBeforePotentialTableChange();var I=U.getIndexByKey("columnKey",U.getColumnKey(c),d.persistentData.columns.columnsItems);if(I>-1){d.persistentData.columns.columnsItems[I].total=i;}else{d.persistentData.columns.columnsItems.push({columnKey:U.getColumnKey(c),total:i});}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype._onColumnResize=function(e){var c=e.getParameter("column");var d=this.getModel("$sapuicomppersonalizationBaseController").getData();this.fireBeforePotentialTableChange();var i=U.getIndexByKey("columnKey",U.getColumnKey(c),d.persistentData.columns.columnsItems);if(i>-1){d.persistentData.columns.columnsItems[i].width=e.getParameter("width");}else{d.persistentData.columns.columnsItems.push({columnKey:U.getColumnKey(c),width:e.getParameter("width")});}this.getModel("$sapuicomppersonalizationBaseController").setData(d,true);this.fireAfterPotentialTableChange();this.fireAfterColumnsModelDataChange();};C.prototype.getPanel=function(p){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nColumnsPanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nColumnsItem");var t=this;var v=-1;if(p&&p.visibleItemsThreshold){v=p.visibleItemsThreshold;}var P=new sap.m.P13nColumnsPanel({visibleItemsThreshold:v,items:{path:'$sapmP13nPanel>/transientData/columns/items',template:new sap.m.P13nItem({columnKey:'{$sapmP13nPanel>columnKey}',text:'{$sapmP13nPanel>text}',visible:'{$sapmP13nPanel>visible}',tooltip:'{$sapmP13nPanel>tooltip}',width:"{$sapmP13nPanel>width}"})},columnsItems:{path:"$sapmP13nPanel>/persistentData/columns/columnsItems",template:new sap.m.P13nColumnsItem({columnKey:"{$sapmP13nPanel>columnKey}",index:"{$sapmP13nPanel>index}",visible:"{$sapmP13nPanel>visible}",width:"{$sapmP13nPanel>width}",total:"{$sapmP13nPanel>total}"})},beforeNavigationTo:t.setModelFunction()});P.attachChangeColumnsItems(function(e){var d=this.getModel("$sapuicomppersonalizationBaseController").getData();var n=e.getParameter('newItems');var E=e.getParameter('existingItems');var c=null,s=null;if(n){n.forEach(function(N){c={columnKey:N.getColumnKey()};if(N.getIndex()!==undefined){c.index=N.getIndex();}if(N.getVisible()!==undefined){c.visible=N.getVisible();}if(N.getWidth()!==undefined){c.width=N.getWidth();}if(N.getTotal()!==undefined){c.total=N.getTotal();}d.persistentData.columns.columnsItems.push(c);});}if(E){E.forEach(function(o){c=null;s=o.getColumnKey();c=U.getArrayElementByKey("columnKey",s,d.persistentData.columns.columnsItems);if(c){if(o.getIndex()!==undefined){c.index=o.getIndex();}if(o.getVisible()!==undefined){c.visible=o.getVisible();}if(o.getWidth()!==undefined){c.width=o.getWidth();}if(o.getTotal()!==undefined){c.total=o.getTotal();}}});}},this);P.attachSetData(function(){var d=this.getModel("$sapuicomppersonalizationBaseController").getData();this.getModel("$sapuicomppersonalizationBaseController").setData(d);},this);this._correctColumnsItemsInPersistentData();return P;};C.prototype.onAfterReset=function(p){var P=null;if(p&&p.columns&&p.columns.oPanel){P=p.columns.oPanel;P.reInitialize();}};C.prototype.onAfterSubmit=function(p){this._correctColumnsItemsInPersistentData(p);if(p&&p.columns&&p.columns.tableItemsChanged){B.prototype.onAfterSubmit.apply(this,arguments);}};C.prototype._correctColumnsItemsInPersistentData=function(p){this._removeIndexFromInvisibleColumnsItems();this._removeEmptyColumnsItems();if(p){this._correctColumnsItemIndexesBasedOnPayload(p);}};C.prototype._correctColumnsItemIndexesBasedOnPayload=function(p){var c=this.getModel("$sapuicomppersonalizationBaseController").getData().persistentData.columns.columnsItems;var o=null,i=null,s=null,r=-1;if(c&&c.length>0){if(p&&p.columns&&p.columns.tableItemsChanged){p.columns.selectedItems.forEach(function(S,a){i=o=null;s=S.columnKey;o=U.getArrayElementByKey("columnKey",s,c);if(o&&o.index!==undefined&&o.index!==null){i=o.index;}if(i===null||i===undefined){i=a;}if(i<=r){i=r+1;}if(Math.abs(i-r)>1){i=r+1;}if(o){o.index=i;}else{o={"columnKey":s,"index":i};c.push(o);}r=i;});}}};C.prototype._removeEmptyColumnsItems=function(){var c=this.getModel("$sapuicomppersonalizationBaseController").getData().persistentData.columns.columnsItems;var i=0,L=0,o=null;if(c&&c.length){L=c.length;for(i=0;i<L;i++){o=c[i];if(o){if(o.index!==null&&o.index!==undefined){continue;}if(o.visible!==null&&o.visible!==undefined){continue;}if(o.width!==null&&o.width!==undefined){continue;}if(o.total!==null&&o.total!==undefined){continue;}c.splice(i,1);i-=1;}}}};C.prototype._removeIndexFromInvisibleColumnsItems=function(){var c=null,i=null,I=null,a=0;var p=this.getModel("$sapuicomppersonalizationBaseController").getData().persistentData;var t=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData;var v=null;if(p&&p.columns&&p.columns.columnsItems){c=p.columns.columnsItems;this._sortArrayByPropertyName(c,"index");}if(t&&t.columns&&t.columns.items){i=t.columns.items;}if(c&&c.length){c.forEach(function(o){I=v=null;if(o.index!==undefined){v=o.visible;if(v===undefined||v===null){I=U.getArrayElementByKey("columnKey",o.columnKey,i);if(I&&I.visible!==undefined){v=I.visible;}}if(v===false){delete o.index;a+=1;}else{if(o.index>0&&o.index>=a){o.index-=a;}}}});}};C.prototype.syncJsonModel2Table=function(j){var t=this.getTable();var i=j.columns.columnsItems;this.fireBeforePotentialTableChange();if(U.getTableBaseType(t)===sap.ui.comp.personalization.TableType.Table){this._applyChangesToUiTableType(t,i);}else if(U.getTableType(t)===sap.ui.comp.personalization.TableType.ResponsiveTable){this._applyChangesToMTableType(t,i);}this.fireAfterPotentialTableChange();};C.prototype._sortByIndex=function(a,b){if(a.index!==undefined&&b.index===undefined){return-1;}if(b.index!==undefined&&a.index===undefined){return 1;}if(a.index<b.index){return-1;}if(a.index>b.index){return 1;}return 0;};C.prototype._applyChangesToUiTableType=function(t,c){var o=null;var a={};var f=t.getFixedColumnCount();var F=f===0?f:f-1;var b=this;var s=function(j,k){var r=[];j.sort(b._sortByIndex);j.forEach(function(m){r.push(m.columnKey);a[m.columnKey]=m;});k.forEach(function(m,I){if(r.indexOf(m)<0){r.splice(I,0,m);}});return r;};var S=function(j,o){var k=a[j];if(k&&k.visible!==undefined&&o.getVisible()!==k.visible){o.setVisible(k.visible,true);}};var d=function(I,j,o){var T=t.indexOfColumn(o);var m=I;if(m!==undefined&&T!==m){if(T>-1){t.removeColumn(o,true);}t.insertColumn(o,m,true);if(!(T>F&&m>F)){t.setFixedColumnCount(0,true);}}};var e=function(j,o){var k=a[j];if(k&&k.width!==undefined&&o.getWidth()!==k.width){o.setWidth(k.width,true);}};var g=function(j,o){var k=a[j];if(k&&k.total!==undefined&&o.getSummed&&o.getSummed()!==k.total){o.setSummed(k.total,true);}};if(c.length){var h=s(c,this._aColumnKeys);var i=this.getColumnMap();h.forEach(function(j,I){o=i[j];if(o){S(j,o);d(I,j,o);e(j,o);g(j,o);}});}};C.prototype._applyChangesToMTableType=function(t,c){var T=false;var o=this.getColumnMap();var s=function(a,b){var m=a.index;if(m!==undefined){b.setOrder(m,true);T=true;}};var S=function(a,b){if(a.visible!==undefined&&b.getVisible()!==a.visible){b.setVisible(a.visible,true);T=true;}};if(c.length){c.sort(function(a,b){if(a.index<b.index){return-1;}if(a.index>b.index){return 1;}return 0;});c.forEach(function(a){var b=o[a.columnKey];if(b){s(a,b);S(a,b);}},this);}if(T){t.invalidate();}};C.prototype.getChangeType=function(p,P){var c=this.getChangeData(p,P);var n=U.getTableType(this.getTable())===sap.ui.comp.personalization.TableType.AnalyticalTable||this.getTriggerModelChangeOnColumnInvisible();if(c){var o=sap.ui.comp.personalization.ChangeType.TableChanged;c.columns.columnsItems.some(function(i){if(i.visible||(i.visible===false&&n)){o=sap.ui.comp.personalization.ChangeType.ModelChanged;return true;}if(i.total===false||i.total===true){o=sap.ui.comp.personalization.ChangeType.ModelChanged;return true;}});return o;}return sap.ui.comp.personalization.ChangeType.Unchanged;};C.prototype.getChangeData=function(p,P){if(!P||!P.columns||!P.columns.columnsItems){return null;}var c={columns:U.copy(p.columns)};var i=true;p.columns.columnsItems.some(function(I){var o=U.getArrayElementByKey("columnKey",I.columnKey,P.columns.columnsItems);if(!U.semanticEqual(I,o)){i=false;return true;}});if(i){return null;}var t=[];c.columns.columnsItems.forEach(function(I,a){var o=U.getArrayElementByKey("columnKey",I.columnKey,P.columns.columnsItems);if(U.semanticEqual(I,o)){t.push(I);return;}for(var b in I){if(b==="columnKey"||!o){if(o&&o[b]===undefined){delete I[b];}else{continue;}}if(I[b]===o[b]){delete I[b];}}if(Object.keys(I).length<2){t.push(I);}});t.forEach(function(I){var a=U.getIndexByKey("columnKey",I.columnKey,c.columns.columnsItems);c.columns.columnsItems.splice(a,1);});return c;};C.prototype._sortArrayByPropertyName=function(A,p,t){var s=[];if(t===null||t===undefined){t=false;}if(A&&A.length>0&&p!==undefined&&p!==null&&p!==""){if(t){s=q.extend(true,[],A);}else{s=A;}s.sort(function(a,b){var c=a[p];var d=b[p];if(c<d||(c!==undefined&&d===undefined)){return-1;}if(c>d||(c===undefined&&d!==undefined)){return 1;}return 0;});}return s;};C.prototype._recalculateIndexes=function(o,s,e){var m=null,M=null,i=null;if(!o||!o.length){return;}i=o.length-1;if(s===null||s===undefined||s<0||e===null||e===undefined||e<0||e>i||s===e){return;}m=Math.min(s,e);M=Math.max(s,e);o.forEach(function(O,I){if(I<m||I>M||I>i){return;}if(s>e){O.index+=1;}else{O.index-=1;}});};C.prototype.getUnionData=function(p,P){var o=U.copy(p);if(!P||!P.columns||!P.columns.columnsItems||P.columns.columnsItems.length===0){return o.columns?{columns:o.columns}:null;}if(!o||!o.columns||!o.columns.columnsItems){return{columns:q.extend(true,{},P.columns)};}var d=[];var u=this.createPersistentStructure();o.columns.columnsItems.forEach(function(c,i){var a=U.getArrayElementByKey("columnKey",c.columnKey,P.columns.columnsItems);if(a){if(a.visible!==undefined){c.visible=a.visible;}if(a.width!==undefined){c.width=a.width;}if(a.total!==undefined){c.total=a.total;}if(a.index!==undefined){c.index=a.index;d.push(c);return;}}u.columns.columnsItems.push(c);});if(d&&d.length>0){this._sortArrayByPropertyName(d,"index");d.forEach(function(D){u.columns.columnsItems.splice(D.index,0,D);});}u.columns.columnsItems.forEach(function(c,i){c.index=i;});return u;};C.prototype.isColumnSelected=function(p,P,c){if(!p){P.columnsItems.some(function(o,I){if(o.columnKey===c&&o.visible){i=I;return true;}});return i>-1;}if(!p.selectedItems){return false;}var i=U.getIndexByKey("columnKey",c,p.selectedItems);return i>-1;};C.prototype.getDataSuiteFormatSnapshot=function(d){var p=this.getUnionData(this.getPersistentDataRestore(),this.getPersistentData());if(!p.columns||!p.columns.columnsItems||!p.columns.columnsItems.length){return;}var c=p.columns.columnsItems.filter(function(o){return!!o.total;});if(c.length){d.Total=c.map(function(o){return o.columnKey;});}var a=p.columns.columnsItems.filter(function(o){return!!o.visible;});if(a.length){if(!d.Visualizations){d.Visualizations=[];}a.sort(this._sortByIndex);d.Visualizations.push({Type:"LineItem",Content:a.map(function(o){return{Value:o.columnKey,Label:undefined};})});}};C.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(U.getTableBaseType(t)===sap.ui.comp.personalization.TableType.Table){t.detachColumnMove(this._onColumnMove,this);t.detachColumnVisibility(this._onColumnVisibility,this);t.detachColumnResize(this._onColumnResize,this);}};return C;},true);
