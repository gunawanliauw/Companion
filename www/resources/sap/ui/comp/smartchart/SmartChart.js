/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/chart/Chart','sap/chart/library','sap/chart/data/Dimension','sap/chart/data/Measure','sap/m/SegmentedButton','sap/m/Button','sap/m/Text','sap/m/FlexItemData','sap/ui/core/Item','sap/m/OverflowToolbar','sap/m/OverflowToolbarButton','sap/m/ToolbarSeparator','sap/m/ToolbarDesign','sap/m/ToolbarSpacer','sap/m/VBox','sap/m/VBoxRenderer','sap/ui/comp/providers/ChartProvider','sap/ui/comp/smartfilterbar/FilterProvider','sap/ui/comp/smartvariants/SmartVariantManagement','sap/ui/model/Filter','sap/ui/model/FilterOperator','sap/ui/comp/personalization/Util','sap/ui/Device','sap/ui/comp/odata/ODataModelUtil','sap/ui/comp/odata/MetadataAnalyser',"sap/m/P13nFilterItem","sap/viz/ui5/controls/VizTooltip","sap/ui/comp/state/UIState","sap/m/SelectionDetails","sap/m/SelectionDetailsItem","sap/m/SelectionDetailsItemLine"],function(q,l,C,c,D,M,S,B,T,F,I,O,d,f,g,h,V,j,k,m,o,p,r,P,s,t,u,v,w,U,x,y,z){"use strict";var A=V.extend("sap.ui.comp.smartchart.SmartChart",{metadata:{library:"sap.ui.comp",designTime:true,properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},smartFilterId:{type:"string",group:"Misc",defaultValue:null},ignoredFields:{type:"string",group:"Misc",defaultValue:null},requestAtLeastFields:{type:"string",group:"Misc",defaultValue:null},ignoreFromPersonalisation:{type:"string",group:"Misc",defaultValue:null},chartType:{type:"string",group:"Misc",defaultValue:null},ignoredChartTypes:{type:"string",group:"Misc",defaultValue:null},useVariantManagement:{type:"boolean",group:"Misc",defaultValue:true},useChartPersonalisation:{type:"boolean",group:"Misc",defaultValue:true},header:{type:"string",group:"Misc",defaultValue:null},persistencyKey:{type:"string",group:"Misc",defaultValue:null},currentVariantId:{type:"string",group:"Misc",defaultValue:null},enableAutoBinding:{type:"boolean",group:"Misc",defaultValue:false},chartBindingPath:{type:"string",group:"Misc",defaultValue:null},showDrillButtons:{type:"boolean",group:"Misc",defaultValue:true},showZoomButtons:{type:"boolean",group:"Misc",defaultValue:true},showSemanticNavigationButton:{type:"boolean",group:"Misc",defaultValue:true},showVariantManagement:{type:"boolean",group:"Misc",defaultValue:true},showDownloadButton:{type:"boolean",group:"Misc",defaultValue:false},showDetailsButton:{type:"boolean",group:"Misc",defaultValue:false},showDrillBreadcrumbs:{type:"boolean",group:"Misc",defaultValue:false},showChartTooltip:{type:"boolean",group:"Misc",defaultValue:true},showLegendButton:{type:"boolean",group:"Misc",defaultValue:true},legendVisible:{type:"boolean",group:"Misc",defaultValue:true},selectionMode:{type:"sap.chart.SelectionMode",group:"Misc",defaultValue:sap.chart.SelectionMode.Multi},showFullScreenButton:{type:"boolean",group:"Misc",defaultValue:true},useTooltip:{type:"boolean",group:"Misc",defaultValue:true},useListForChartTypeSelection:{type:"boolean",group:"Misc",defaultValue:true},showChartTypeSelectionButton:{type:"boolean",group:"Misc",defaultValue:true},noData:{type:"string",group:"Misc",defaultValue:""},uiState:{type:"sap.ui.comp.state.UIState"}},associations:{smartVariant:{type:"sap.ui.core.Control",multiple:false}},aggregations:{toolbar:{type:"sap.m.Toolbar",multiple:false},semanticObjectController:{type:"sap.ui.comp.navpopover.SemanticObjectController",multiple:false},selectionDetailsItemActions:{type:"sap.ui.core.Item",multiple:true},selectionDetailsActions:{type:"sap.ui.core.Item",multiple:true},selectionDetailsActionGroups:{type:"sap.ui.core.Item",multiple:true}},events:{initialise:{},beforeRebindChart:{},dataReceived:{},afterVariantInitialise:{},afterVariantSave:{parameters:{currentVariantId:{type:"string"}}},afterVariantApply:{parameters:{currentVariantId:{type:"string"}}},showOverlay:{},fullScreenToggled:{parameters:{fullScreen:{type:"boolean"}}},selectionDetailsActionPress:{parameters:{action:{type:"sap.ui.core.Item"},itemContexts:{type:"sap.ui.model.Context"},level:{type:"sap.m.SelectionDetailsActionLevel"}}}}},renderer:j.render});A.prototype.init=function(){sap.m.FlexBox.prototype.init.call(this);this.addStyleClass("sapUiCompSmartChart");this.setFitContainer(true);this._bUpdateToolbar=true;this._oChartTypeModel=null;this.setHeight("100%");var a=new sap.ui.model.json.JSONModel({items:[]});this.setModel(a,"$smartChartTypes");this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this._processResizeHandler(true);if(!this.getLayoutData()){this.setLayoutData(new sap.m.FlexItemData({growFactor:1,baseSize:"50em"}));}};A.prototype._getVariantManagementControl=function(a){var b=null;if(a){if(typeof a==='string'){b=sap.ui.getCore().byId(a);}else{b=a;}if(b){if(!(b instanceof o)){q.sap.log.error("Control with the id="+typeof a.getId=="function"?a.getId():a+" not of expected type");return null;}}}return b;};A.prototype._createVariantManagementControl=function(){if(this._oVariantManagement||(!this.getUseVariantManagement()&&!this.getUseChartPersonalisation())||!this.getPersistencyKey()){return;}var a=new sap.ui.comp.smartvariants.PersonalizableInfo({type:"chart",keyName:"persistencyKey",dataSource:this.getEntitySet()});a.setControl(this);var b=this.getSmartVariant();if(b){this._oVariantManagement=this._getVariantManagementControl(b);}else if(this._oSmartFilter&&this._oSmartFilter.data("pageVariantPersistencyKey")){b=this._oSmartFilter.getSmartVariant();if(b){this._oVariantManagement=this._getVariantManagementControl(b);}}else{this._oVariantManagement=new o(this.getId()+"-variant",{showShare:true});}if(this._oVariantManagement){if(!this._oVariantManagement.isPageVariant()){this._oVariantManagement.setVisible(this.getShowVariantManagement());}this._oVariantManagement.addPersonalizableControl(a);this._oVariantManagement.attachSave(this._variantSaved,this);this._oVariantManagement.attachAfterSave(this._variantAfterSave,this);this._oVariantManagement.initialise(this._variantInitialised,this);}};A.prototype._variantInitialised=function(){if(!this._oCurrentVariant){this._oCurrentVariant="STANDARD";}this.fireAfterVariantInitialise();if(this._oVariantManagement&&!this._oVariantManagement.getEnabled()){this._checkAndTriggerBinding();}};A.prototype._variantSaved=function(){if(this._oPersController){this._oPersController.setPersonalizationData(this._oCurrentVariant);}};A.prototype._variantAfterSave=function(){this.fireAfterVariantSave({currentVariantId:this.getCurrentVariantId()});};A.prototype.setUseChartPersonalisation=function(b){this.setProperty("useChartPersonalisation",b,true);this._bUpdateToolbar=true;};A.prototype.setUseTooltip=function(b){this.setProperty("useTooltip",b,true);this._createTooltipOrPopover();};A.prototype._createTooltipOrPopover=function(){if(this.getUseTooltip()&&this.getShowChartTooltip()){this._toggleChartTooltipVisibility(true);}else{this._createPopover();}};A.prototype._createPopover=function(){if(this._oChart){if(!this._oPopover){q.sap.require("sap.viz.ui5.controls.Popover");this._oPopover=new sap.viz.ui5.controls.Popover({});}this._oPopover.connect(this._oChart.getVizUid());}};A.prototype._destroyPopover=function(){if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};A.prototype.setUseVariantManagement=function(b){this.setProperty("useVariantManagement",b,true);if(this._oPersController){this._oPersController.setResetToInitialTableState(!b);}this._bUpdateToolbar=true;};A.prototype.setToolbar=function(a){if(this._oToolbar){this.removeItem(this._oToolbar);}this._oToolbar=a;this._bUpdateToolbar=true;};A.prototype.getToolbar=function(){return this._oToolbar;};A.prototype.setHeader=function(a){this.setProperty("header",a,true);this._refreshHeaderText();};A.prototype._refreshHeaderText=function(){if(!this._headerText){this._bUpdateToolbar=true;return;}var a=this.getHeader();this._headerText.setText(a);};A.prototype._createToolbar=function(){if(!this._oToolbar){this._oToolbar=new O({design:g.Transparent,height:"auto"});this._oToolbar.addStyleClass("sapUiCompSmartChartToolbar");}this._oToolbar.setLayoutData(new sap.m.FlexItemData({shrinkFactor:0}));this.insertItem(this._oToolbar,0);};A.prototype._createToolbarContent=function(){this._addDrillBreadcrumbs();this._addVariantManagementToToolbar();this._addSeparatorToToolbar();this._addHeaderToToolbar();this._addSpacerToToolbar();this._addSemanticNavigationButton();this._addDetailsButton();this._addDrillUpDownButtons();this._addLegendButton();this._addZoomInOutButtons();this._addDownloadButton();this._addPersonalisationToToolbar();this._addFullScreenButton();this._addChartTypeToToolbar();if(this._oToolbar&&(this._oToolbar.getContent().length===0||(this._oToolbar.getContent().length===1&&this._oToolbar.getContent()[0]instanceof h))){this.removeItem(this._oToolbar);this._oToolbar.destroy();this._oToolbar=null;}};A.prototype.setShowVariantManagement=function(b){this.setProperty("showVariantManagement",b);if(this._oVariantManagement&&this._oVariantManagement.isPageVariant()){this._oVariantManagement.setVisible(b);}};A.prototype.setShowDetailsButton=function(b){this.setProperty("showDetailsButton",b);if(this._oSelectionDetails){this._oSelectionDetails.setVisible(b);if(this._oDrillDownTextButton){this._oDrillDownTextButton.setVisible(b);}this._oChart.setVizProperties({"interaction":{"behaviorType":this._getBehaviorTypeForDataSelection()}});}if(this._oDrillDownButton){this._oDrillDownButton.setVisible(!b);}};A.prototype.setShowChartTypeSelectionButton=function(b){this.setProperty("showChartTypeSelectionButton",b);if(this._oChartTypeButton){this._oChartTypeButton.setVisible(b);}};A.prototype.setShowDownloadButton=function(b){this.setProperty("showDownloadButton",b);if(this._oDownloadButton){this._oDownloadButton.setVisible(b);}};A.prototype.setShowDrillBreadcrumbs=function(b){this.setProperty("showDrillBreadcrumbs",b);if(this._oDrillBreadcrumbs){this._oDrillBreadcrumbs.setVisible(b);}if(this._oDrillUpButton){this._oDrillUpButton.setVisible(!b);}};A.prototype.setShowChartTooltip=function(b){this.setProperty("showChartTooltip",b);this._toggleChartTooltipVisibility(b);};A.prototype._getBehaviorTypeForDataSelection=function(){if(this.getShowDetailsButton()){return"noHoverBehavior";}else{return null;}};A.prototype._addDrillBreadcrumbs=function(){if(!this._oDrillBreadcrumbs){q.sap.require("sap.m.Breadcrumbs");q.sap.require("sap.m.Link");this._oDrillBreadcrumbs=new sap.m.Breadcrumbs(this.getId()+"-drillBreadcrumbs",{visible:this.getShowDrillBreadcrumbs()}).addStyleClass("sapUiCompSmartChartBreadcrumbs");this._oToolbar.insertContent(this._oDrillBreadcrumbs,0);this._updateDrillBreadcrumbs();this._oChart.attachDrilledUp(function(e){this._updateDrillBreadcrumbs();}.bind(this));this._oChart.attachDrilledDown(function(e){this._updateDrillBreadcrumbs();}.bind(this));}};A.prototype.getDrillStackFilters=function(){var a=this.getChart().getDrillStack();var b=[];var e=function(i){if(!i){return;}if(i&&i.sPath&&i.sOperator){b.push(i);}if(i.aFilters){i.aFilters.forEach(function(n){e(n);});}};a.forEach(function(i){e(i.filter);});return b;};A.prototype._updateDrillBreadcrumbs=function(){var a=this._oChart.getDrillStack();if(this._oDrillBreadcrumbs&&this._oDrillBreadcrumbs.getLinks()){this._oDrillBreadcrumbs.removeAllLinks();}a.reverse();a.forEach(function(b,i,e){if(b.dimension.length>0&&typeof this._oChart.getDimensionByName(b.dimension[b.dimension.length-1])!='undefined'){var n=this._oChart.getDimensionByName(b.dimension[b.dimension.length-1]).getLabel();if(i==0){this._oDrillBreadcrumbs.setCurrentLocationText(n);}else{var G=new sap.m.Link({text:n,press:function(H){var L=this._oDrillBreadcrumbs.indexOfLink(H.getSource());this._oChart.drillUp(L+1);this._oChart.fireDeselectData(H);this._updateDrillBreadcrumbs();}.bind(this)});this._oDrillBreadcrumbs.insertLink(G);}}}.bind(this));};A.prototype._addDetailsButton=function(){this._oSelectionDetails=new x(this.getId()+"-selectionDetails",{visible:this.getShowDetailsButton()});this._oSelectionDetails.registerSelectionDetailsItemFactory([],function(a,b,e,n){var L=[];for(var i=0;i<a.length;i++){L.push(new z({label:a[i].label,value:a[i].value,unit:a[i].unit}));}return new y({enableNav:(function(){if(this._determineSemanticObjectsforDetailsPopover(b,e).length>0){return true;}else{return false;}}.bind(this)()),lines:L}).setBindingContext(e);}.bind(this));this._oSelectionDetails.attachNavigate(function(e){if(e.getParameter("direction")==="back"){e.getParameter("content").destroy();}else{this._navigateToSemanticObjectDetails(e);}}.bind(this));this._oSelectionDetails.attachActionPress(function(e){var i=[];e.getParameter("items").forEach(function(a){i.push(a.getBindingContext());});this.fireSelectionDetailsActionPress({id:e.getParameter("id"),action:e.getParameter("action"),itemContexts:i,level:e.getParameter("level")});}.bind(this));this._oSelectionDetails.attachSelectionHandler("_selectionDetails",this._oChart);this._oSelectionDetails.attachBeforeOpen(function(e){var a=this._oSelectionDetails.getItems();a.forEach(function(i){var b=this._getDetailsActionsClones();b.selectionDetailsItemActions.forEach(function(n){i.addAction(n);});}.bind(this));var b=this._getDetailsActionsClones().selectionDetailsActions;this._oSelectionDetails.removeAllActions();b.forEach(function(i){this._oSelectionDetails.addAction(i);}.bind(this));var G=this._getDetailsActionsClones().selectionDetailsActionGroups;this._oSelectionDetails.removeAllActionGroups();G.forEach(function(i){this._oSelectionDetails.addActionGroup(i);}.bind(this));}.bind(this));this._oSelectionDetails.attachBeforeClose(function(e){if(this._oNavigationContainer){this._oNavigationContainer.destroy();}}.bind(this));this._oToolbar.addContent(this._oSelectionDetails);this._addDrillDownTextButton();};A.prototype._getDetailsActionsClones=function(){var a={selectionDetailsItemActions:[],selectionDetailsActions:[],selectionDetailsActionGroups:[]};this.getSelectionDetailsItemActions().forEach(function(i){a.selectionDetailsItemActions.push(i.clone());});this.getSelectionDetailsActions().forEach(function(i){a.selectionDetailsActions.push(i.clone());});this.getSelectionDetailsActionGroups().forEach(function(i){a.selectionDetailsActionGroups.push(i.clone());});return a;};A.prototype._addDownloadButton=function(){if(!this._oDownloadButton){this._oDownloadButton=new d(this.getId()+"btnDownload",{type:"Transparent",text:this._oRb.getText("CHART_DOWNLOADBTN_TEXT"),tooltip:this._oRb.getText("CHART_DOWNLOADBTN_TOOLTIP"),icon:"sap-icon://download",visible:this.getShowDownloadButton(),press:function(e){if(window.navigator&&window.navigator.msSaveOrOpenBlob){var a=new window.Blob([this._getVizFrame().exportToSVGString()],{'type':"image/svg+xml"});window.navigator.msSaveOrOpenBlob(a);}else{this._downloadChartPNG();}}.bind(this)});this._oToolbar.addContent(this._oDownloadButton);}};A.prototype._downloadChartSVG=function(){var a=this.getHeader();var b=document.createElement('a');b.setAttribute('href','data:image/svg+xml,'+encodeURIComponent(this._getVizFrame().exportToSVGString()));b.setAttribute('download',a?a:'Chart'+'.svg');b.click();};A.prototype._downloadChartPNG=function(){var a=this.getHeader();var b=this._getVizFrame().exportToSVGString();var e=document.createElement('canvas');var i=e.getContext('2d');var n=new Image();n.width=e.width=document.getElementById(this._oChart.getId()).offsetWidth;n.height=e.height=document.getElementById(this._oChart.getId()).offsetHeight;n.onload=function(){i.drawImage(n,0,0);var G=document.createElement('a');G.setAttribute('href',e.toDataURL());G.setAttribute('download',a?a:'Chart'+'.png');G.click();};n.setAttribute('crossOrigin','anonymous');n.src='data:image/svg+xml,'+encodeURIComponent(b);};A.prototype._addFullScreenButton=function(){var a;if(this.getShowFullScreenButton()){a=new d(this.getId()+"-btnFullScreen",{type:"Transparent",press:function(){this._toggleFullScreen(!this.bFullScreen);}.bind(this)});this.oFullScreenButton=a;this._renderFullScreenButton();this._oToolbar.addContent(a);}};A.prototype._addZoomInOutButtons=function(){var a=this;this._oZoomInButton=new d(this.getId()+"-btnZoomIn",{type:"Transparent",text:this._oRb.getText("CHART_ZOOMINBTN_TEXT"),tooltip:this._oRb.getText("CHART_ZOOMINBTN_TOOLTIP"),icon:"sap-icon://zoom-in",press:function(){if(a._oChart){a._oChart.zoom({direction:"in"});}},visible:this.getShowZoomButtons()});this._oZoomOutButton=new d(this.getId()+"-btnZoomOut",{type:"Transparent",text:this._oRb.getText("CHART_ZOOMOUTBTN_TEXT"),tooltip:this._oRb.getText("CHART_ZOOMOUTBTN_TOOLTIP"),icon:"sap-icon://zoom-out",press:function(){if(a._oChart){a._oChart.zoom({direction:"out"});}},visible:this.getShowZoomButtons()});this._oToolbar.addContent(this._oZoomInButton);this._oToolbar.addContent(this._oZoomOutButton);};A.prototype.setShowZoomButtons=function(b){this.setProperty("showZoomButtons",b);if(this._oZoomInButton){this._oZoomInButton.setVisible(b);}if(this._oZoomOutButton){this._oZoomOutButton.setVisible(b);}};A.prototype.setShowFullScreenButton=function(b){this.setProperty("showFullScreenButton",b);if(this.oFullScreenButton){this.oFullScreenButton.setVisible(b);}};A.prototype.setLegendVisible=function(b){this.setProperty("legendVisible",b);this._setLegendVisible(b);};A.prototype._setLegendVisible=function(b){var a=this._getVizFrame();if(a){a.setLegendVisible(b);}};A.prototype._getVizFrame=function(){var a=null;if(this._oChart){a=this._oChart.getAggregation("_vizFrame");}return a;};A.prototype._addLegendButton=function(){var a=this;this._oLegendButton=new d(this.getId()+"-btnLegend",{type:"Transparent",text:this._oRb.getText("CHART_LEGENDBTN_TEXT"),tooltip:this._oRb.getText("CHART_LEGENDBTN_TOOLTIP"),icon:"sap-icon://legend",press:function(){a.setLegendVisible(!a.getLegendVisible());},visible:this.getShowLegendButton()});this._oToolbar.addContent(this._oLegendButton);};A.prototype.setShowLegendButton=function(b){this.setProperty("showLegendButton",b);if(this._oLegendButton){this._oLegendButton.setVisible(b);}};A.prototype.setShowSemanticNavigationButton=function(b){this.setProperty("showSemanticNavigationButton",b);if(this._oSemanticalNavButton){this._oSemanticalNavButton.setVisible(b);}else{if(b){this._addSemanticNavigationButton();}}};A.prototype._addSemanticNavigationButton=function(){var a=this,b;if(!this._oSemanticalNavButton&&this.getShowSemanticNavigationButton()&&this._oToolbar){this._oSemanticalNavButton=new B(this.getId()+"-btnNavigation",{type:"Transparent",text:this._oRb.getText("CHART_SEMNAVBTN"),tooltip:this._oRb.getText("CHART_SEMNAVBTN_TOOLTIP"),visible:this.getShowSemanticNavigationButton(),enabled:false});q.sap.require("sap.ui.comp.navpopover.NavigationPopoverHandler");var n=new sap.ui.comp.navpopover.NavigationPopoverHandler({control:this._oSemanticalNavButton});var e=this.getSemanticObjectController();if(e){n.setSemanticObjectController(e);}this._oSemanticalNavButton.attachPress(function(G){if(b&&(b.length>0)){if(b.length===1){var H=u.getSemanticObjectsFromProperty(b[0]);if(H){n.setFieldName(b[0].name);n.setSemanticObject(H.defaultSemanticObject);n.setAdditionalSemanticObjects(H.additionalSemanticObjects);n.openPopover();}}else{a._semanticObjectList(b,n);}}});if(this._oChart){this._oChart.attachDeselectData(function(){b=a._setSelectionDataPointHandling(n);});this._oChart.attachSelectData(function(){b=a._setSelectionDataPointHandling(n);});}var i=this._indexOfSpacerOnToolbar();this._oToolbar.insertContent(this._oSemanticalNavButton,i+1);}};A.prototype.setSelectionMode=function(a){this.setProperty("selectionMode",a);if(this._oChart){this._oChart.setSelectionMode(a);}};A.prototype._setSelectionDataPointHandling=function(n){var a=this._setSelectionDataPoint(n);if(a&&a.length>0){this._oSemanticalNavButton.setEnabled(true);}else{this._oSemanticalNavButton.setEnabled(false);}return a;};A.prototype._setSemanticObjectsContext=function(e){var a,b,i=null;a=e.getParameter("item").getBindingContext();if(a){b=a.getObject();if(b){i=this._determineSemanticObjectsforDetailsPopover(b,a);}}return i;};A.prototype._setSelectionDataPoint=function(n){var a,b,e=null,G;var H=this._oChart.getSelectedDataPoints();if(!H||!H.dataPoints||(H.dataPoints.length===0)){return e;}if(H.dataPoints.length===1){a=H.dataPoints[0].context;if(a){b=a.getObject();if(b){e=this._determineSemanticObjects(b,a);if(e&&(e.length>0)){n.setBindingContext(a);}}}return e;}G=[];for(var i=0;i<H.dataPoints.length;i++){a=H.dataPoints[i].context;if(a){b=a.getObject();if(b){G.push(b);}}}if(G&&G.length>0){e=this._condensBasedOnSameValue(G);if(e&&e.length>0){n.setBindingContext(H.dataPoints[H.dataPoints.length-1].context);}}return e;};A.prototype._condensBasedOnSameValue=function(a){var b=null,R,e,n;b=this._determineSemanticObjects(a[0]);if(b&&b.length>0){for(var i=0;i<b.length;i++){e=b[i];n=e.name;if(this._bAllValuesAreEqual(a,n)){if(!R){R=[];}R.push(e);}}b=R;}return b;};A.prototype._bAllValuesAreEqual=function(a,b){var e,n;for(var i=0;i<a.length;i++){e=a[i];if(i===0){n=e[b];continue;}if(n!=e[b]){return false;}}return true;};A.prototype._semanticObjectList=function(a,n){var b,L,e,G;if(this._oChart){L=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,selectionChange:function(H){if(H&&H.mParameters&&H.mParameters.listItem){var J=H.mParameters.listItem.data("semObj");if(J){n.setFieldName(H.mParameters.listItem.data("fieldName"));n.setSemanticObject(J.defaultSemanticObject);n.setAdditionalSemanticObjects(J.additionalSemanticObjects);n.openPopover();}}b.close();}});for(var i=0;i<a.length;i++){G=a[i];e=new sap.m.StandardListItem({title:G.fieldLabel,type:sap.m.ListType.Active});e.data("semObj",u.getSemanticObjectsFromProperty(G));e.data("fieldName",G.name);L.addItem(e);}b=new sap.m.ResponsivePopover({title:this._oRb.getText("CHART_SEMNAVBTN"),showHeader:false,contentWidth:"12rem",placement:sap.m.PlacementType.Left});b.addContent(L);b.openBy(this._oSemanticalNavButton);}};A.prototype._semanticObjectListForDetails=function(a,b){var L,e,n;var G=this;if(this._oChart){L=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,rememberSelections:false,itemPress:function(H){if(H&&H.mParameters&&H.mParameters.listItem){var J=H.mParameters.listItem.data("semObj");if(J){var N=new sap.ui.comp.navpopover.NavigationPopoverHandler({fieldName:H.mParameters.listItem.data("fieldName"),control:H.mParameters.listItem,semanticObject:J.defaultSemanticObject,additionalSemanticObjects:J.additionalSemanticObjects});N._getNavigationContainer().then(function(K){G._oNavigationContainer=K;K.attachAvailableActionsPersonalizationPress(G._onAvailableActionsPersonalizationPress,G);this._oSelectionDetails.navTo("PlaceHeader",K);}.bind(this),function(K){q.sap.log.error("NavigationContainer could not be determined");});}}}.bind(this)});for(var i=0;i<a.length;i++){n=a[i];e=new sap.m.StandardListItem({title:n.fieldLabel,type:sap.m.ListType.Navigation});e.setBindingContext(b);e.data("semObj",u.getSemanticObjectsFromProperty(n));e.data("fieldName",n.name);L.addItem(e);}return L;}};A.prototype._onAvailableActionsPersonalizationPress=function(e){var n=e.getSource();this._oSelectionDetails.setPopoverModal(true);n.openSelectionDialog(false,true,undefined,true).then(function(){this._oSelectionDetails.setPopoverModal(false);}.bind(this));};A.prototype._determineSemanticObjects=function(e,i){var n,G,H=[];if(e){for(n in e){if(n){G=this._getField(n);if(G&&G.isDimension&&G.isSemanticObject){H.push(G);}}}}if(H){H.sort(function(a,b){return a.fieldLabel.localeCompare(b.fieldLabel);});}return H;};A.prototype._determineSemanticObjectsforDetailsPopover=function(e,i){var n,G,H=[];if(e){for(n in e){if(n){G=this._getField(n);if(G&&G.isDimension&&G.isSemanticObject){H.push(G);}}}}if(H){H.sort(function(a,b){return a.fieldLabel.localeCompare(b.fieldLabel);});}return H;};A.prototype._addDrillUpDownButtons=function(){if(this.getShowDrillButtons()){var a=this;this._oDrillUpButton=new d(this.getId()+"-btnDrillUp",{type:"Transparent",tooltip:this._oRb.getText("CHART_DRILLUPBTN_TOOLTIP"),text:this._oRb.getText("CHART_DRILLUPBTN_TEXT"),icon:"sap-icon://drill-up",press:function(){if(a._oChart){a._oChart.drillUp();}},visible:!this.getShowDrillBreadcrumbs()});this._oDrillDownButton=new d(this.getId()+"-btnDrillDown",{type:"Transparent",tooltip:this._oRb.getText("CHART_DRILLDOWNBTN_TOOLTIP"),text:this._oRb.getText("CHART_DRILLDOWNBTN_TEXT"),icon:"sap-icon://drill-down",press:function(e){a._drillDown(e);},visible:!this.getShowDetailsButton()});this._oToolbar.addContent(this._oDrillUpButton);this._oToolbar.addContent(this._oDrillDownButton);}};A.prototype._addDrillDownTextButton=function(){this._oDrillDownTextButton=new B(this.getId()+"-btnDrillDownText",{type:"Transparent",text:this._oRb.getText("CHART_DRILLDOWNBTN_TEXT"),tooltip:this._oRb.getText("CHART_DRILLDOWNBTN_TOOLTIP"),layoutData:new sap.m.OverflowToolbarLayoutData({priority:sap.m.OverflowToolbarPriority.NeverOverflow}),enabled:true,visible:this.getShowDetailsButton(),press:function(e){this._drillDown(e);}.bind(this)});this._oToolbar.addContent(this._oDrillDownTextButton);};A.prototype.setShowDrillButtons=function(b){this.setProperty("showDrillButtons",b);if(this._oDrillUpButton){this._oDrillUpButton.setVisible(b);}if(this._oDrillDownButton){this._oDrillDownButton.setVisible(b);}};A.prototype._triggerSearchInPopover=function(e,L){var a,i,b,n,G,H;if(!e||!L){return;}a=e.getParameters();if(!a){return;}G=a.newValue?a.newValue.toLowerCase():"";if(this._oChart){H=L.getItems();for(i=0;i<H.length;i++){n=H[i].getTooltip();b=H[i].getTitle();if((b&&(b.toLowerCase().indexOf(G)>-1))||(n&&(n.toLowerCase().indexOf(G)>-1))){H[i].setVisible(true);}else{H[i].setVisible(false);}}}};A.prototype._drillDown=function(e){var a=this,b,n,G,H,L,J,K,N,i,Q;if(this._oChart){J=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,selectionChange:function(e){if(e&&e.mParameters&&e.mParameters.listItem){if(e.mParameters.listItem.getType()===sap.m.ListType.Inactive){return;}var H=e.mParameters.listItem.data("dim");if(H){a._oChart.drillDown(H);}}b.close();}});K=new sap.m.Bar();N=new sap.m.SearchField({placeholder:this._oRb.getText("CHART_DRILLDOWN_SEARCH")});N.attachLiveChange(function(e){a._triggerSearchInPopover(e,J);});K.addContentRight(N);b=new sap.m.ResponsivePopover({title:this._oRb.getText("CHART_DRILLDOWN_TITLE"),contentWidth:"25rem",contentHeight:"20rem",placement:sap.m.PlacementType.Bottom,subHeader:K});b.addContent(J);n=this._oChart.getVisibleDimensions();G=this._getSortedDimensions();if(G.length<7){K.setVisible(false);}for(i=0;i<G.length;i++){if(n.indexOf(G[i].getName())>-1){continue;}H=G[i];L=new sap.m.StandardListItem({title:H.getLabel(),type:sap.m.ListType.Active});L.data("dim",H);Q=this._getFieldTooltip(H.name);if(Q){L.setTooltip(Q);}if(n.indexOf(G[i].getName())>-1){L.setType(sap.m.ListType.Inactive);}J.addItem(L);}b.openBy(e.getSource());}};A.prototype._navigateToSemanticObjectDetails=function(e){var a=this._setSemanticObjectsContext(e);if(a&&(a.length>0)){if(a.length===1){var b=u.getSemanticObjectsFromProperty(a[0]);if(b){var n=new sap.ui.comp.navpopover.NavigationPopoverHandler({fieldName:a[0].name,control:e.getParameter("item"),semanticObject:b.defaultSemanticObject,additionalSemanticObjects:b.additionalSemanticObjects});n._getNavigationContainer().then(function(N){this._oNavigationContainer=N;N.attachAvailableActionsPersonalizationPress(this._onAvailableActionsPersonalizationPress,this);this._oSelectionDetails.navTo("PlaceHeader",N);}.bind(this),function(G){q.sap.log.error("NavigationContainer could not be determined");});}}else{var i=e.getParameter("item").getBindingContext();var L=this._semanticObjectListForDetails(a,i);this._oSelectionDetails.navTo(this._oRb.getText("CHART_SEMNAVBTN"),L);}}};A.prototype._addHeaderToToolbar=function(){if(this.getHeader()&&this._oToolbar){if(!this._headerText){this._headerText=new T({});this._headerText.addStyleClass("sapMH4Style");this._headerText.addStyleClass("sapUiCompSmartChartHeader");}this._refreshHeaderText();this._oToolbar.insertContent(this._headerText,0);}else if(this._headerText&&this._oToolbar){this._oToolbar.removeContent(this._headerText);}};A.prototype._addSeparatorToToolbar=function(){if(this.getHeader()&&this.getUseVariantManagement()&&this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){this._oSeparator=new f();this._oToolbar.insertContent(this._oSeparator,0);if(!this._oToolbar.getHeight()){this._oToolbar.setHeight("auto");}}else if(this._oSeparator){this._oToolbar.removeContent(this._oSeparator);}};A.prototype._addVariantManagementToToolbar=function(){if(this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){if(this.getUseVariantManagement()){this._oToolbar.insertContent(this._oVariantManagement,0);}else if(this._oVariantManagement){this._oToolbar.removeContent(this._oVariantManagement);}}};A.prototype._addSpacerToToolbar=function(){if(this._indexOfSpacerOnToolbar()===-1){this._oToolbar.addContent(new h());}};A.prototype._indexOfSpacerOnToolbar=function(){var a=this._oToolbar.getContent(),i,L;if(a){L=a.length;i=0;for(i;i<L;i++){if(a[i]instanceof h){return i;}}}return-1;};A.prototype._addPersonalisationToToolbar=function(){if(this.getUseChartPersonalisation()){if(!this._oChartPersonalisationButton){this._oChartPersonalisationButton=new d(this.getId()+"-btnPersonalisation",{type:"Transparent",icon:"sap-icon://action-settings",text:this._oRb.getText("CHART_PERSOBTN_TEXT"),tooltip:this._oRb.getText("CHART_PERSOBTN_TOOLTIP"),press:function(e){this._oPersController.openDialog({dimeasure:{visible:true,payload:{availableChartTypes:this._getAvailableChartTypes()}},sort:{visible:true},filter:{visible:true}});}.bind(this)});}this._oToolbar.addContent(this._oChartPersonalisationButton);}else if(this._oChartPersonalisationButton){this._oToolbar.removeContent(this._oChartPersonalisationButton);}};A.prototype._addChartTypeToToolbar=function(){this._oChartTypeButton=this._createChartTypeButton();this._oToolbar.addContent(this._oChartTypeButton);};A.prototype._createChartTypeButton=function(){var a=new d(this.getId()+"-btnChartType",{visible:this.getShowChartTypeSelectionButton(),type:"Transparent",layoutData:new sap.m.OverflowToolbarLayoutData({priority:sap.m.OverflowToolbarPriority.NeverOverflow}),press:function(e){this._displayChartTypes(e);}.bind(this)});this._enrichPassedButton(a,this._oChart.getChartType());return a;};A.prototype._displayChartTypes=function(e){var a=this,b,L,i,n,G=false;if(this._bAvailableChartListIsOpen){return;}if(this._oChart&&e){var H=e.getSource();var J=new sap.m.StandardListItem({title:"{$smartChartTypes>text}",icon:"{$smartChartTypes>icon}",selected:"{$smartChartTypes>selected}"});L=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,items:{path:"$smartChartTypes>/items",template:J},selectionChange:function(e){if(e&&e.mParameters&&e.mParameters.listItem){var K=e.mParameters.listItem.getBinding("title");if(K){var N=K.getContext();if(N){var Q=N.getObject();if(Q&&Q.key){a._setChartType(Q.key);a._enrichPassedButton(a._oChartTypeButton,a._oChart.getChartType());}}}}G=true;b.close();}});i=new sap.m.Bar();n=new sap.m.SearchField({placeholder:this._oRb.getText("CHART_TYPE_SEARCH")});n.attachLiveChange(function(e){a._triggerSearchInPopover(e,L);});i.addContentRight(n);b=new sap.m.ResponsivePopover({placement:sap.m.PlacementType.Bottom,subHeader:i,showHeader:false,contentWidth:"25rem"});b.attachAfterClose(function(e){if(!G){}a._bAvailableChartListIsOpen=false;});b.setModel(this.getModel("$smartChartTypes"),"$smartChartTypes");b.addContent(L);if(L.getItems().length<7){i.setVisible(false);}this._bAvailableChartListIsOpen=true;b.openBy(H);}};var E={"bar":"sap-icon://horizontal-bar-chart","bullet":"sap-icon://horizontal-bullet-chart","bubble":"sap-icon://bubble-chart","column":"sap-icon://vertical-bar-chart","combination":"sap-icon://business-objects-experience","dual_bar":"sap-icon://horizontal-bar-chart","dual_column":"sap-icon://vertical-bar-chart","dual_combination":"sap-icon://business-objects-experience","dual_horizontal_combination":"sap-icon://business-objects-experience","dual_horizontal_stacked_combination":"sap-icon://business-objects-experience","dual_line":"sap-icon://line-chart","dual_stacked_bar":"sap-icon://full-stacked-chart","dual_stacked_column":"sap-icon://vertical-stacked-chart","dual_stacked_combination":"sap-icon://business-objects-experience","donut":"sap-icon://donut-chart","heatmap":"sap-icon://heatmap-chart","horizontal_stacked_combination":"sap-icon://business-objects-experience","line":"sap-icon://line-chart","pie":"sap-icon://pie-chart","scatter":"sap-icon://scatter-chart","stacked_bar":"sap-icon://full-stacked-chart","stacked_column":"sap-icon://vertical-stacked-chart","stacked_combination":"sap-icon://business-objects-experience","treemap":"sap-icon://Chart-Tree-Map","vertical_bullet":"sap-icon://vertical-bullet-chart","100_dual_stacked_bar":"sap-icon://full-stacked-chart","100_dual_stacked_column":"sap-icon://vertical-stacked-chart","100_stacked_bar":"sap-icon://full-stacked-chart","100_stacked_column":"sap-icon://full-stacked-column-chart","waterfall":"sap-icon://vertical-waterfall-chart","horizontal_waterfall":"sap-icon://horizontal-waterfall-chart"};A.prototype._getMatchingIcon=function(a){var i=E[a];if(!i){i="";}return i;};A.prototype._enrichPassedButton=function(b,K,a){if(!b){return;}if(a===undefined){a=K;var e=this._retrieveChartTypeDescription(K);if(e&&e.text){a=e.text;}}b.data("chartType",K);var i=this._getMatchingIcon(K);b.setIcon(i?i:"sap-icon://vertical-bar-chart");var n=(this._oChart.getChartType()===K)?"CHART_TYPE_TOOLTIP":"CHART_TYPE_UNSEL_TOOLTIP";b.setTooltip(this._oRb.getText(n,[a]));};A.prototype._updateAvailableChartType=function(){var a=this,b,e,i=[];b=this.getModel("$smartChartTypes");if(!b){return;}e={items:i};var n=this._oChart.getChartType();this._getAvailableChartTypes().forEach(function(G){var H={key:G.key,text:G.text,icon:a._getMatchingIcon(G.key),selected:n===G.key};i.push(H);});b.setData(e);if(this._oSegmentedButton){this._updateVisibilityOfChartTypes(this._oSegmentedButton);}};A.prototype._createPersonalizationController=function(){if(this._oPersController){return;}var a=this.data("p13nDialogSettings");if(typeof a==="string"){try{a=JSON.parse(a);}catch(e){a=null;}}a=this._setIgnoreFromPersonalisationToSettings(a);a=a||{};q.sap.require("sap.ui.comp.personalization.Controller");var b=P.createChartWrapper(this._oChart,this._oChart.data("p13nData"));if(this.$()&&this.$().closest(".sapUiSizeCompact").length>0){this._oChart.addStyleClass("sapUiSizeCompact");}this._oPersController=new sap.ui.comp.personalization.Controller({table:b,setting:a,resetToInitialTableState:!this.getUseVariantManagement(),afterP13nModelDataChange:this._personalisationModelDataChange.bind(this)});this._oPersController.attachDialogConfirmedReset(function(){if(this._oDrillBreadcrumbs){this._updateDrillBreadcrumbs();}var i=sap.ui.getCore().byId(this.getId()+"-btnChartType");if(i){this._enrichPassedButton(i,this._oChart.getChartType());}}.bind(this));};A.prototype._setIgnoreFromPersonalisationToSettings=function(a){var i=P.createArrayFromString(this.getIgnoreFromPersonalisation());if(i.length){if(!a){a={};}var b=function(e){if(!a[e]){a[e]={};}a[e].ignoreColumnKeys=i;};b("dimeasure");b("filter");b("sort");}return a;};A.prototype._personalisationModelDataChange=function(e){this._oCurrentVariant=e.getParameter("persistentData");var a=e.getParameter("changeType");var b=this._getChangeStatus(a);if(b===sap.ui.comp.personalization.ChangeType.Unchanged){return;}if(!this._bApplyingVariant){if(!this.getUseVariantManagement()){this._persistPersonalisation();}else if(this._oVariantManagement){this._oVariantManagement.currentVariantSetModified(true);}}if(b===sap.ui.comp.personalization.ChangeType.TableChanged){if(this._oCurrentVariant.dimeasure&&this._oCurrentVariant.dimeasure.chartTypeKey){this._updateAvailableChartType();if(this._oChartTypeButton){this._enrichPassedButton(this._oChartTypeButton,this._oChart.getChartType());}}if(this._oSemanticalNavButton){this._oSemanticalNavButton.setEnabled(false);}}else if(b===sap.ui.comp.personalization.ChangeType.ModelChanged&&this._bIsChartBound){if(this._oSmartFilter){this._oSmartFilter.search();}else{this._reBindChart();}}if(this._oDrillBreadcrumbs){this._updateDrillBreadcrumbs();}};A.prototype._getChangeStatus=function(a){if(!a){return sap.ui.comp.personalization.ChangeType.ModelChanged;}if(a.sort===sap.ui.comp.personalization.ChangeType.ModelChanged||a.filter===sap.ui.comp.personalization.ChangeType.ModelChanged||a.dimeasure===sap.ui.comp.personalization.ChangeType.ModelChanged||a.group===sap.ui.comp.personalization.ChangeType.ModelChanged){return sap.ui.comp.personalization.ChangeType.ModelChanged;}if(a.sort===sap.ui.comp.personalization.ChangeType.TableChanged||a.filter===sap.ui.comp.personalization.ChangeType.TableChanged||a.dimeasure===sap.ui.comp.personalization.ChangeType.TableChanged||a.group===sap.ui.comp.personalization.ChangeType.TableChanged){return sap.ui.comp.personalization.ChangeType.TableChanged;}return sap.ui.comp.personalization.ChangeType.Unchanged;};A.prototype.setEntitySet=function(e){this.setProperty("entitySet",e);this._initialiseMetadata();};A.prototype.propagateProperties=function(){V.prototype.propagateProperties.apply(this,arguments);this._initialiseMetadata();};A.prototype._initialiseMetadata=function(){if(!this.bIsInitialised){t.handleModelInit(this,this._onMetadataInitialised);}};A.prototype._onMetadataInitialised=function(){this._bMetaModelLoadAttached=false;if(!this.bIsInitialised){this._createChartProvider();if(this._oChartProvider){this._oChartViewMetadata=this._oChartProvider.getChartViewMetadata();if(this._oChartViewMetadata){this.bIsInitialised=true;this._listenToSmartFilter();this._createVariantManagementControl();this._assignData();this._createContent();this._createToolbarContent();this._createPersonalizationController();this.fireInitialise();if(!this._oVariantManagement||(this._oVariantManagement&&this._bVariantInitialised)){this._checkAndTriggerBinding();}}}}};A.prototype._checkAndTriggerBinding=function(){if(!this._bAutoBindingTriggered){this._bAutoBindingTriggered=true;if(this.getEnableAutoBinding()){if(this._oSmartFilter){this._oSmartFilter.search();}else{this._reBindChart();}}}};A.prototype._createChartProvider=function(){var a,e;e=this.getEntitySet();a=this.getModel();if(a&&!this._bChartCreated){this._aAlwaysSelect=[];this._aInitialSorters=[];this._createToolbar();this._createChart();this._bChartCreated=true;}if(a&&e){this._oChartProvider=new k({entitySet:e,ignoredFields:this.getIgnoredFields(),dateFormatSettings:this.data("dateFormatSettings"),defaultDropDownDisplayBehaviour:this.data("defaultDimensionDisplayBehaviour"),skipAnnotationParse:this.data("skipAnnotationParse"),chartQualifier:this.data("chartQualifier"),presentationVariantQualifier:this.data("presentationVariantQualifier"),model:a});}};A.prototype._listenToSmartFilter=function(){var a=null;a=this.getSmartFilterId();this._oSmartFilter=this._findControl(a);if(this._oSmartFilter){this._oSmartFilter.attachSearch(this._reBindChart,this);this._oSmartFilter.attachFilterChange(this._filterChangeEvent,this);this._oSmartFilter.attachCancel(this._cancelEvent,this);}};A.prototype._filterChangeEvent=function(){if(this._bIsChartBound&&this._oSmartFilter&&!this._oSmartFilter.getLiveMode()){this._showOverlay(true);}};A.prototype._cancelEvent=function(){if(this._oSmartFilter&&!this._oSmartFilter.getLiveMode()){this._showOverlay(false);}};A.prototype._renderOverlay=function(b){if(this._oChart){var $=this._oChart.$(),a=$.find(".sapUiCompSmartChartOverlay");if(b&&a.length===0){a=q("<div>").addClass("sapUiOverlay sapUiCompSmartChartOverlay").css("z-index","1");$.append(a);}else if(!b){a.remove();}}};A.prototype.showOverlay=function(b){this._showOverlay(b);};A.prototype._showOverlay=function(b){if(b){var a={show:true};this.fireShowOverlay({overlay:a});b=a.show;}this._hasOverlay=b;this._renderOverlay(b);};A.prototype._findControl=function(i){var R,a;if(i){R=sap.ui.getCore().byId(i);if(!R){a=this._getView();if(a){R=a.byId(i);}}}return R;};A.prototype._getView=function(){if(!this._oView){var a=this.getParent();while(a){if(a instanceof sap.ui.core.mvc.View){this._oView=a;break;}a=a.getParent();}}return this._oView;};A.prototype._updateInResultDimensions=function(){var a=this._getInResultDimensionTotal();this.getChart().setInResultDimensions(a);};A.prototype.rebindChart=function(){this._reBindChart();};A.prototype._reBindChart=function(){var a,b,e=[],i,n,G,H={},J={preventChartBind:false};a=this._getChartPersonalisationData()||{};i=a.filters;n=a.excludeFilters;G=a.sorters;if(this._oSmartFilter){b=this._oSmartFilter.getFilters();H=this._oSmartFilter.getParameters()||{};}if(b&&b.length){if(n){e=[new sap.ui.model.Filter([b[0],n],true)];}else{e=b;}}else if(n){e=[n];}if(i){i=e.concat(i);}else{i=e;}this._updateInResultDimensions();H["entitySet"]=this.getEntitySet();if(!G){G=[];}J.filters=i;J.sorter=G;J.parameters=H;this.fireBeforeRebindChart({bindingParams:J});if(!J.preventChartBind){G=J.sorter;i=J.filters;this._oChart.setBusy(true);this._bDataLoadPending=true;var K={path:this.getChartBindingPath()||("/"+this.getEntitySet()),parameters:H,filters:i,sorter:G,events:{dataReceived:function(N){if(N&&N.getParameter&&N.getParameter("__simulateAsyncAnalyticalBinding")){return;}this._onDataLoadComplete(N,true);this.fireDataReceived(N);}.bind(this),change:this._onDataLoadComplete.bind(this)}};if(J.length){K.length=Math.min(J.length,100);}else{var L=this._oChartProvider.getMaxItems();if(L>0){K.length=L;}}this._oChart.bindData(K);this._showOverlay(false);this._bIsChartBound=true;}};A.prototype._onDataLoadComplete=function(e,b){if(this._oSemanticalNavButton){this._oSemanticalNavButton.setEnabled(false);}if(this._bDataLoadPending||b){this._bDataLoadPending=false;this._updateAvailableChartType();this._oChart.setBusy(false);}};A.prototype._assignData=function(){if(this._oChartViewMetadata&&this._oChart){if(this._oChartViewMetadata.measureFields&&(this._oChartViewMetadata.measureFields.length>0)){this._oChart.setVisibleMeasures(this._oChartViewMetadata.measureFields);}if(this._oChartViewMetadata.dimensionFields&&(this._oChartViewMetadata.dimensionFields.length>0)){this._oChart.setVisibleDimensions(this._oChartViewMetadata.dimensionFields);}if(!this.getChartType()&&this._oChartViewMetadata.chartType){this._setChartType(this._oChartViewMetadata.chartType);}}};A.prototype._createP13nObject=function(a){if(a.sortable&&a.sorted){var b={columnKey:a.name,operation:a.sortOrder};this._aInitialSorters.push(b);}return{columnKey:a.name,leadingProperty:a.name,additionalProperty:a.additionalProperty,sortProperty:a.sortable?a.name:undefined,filterProperty:a.filterable?a.name:undefined,type:a.filterType,maxLength:a.maxLength,precision:a.precision,scale:a.scale,isMeasure:a.isMeasure,isDimension:a.isDimension,aggregationRole:a.aggregationRole,label:a.fieldLabel,tooltip:a.quickInfo,sorted:a.sorted,sortOrder:a.sortOrder};};A.prototype._createContent=function(){q.sap.require("sap.ui.comp.util.FormatUtil");var i,L=0,a,b,e,n=[],G,H=this;var J=[];L=this._oChartViewMetadata.fields.length;for(i=0;i<L;i++){b=null;a=this._oChartViewMetadata.fields[i];if(this.getChart().getDimensionByName(a.name)===undefined&&this.getChart().getMeasureByName(a.name)===undefined){G=this._createP13nObject(a);e={name:a.name,label:a.fieldLabel};}if(a.inResult){this._aAlwaysSelect.push(a.name);}if(a.isDimension){if(this.getChart().getDimensionByName(a.name)===undefined){b=new D(e);this._oChart.addDimension(b);if(a.description){b.setTextProperty(a.description);b.setTextFormatter(function(N,Q){var R=this.getIdentity();var W=H._getDisplayBehaviour(R);return sap.ui.comp.util.FormatUtil.getFormattedExpressionFromDisplayBehaviour(W,N,Q);});}else if(a.dateFormatter){b.setTextFormatter(a.dateFormatter);}}else{var K=this.getChart().getDimensionByName(a.name).data("p13nData");if(K){this.getChart().getDimensionByName(a.name).data("p13nData",typeof K==="string"?JSON.parse(K):K);}}}else if(a.isMeasure){if(this.getChart().getMeasureByName(a.name)===undefined){b=new M(e);this._oChart.addMeasure(b);if(a.dataPoint){J.push({dataPoint:a.dataPoint,measure:b});}if(a.unit){b.setUnitBinding(a.unit);}}else{var K=this.getChart().getMeasureByName(a.name).data("p13nData");if(K){this.getChart().getMeasureByName(a.name).data("p13nData",typeof K==="string"?JSON.parse(K):K);}}}else if(a.sortable||a.filterable){n.push(G);}if(b){if(a.role){b.setRole(a.role);}b.data("p13nData",G);}}if(this._oChart){this._oChart.data("p13nData",n);}if(J.length>0){this._enrichFromDataPoints(J);}};A.prototype._getDisplayBehaviour=function(n){var a=this._getField(n);if(a){return a.displayBehaviour;}return"";};A.prototype._getField=function(n){var a,i,L;if(n&&this._oChartViewMetadata&&this._oChartViewMetadata.fields){L=this._oChartViewMetadata.fields.length;for(i=0;i<L;i++){a=this._oChartViewMetadata.fields[i];if(a.name===n){return a;}}}return null;};A.prototype._createChart=function(){var a=this.getItems(),L=a?a.length:0,b;while(L--){b=a[L];if(b instanceof C){break;}b=null;}if(b){this._oChart=b;}else{this._oChart=new C({uiConfig:{applicationSet:'fiori'},vizProperties:{title:{text:''},interaction:{behaviorType:this._getBehaviorTypeForDataSelection()},plotArea:{dataLabel:{hideWhenOverlap:false}},categoryAxis:{layout:{autoHeight:true,autoWidth:true}}},selectionMode:this.getSelectionMode(),width:"100%"});this._toggleChartTooltipVisibility(this.getShowChartTooltip());this.insertItem(this._oChart,2);}if(!this._oChart.getLayoutData()){var e={growFactor:1};var i=this.getLayoutData();var n=null;if(i&&i.getBaseSize){n=i.getBaseSize();}if(n){e.baseSize="100%";}this._oChart.setLayoutData(new sap.m.FlexItemData(e));}if(this.getChartType()){this._setChartType(this.getChartType());}this._oChart.attachRenderComplete(function(){if(this._hasOverlay){setTimeout(function(){this._showOverlay(true);}.bind(this),0);}}.bind(this));this._createTooltipOrPopover();};A.prototype._toggleChartTooltipVisibility=function(b){if(this._oChart){if(b){if(!this._vizTooltip){this._vizTooltip=new w();}this._vizTooltip.connect(this.getChart().getVizUid());}else{if(this._vizTooltip){this._vizTooltip.destroy();}}}};A.prototype._updateVizTooltipFormatter=function(){if(this._vizTooltip){if(this.getChart().getChartType().match(/100/)!==null){this._vizTooltip.setFormatString(sap.viz.ui5.format.ChartFormatter.DefaultPattern.PERCENT);}else{this._vizTooltip.setFormatString(sap.viz.ui5.format.ChartFormatter.DefaultPattern.STANDARDFLOAT);}}};A.prototype.getChart=function(){return this._oChart;};A.prototype._getChartTypes=function(){var a;try{a=sap.chart.api.getChartTypes();}catch(e){a={};q.sap.log.error("sap.chart.api..getChartTypes throws an exception.\n"+e.toString());}return a;};A.prototype._getAvailableChartTypes=function(){var i,K,a=[],b,e={},n;if(this._oChart){n=P.createArrayFromString(this.getIgnoredChartTypes());e=this._getChartTypes();b=this._oChart.getAvailableChartTypes().available;if(b){for(i=0;i<b.length;i++){K=b[i].chart;if(n.indexOf(K)<0){a.push({key:K,text:e[K]});}}}}return a;};A.prototype._getAllChartTypes=function(){var K,a=[],b,i;i=P.createArrayFromString(this.getIgnoredChartTypes());b=this._getChartTypes();for(K in b){if(K){if(i.indexOf(K)<0){a.push({key:K,text:b[K]});}}}return a;};A.prototype._retrieveChartTypeDescription=function(a){var b=this._getChartTypes();return({key:a,text:b[a]});};A.prototype._setChartType=function(a){if(this._oChart){this._oChart.setChartType(a);this._aDetailsEntries=[];this._updateVizTooltipFormatter();}};A.prototype._getDimensions=function(){var a=[];if(this._oChart){a=this._oChart.getDimensions();}return a;};A.prototype._getVisibleDimensions=function(){var a=[];if(this._oChart){a=this._oChart.getVisibleDimensions();}return a;};A.prototype._getMeasures=function(){var a=[];if(this._oChart){a=this._oChart.getMeasures();}return a;};A.prototype._getVisibleMeasures=function(){var a=[];if(this._oChart){a=this._oChart.getVisibleMeasures();}return a;};A.prototype._getSortedDimensions=function(){var e=[];if(this._oChart){e=this._oChart.getDimensions();if(e){e.sort(function(a,b){if(a.getLabel()&&b.getLabel()){return a.getLabel().localeCompare(b.getLabel());}});}}return e;};A.prototype.fetchVariant=function(){if(this._oCurrentVariant==="STANDARD"||this._oCurrentVariant===null){return{};}return this._oCurrentVariant;};A.prototype.applyVariant=function(a,b){this._oCurrentVariant=a;if(this._oCurrentVariant==="STANDARD"){this._oCurrentVariant=null;}if(b==="STANDARD"){this._oApplicationDefaultVariant=this._oCurrentVariant;}if(this._oApplicationDefaultVariant&&!b){this._oCurrentVariant=q.extend(true,{},this._oApplicationDefaultVariant,a);}this._bApplyingVariant=true;if(this._oPersController){if(this._oCurrentVariant===null||q.isEmptyObject(this._oCurrentVariant)){this._oPersController.resetPersonalization(sap.ui.comp.personalization.ResetType.ResetFull);}else{this._oPersController.setPersonalizationData(this._oCurrentVariant);}}this._bApplyingVariant=false;this.fireAfterVariantApply({currentVariantId:this.getCurrentVariantId()});};A.prototype.variantsInitialized=function(){this._bVariantInitialised=true;this._checkAndTriggerBinding();};A.prototype.getUiState=function(){var a=this._oPersController?this._oPersController.getDataSuiteFormatSnapshot():null;return new U({presentationVariant:{ContextUrl:"",MaxItems:this._oChartProvider.getMaxItems(),SortOrder:a?a.SortOrder:[],GroupBy:a?a.GroupBy:[],Total:a?a.Total:[],RequestAtLeast:this._getInResultDimensionTotal(),Visualizations:a?a.Visualizations:[]},selectionVariant:{SelectOptions:a?a.SelectOptions:[]},variantName:this.getCurrentVariantId()});};A.prototype.setUiState=function(a){if(!a.getPresentationVariant()&&!a.getPresentationVariant().Visualizations.some(function(e){return e.Type==="Chart";})){q.sap.log.error("sap.ui.comp.smartchart.SmartChart.prototype.setDataSuiteFormatSnapshot: 'Visualizations' array should contain at least one 'Chart' entry");return;}if(this._oPersController){var b=(this._oVariantManagement&&a.getVariantName())?this._oVariantManagement.getVariantContent(this,a.getVariantName()):{};this._oPersController.setDataSuiteFormatSnapshot(q.extend(true,{},a.getPresentationVariant(),a.getSelectionVariant()),b);}if(a.getPresentationVariant()){this._oChart.setInResultDimensions(a.getPresentationVariant().RequestAtLeast);}};A.prototype.setRequestAtLeastFields=function(R){this.setProperty("requestAtLeastFields",R);if(this._oChart){this._updateInResultDimensions();}};A.prototype._getInResultDimensionTotal=function(){var i=[];if(this.getRequestAtLeastFields()){i=this.getRequestAtLeastFields().split(",");}i=i.concat(this._aAlwaysSelect);i=i.concat(this.getChart().getInResultDimensions());return i.filter(function(e,a,b){return a==b.indexOf(e);});};A.prototype._getFieldTooltip=function(K){var a=this._getFieldByKey(K);if(a){return a.quickInfo;}return"";};A.prototype._getFieldByKey=function(K){var i,a=null;if(this._oChartViewMetadata&&this._oChartViewMetadata.fields){for(i=0;i<this._oChartViewMetadata.fields.length;i++){a=this._oChartViewMetadata.fields[i];if(K===a.name){return a;}}return null;}};A.prototype._getByKey=function(a,K){var i,L,b,e;if(a){L=a.length;for(i=0;i<L;i++){b=a[i];e=b.data("p13nData");if(e&&e.columnKey===K){return b;}}}return null;};A.prototype._getDimensionByKey=function(K){if(this._oChart){return this._getByKey(this._oChart.getDimensions(),K);}return null;};A.prototype._getMeasureByKey=function(K){if(this._oChart){return this._getByKey(this._oChart.getMeasures(),K);}return null;};A.prototype._getChartObjByKey=function(K){var a=this._getDimensionByKey(K);if(!a){a=this._getMeasureByKey(K);}return a;};A.prototype._getPathFromColumnKeyAndProperty=function(a,b){var e=null,i,n;i=this._getChartObjByKey(a);if(i){n=i.data("p13nData");if(n){e=n[b];}}return e;};A.prototype._getChartPersonalisationData=function(){if(!this._oCurrentVariant){return null;}var a=[],b=[],e=[],i,n,G;if(this._oCurrentVariant.sort){n=this._oCurrentVariant.sort.sortItems;}else{n=this._aInitialSorters;}if(n){n.forEach(function(H){var J=H.operation==="Descending";G=H.columnKey;a.push(new sap.ui.model.Sorter(G,J));},this);}if(this._oCurrentVariant.filter){this._oCurrentVariant.filter.filterItems.forEach(function(H){var J=H.value1,K=H.value2;G=H.columnKey;if(J instanceof Date&&this._oChartProvider&&this._oChartProvider.getIsUTCDateHandlingEnabled()){J=m.getDateInUTCOffset(J);K=K?m.getDateInUTCOffset(K):K;}if(H.exclude){e.push(new p(G,r.NE,J));}else{b.push(new p(G,H.operation,J,K));}},this);if(e.length){i=new p(e,true);}}return{filters:b,excludeFilters:i,sorters:a};};A.prototype._persistPersonalisation=function(){var a=this;if(this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){this._oVariantManagement.getVariantsInfo(function(b){var e=null;if(b&&b.length>0){e=b[0].key;}var i=e!==null;var n={name:"Personalisation",global:false,overwrite:i,key:e,def:true};a._oVariantManagement.fireSave(n);});}};A.prototype.getCurrentVariantId=function(){var K="";if(this._oVariantManagement){K=this._oVariantManagement.getCurrentVariantId();}return K;};A.prototype.setCurrentVariantId=function(a){if(this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){this._oVariantManagement.setCurrentVariantId(a);}else{q.sap.log.error("sap.ui.comp.smartchart.SmartChart.prototype.setCurrentVariantId: VariantManagement does not exist or is a page variant");}};A.prototype._adjustHeight=function(){if(this._oChart&&!this.bFullScreen){var i=0;var H=this.getDomRef()?this.getDomRef().offsetHeight:0;if(H===0){return;}if(this._oToolbar&&this._oToolbar.getDomRef()){i=this._oToolbar.getDomRef().offsetHeight;}this._iChartHeight=H-i;this._oChart.setHeight(this._iChartHeight+"px");this._updateDrillBreadcrumbs();if(this._hasOverlay){setTimeout(function(){this._showOverlay(true);}.bind(this),0);}}};A.prototype._toggleFullScreen=function(b,a){if(!this.oFullScreenButton||(b===this.bFullScreen&&!a)){return;}this.bFullScreen=b;if(!this._oFullScreenUtil){this._oFullScreenUtil=sap.ui.requireSync("sap/ui/comp/util/FullScreenUtil");}this._oFullScreenUtil.toggleFullScreen(this,this.bFullScreen,this.oFullScreenButton,this._toggleFullScreen.bind(this,false));this._renderFullScreenButton();this.fireFullScreenToggled({fullScreen:b});if(this._oChart){var H=this.bFullScreen?"100%":(this._iChartHeight+"px");this._oChart.setHeight(H);this._processResizeHandler(!this.bFullScreen);}};A.prototype._renderFullScreenButton=function(){this.oFullScreenButton.setTooltip(this.bFullScreen?this._oRb.getText("CHART_MINIMIZEBTN_TOOLTIP"):this._oRb.getText("CHART_MAXIMIZEBTN_TOOLTIP"));this.oFullScreenButton.setText(this.bFullScreen?this._oRb.getText("CHART_MINIMIZEBTN_TEXT"):this._oRb.getText("CHART_MAXIMIZEBTN_TEXT"));this.oFullScreenButton.setIcon(this.bFullScreen?"sap-icon://exit-full-screen":"sap-icon://full-screen");};A.prototype._enrichFromDataPoints=function(a){var L=a.length;var b=[];var e={};for(var i=0;i<L;i++){this._interpretDataPoint(a[i].dataPoint,a[i].measure,e,b);}if(b.length>0){this._oChart.setActiveColoring({coloring:sap.chart.ColoringType.Criticality,parameters:{measure:b}});this._oChart.setColorings({Criticality:{MeasureValues:e}});}};A.prototype._interpretDataPoint=function(a,b,e,i){this._setSemanticPatterns(a,b);if(b.setBoundaryValues){this._setBoundaryValues(a,b);}if(a.Criticality||a.CriticalityCalculation){e[a.Value.Path]=this._oChartProvider.provideSemanticColoring(a);i.push(a.Value.Path);}};A.prototype._setSemanticPatterns=function(a,b){b.setSemantics(sap.chart.data.MeasureSemantics.Actual);if(a.TargetValue&&a.TargetValue.Path){var R=this._oChart.getMeasureByName(a.TargetValue.Path);if(R){R.setSemantics(sap.chart.data.MeasureSemantics.Reference);}else{q.sap.log.error("sap.ui.comp.SmartChart: "+a.TargetValue.Path+" is not a valid measure");}}if(a.ForecastValue&&a.ForecastValue.Path){var e=this._oChart.getMeasureByName(a.ForecastValue.Path);if(e){e.setSemantics(sap.chart.data.MeasureSemantics.Projected);}else{q.sap.log.error("sap.ui.comp.SmartChart: "+a.ForecastValue.Path+" is not a valid measure");}}};A.prototype._setBoundaryValues=function(a,b){var e={};if(a.MinimumValue){e.minimum=a.MinimumValue;}if(a.MaximumValue){e.maximum=a.MaximumValue;}if(e.minimum||e.maximum){b.setBoundaryValues(e);}};A.prototype.isInitialised=function(){return!!this.bIsInitialised;};A.prototype.exit=function(){this._oRb=null;if(this._oSmartFilter){this._oSmartFilter.detachSearch(this._reBindChart,this);this._oSmartFilter.detachFilterChange(this._filterChangeEvent,this);this._oSmartFilter.detachCancel(this._cancelEvent,this);}if(this._oChartProvider&&this._oChartProvider.destroy){this._oChartProvider.destroy();}this._oChartProvider=null;if(this._oPersController&&this._oPersController.destroy){this._oPersController.destroy();}if(this._oSegmentedButton){this._oSegmentedButton.removeAllButtons();this._oButtonChart1.destroy();this._oButtonChart2.destroy();this._oButtonChart3.destroy();this._oButtonChart4.destroy();this._oButtonChart5.destroy();this._oButtonChart1=null;this._oButtonChart2=null;this._oButtonChart3=null;this._oButtonChart4=null;this._oButtonChart5=null;}this._oPersController=null;if(this._oVariantManagement){this._oVariantManagement.detachSave(this._variantSaved,this);this._oVariantManagement.detachAfterSave(this._variantAfterSave,this);if(!this._oVariantManagement.isPageVariant()&&this._oVariantManagement.destroy){this._oVariantManagement.destroy();}}this._oVariantManagement=null;this._destroyPopover();if(this._oFullScreenUtil){this._oFullScreenUtil.cleanUpFullScreen(this);this._oFullScreenUtil=null;}if(this._oDetailsPopover){this._oDetailsPopover.destroy();if(this._oRelatedAppsMasterList){this._oRelatedAppsMasterList.destroy();}}this._processResizeHandler(false);this._oCurrentVariant=null;this._oApplicationDefaultVariant=null;this._oChartViewMetadata=null;this._aAlwaysSelect=null;this._aInitialSorters=null;this._oSmartFilter=null;this._oToolbar=null;this._oChartPersonalisationButton=null;this._oView=null;this._oChart=null;};A.prototype._processResizeHandler=function(a){if(a){this.sResizeListenerId=null;if(s.system.desktop){this.sResizeListenerId=sap.ui.core.ResizeHandler.register(this,this._adjustHeight.bind(this));}else{s.orientation.attachHandler(this._adjustHeight,this);s.resize.attachHandler(this._adjustHeight,this);}}else{if(s.system.desktop&&this.sResizeListenerId){sap.ui.core.ResizeHandler.deregister(this.sResizeListenerId);this.sResizeListenerId=null;}else{s.orientation.detachHandler(this._adjustHeight,this);s.resize.detachHandler(this._adjustHeight,this);}}};return A;},true);
