/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/smartfield/AnnotationHelper','sap/ui/core/StashedControlSupport','sap/ui/dt/ElementUtil','sap/ui/rta/Utils','sap/ui/rta/util/BindingsExtractor'],function(M,A,S,E,R,B){"use strict";var a=new A();function _(P){if(P&&P.type){if(P.type.toLowerCase().indexOf("edm")!==0){return true;}}return false;}function b(O,i){return O.reduce(function(j,P){var v=P;if(_(P)){v=i.getFieldsByComplexTypeName(P.type).map(function(C){C.bindingPath=P.name+"/"+C.name;C.entityName=P.entityName;C.referencedComplexPropertyName=P.fieldLabel?P.fieldLabel:P.name;return C;});}else{v.bindingPath=P.name;}return j.concat(v);},[]);}function c(O,i){return O.filter(function(P){return P.visible;}).filter(function(P){var F=a.getFieldControlPath(P);if(F){var j=i.getBindingContext().getProperty(F);return j!==0;}return true;});}function d(i){var j=i.getModel();var l;var D={property:[],navigationProperty:[],navigationEntityNames:[]};if(j){var t=j.getMetadata().getName();if(t==="sap.ui.model.odata.ODataModel"||t==="sap.ui.model.odata.v2.ODataModel"){l=j.getMetaModel().loaded().then(function(){var u=new M(j);var O=R.getBoundEntityType(i);var v=O.name;var w=u.getFieldsByEntityTypeName(v)||[];w=b(w,u);w=c(w,i);var N=[];if(O.navigationProperty){O.navigationProperty.forEach(function(x){var y=R.getEntityTypeByNavProperty(j,O,x.name);if(y&&y.name){if(N.indexOf(y.name)===-1){N.push(y.name);}}});}return{property:w||[],navigationProperty:O.navigationProperty||[],navigationEntityNames:N||[]};});}}return l||Promise.resolve(D);}function e(O){return{selected:false,label:O.fieldLabel,referencedComplexPropertyName:O.referencedComplexPropertyName?O.referencedComplexPropertyName:"",duplicateComplexName:O.duplicateComplexName?O.duplicateComplexName:false,tooltip:O.quickInfo||O.fieldLabel,originalLabel:"",type:"odata",entityType:O.entityName,name:O.name,bindingPath:O.bindingPath};}function f(D){var i=D.element;var j=D.action;return{selected:false,label:R.getLabelForElement(i,j.getLabel),tooltip:R.getLabelForElement(i,j.getLabel),referencedComplexPropertyName:i.referencedComplexPropertyName?i.referencedComplexPropertyName:"",duplicateComplexName:i.duplicateComplexName?i.duplicateComplexName:false,bindingPaths:i.bindingPaths,originalLabel:i.renamedLabel&&i.fieldLabel!==i.labelFromOData?i.labelFromOData:"",type:"invisible",element:i};}function g(i,j){if(j){var l=R.getEntityTypeByPath(i.getModel(),i.getBindingContext().getPath());return E.findAllSiblingsInContainer(i,j).filter(function(t){return R.getEntityTypeByPath(t.getModel(),t.getBindingContext().getPath())===l;});}else{return[i];}}function h(O){O.forEach(function(i,l,O){if(i["duplicateComplexName"]!==true){for(var j=l+1;j<O.length-1;j++){if(i.fieldLabel===O[j].fieldLabel){i["duplicateComplexName"]=true;O[j]["duplicateComplexName"]=true;}}}});return O;}function k(i,O){return O.some(function(D){return D.fieldLabel===i.fieldLabel;});}function m(I,j){I.bindingPaths=[];I.bindingContextPaths=[];var t=B.getBindings(I,j);for(var i=0,l=t.length;i<l;i++){if(t[i].getPath&&t[i].getPath()){if(I.bindingPaths.indexOf(t[i].getPath())===-1){I.bindingPaths.push(t[i].getPath());}}if(t[i].getContext&&t[i].getContext()){if(I.bindingContextPaths.indexOf(t[i].getContext().getPath())===-1){I.bindingContextPaths.push(t[i].getContext().getPath());}}}return I;}function n(i){return Array.isArray(i)&&i.length>0;}function o(i,N,j,l){var t=n(i)&&i.some(function(P){var v=P.trim().replace(/^\//gi,'').split('/');if(v.length>1){return N.indexOf(v.shift())!==-1;}});var u=l.some(function(C){C=C.match(/^\/?([A-Za-z0-9_]+)/)[0];return(j.indexOf(C)>=0);});return t||u;}function p(i,O){return O.filter(function(D){return i.indexOf(D.bindingPath)!==-1;}).pop();}function q(i,O){i.labelFromOData=O.fieldLabel;if(i.fieldLabel!==i.labelFromOData){i.renamedLabel=true;}if(O.referencedComplexPropertyName){i.referencedComplexPropertyName=O.referencedComplexPropertyName;}}function r(i,O,N,j){var l=i.bindingPaths,t=i.bindingContextPaths,u;return(!n(l)||o(l,N,j,t)||((u=p(l,O))&&(q(i,u)||true)));}var s={enhanceInvisibleElements:function(P,i){var j=P.getModel();var l=i.reveal;var t=i.addODataProperty;return Promise.resolve().then(function(){return d(P);}).then(function(D){var O=D.property;var u=D.navigationProperty.map(function(N){return N.name;});var v=D.navigationEntityNames;O=h(O);var w=[];var I=l.elements||[];I.forEach(function(x){var T=x.getMetadata().getName();var y=l.types[T].action;x=m(x,j);x.fieldLabel=R.getLabelForElement(x,y.getLabel);x.duplicateComplexName=k(x,O);var z=true;if(t&&O.length>0){z=r(x,O,u,v);}if(z){w.push({element:x,action:y});}});return w;}).then(function(u){return u.map(f);});},getUnboundODataProperties:function(i,j){var l=i.getModel();return Promise.resolve().then(function(){return d(i);}).then(function(D){var O=D.property;var t=g(i,j.relevantContainer);var u=[];t.forEach(function(i){u=u.concat(B.getBindings(i,l));});var F=j.action.filter?j.action.filter:function(){return true;};O=O.filter(function(v){var H=false;if(u){H=u.some(function(w){return!!w.getPath&&(w.getPath()===v.bindingPath);});}return!H&&F(j.relevantContainer,v);});O=h(O);return O;}).then(function(u){return u.map(e);});}};return s;});
