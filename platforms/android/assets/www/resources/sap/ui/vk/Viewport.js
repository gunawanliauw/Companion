/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/core/ResizeHandler","./Loco","./ViewportHandler","./Smart2DHandler","./GraphicsCore","./Messages"],function(q,l,C,R,L,V,S,G,M){"use strict";var d={encodedProjectionType:{},decodedProjectionType:{},encodedBindingType:{},decodedBindingType:{},decodedZoomTo:{}};d.decodedProjectionType[sap.ui.vk.CameraProjectionType.Perspective]=sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE;d.decodedProjectionType[sap.ui.vk.CameraProjectionType.Orthographic]=sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC;d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE]=sap.ui.vk.CameraProjectionType.Perspective;d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC]=sap.ui.vk.CameraProjectionType.Orthographic;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Minimum]=sap.ve.dvl.DVLCAMERAFOVBINDING.MIN;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Maximum]=sap.ve.dvl.DVLCAMERAFOVBINDING.Max;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Horizontal]=sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Vertical]=sap.ve.dvl.DVLCAMERAFOVBINDING.VERT;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MIN]=sap.ui.vk.CameraFOVBindingType.Minimum;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MAX]=sap.ui.vk.CameraFOVBindingType.Maximum;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ]=sap.ui.vk.CameraFOVBindingType.Horizontal;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.VERT]=sap.ui.vk.CameraFOVBindingType.Vertical;d.decodedZoomTo[sap.ui.vk.ZoomTo.All]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_ALL;d.decodedZoomTo[sap.ui.vk.ZoomTo.Visible]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_VISIBLE;d.decodedZoomTo[sap.ui.vk.ZoomTo.Selected]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_SELECTED;d.decodedZoomTo[sap.ui.vk.ZoomTo.Node]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_NODE;d.decodedZoomTo[sap.ui.vk.ZoomTo.NodeSetIsolation]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_NODE_SETISOLATION;d.decodedZoomTo[sap.ui.vk.ZoomTo.Restore]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_RESTORE;d.decodedZoomTo[sap.ui.vk.ZoomTo.RestoreRemoveIsolation]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_RESTORE_REMOVEISOLATION;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewLeft]=sap.ve.dvl.DVLZOOMTO.VIEW_LEFT;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewRight]=sap.ve.dvl.DVLZOOMTO.VIEW_RIGHT;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewTop]=sap.ve.dvl.DVLZOOMTO.VIEW_TOP;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewBottom]=sap.ve.dvl.DVLZOOMTO.VIEW_BOTTOM;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewBack]=sap.ve.dvl.DVLZOOMTO.VIEW_BACK;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewFront]=sap.ve.dvl.DVLZOOMTO.VIEW_FRONT;var a=C.extend("sap.ui.vk.Viewport",{metadata:{library:"sap.ui.vk",publicMethods:["setGraphicsCore","getGraphicsCore","setScene","setViewStateManager","beginGesture","endGesture","pan","rotate","zoom","tap","hitTest","queueCommand","getViewInfo","setViewInfo"],properties:{showDebugInfo:"boolean",showAllHotspots:{type:"boolean",defaultValue:false},hotspotColorABGR:{type:"int",defaultValue:0xc00000ff},hotspotColor:{type:"sap.ui.core.CSSColor",defaultValue:"rgba(255, 0, 0, 0.7529411764705882)"},backgroundColorTopABGR:{type:"int",defaultValue:0xff000000},backgroundColorTop:{type:"sap.ui.core.CSSColor",defaultValue:"rgba(0, 0, 0, 1)"},backgroundColorBottomABGR:{type:"int",defaultValue:0xffffffff},backgroundColorBottom:{type:"sap.ui.core.CSSColor",defaultValue:"rgba(255, 255, 255, 1)"},width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"}},events:{urlClicked:{parameters:{nodeId:"string",url:"string"},enableEventBubbling:true},nodeClicked:{parameters:{nodeId:"string",x:"int",y:"int"},enableEventBubbling:true},pan:{parameters:{dx:"int",dy:"int"}},zoom:{parameters:{zoomFactor:"float"}},rotate:{parameters:{dx:"int",dy:"int"}},resize:{parameters:{size:"object"}},viewActivated:{parameters:{type:{type:"string"}}},frameRenderingFinished:{}}}});a.prototype.init=function(){if(C.prototype.init){C.prototype.init.call(this);}this._graphicsCore=null;this._dvl=null;this._dvlRendererId=null;this._viewStateManager=null;this._canvas=null;this._resizeListenerId=null;this._is2D=false;this._viewportHandler=new V(this);this._loco=new L();this._loco.addHandler(this._viewportHandler);this._smart2DHandler=null;this._lastPlayedStep=null;};a.prototype.exit=function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this.setViewStateManager(null);this.setScene(null);this.setGraphicsCore(null);if(C.prototype.exit){C.prototype.exit.call(this);}};a.prototype.setGraphicsCore=function(h){if(h!=this._graphicsCore){if(this._graphicsCore){this._dvl.Client.detachFrameFinished(this._handleFrameFinished,this);this._dvl.Client.detachStepEvent(this._updateLastPlayedStep,this);this._graphicsCore._deregisterViewport(this);this._dvl=null;}this._graphicsCore=h;if(this._graphicsCore){this._dvl=this._graphicsCore._getDvl();this._graphicsCore._registerViewport(this);this.setShowDebugInfo(this.getShowDebugInfo());this._dvl.Client.attachStepEvent(this._updateLastPlayedStep,this);this._dvl.Client.attachFrameFinished(this._handleFrameFinished,this);}}return this;};a.prototype.getGraphicsCore=function(){return this._graphicsCore;};a.prototype._setCanvas=function(h){var i=this.getDomRef()&&this._canvas!==h;this._canvas=h;if(i){this.invalidate();}return this;};a.prototype._setRenderer=function(h){this._dvlRendererId=h;return this;};a.prototype._updateLastPlayedStep=function(h){if(h.type===sap.ve.dvl.DVLSTEPEVENT.DVLSTEPEVENT_STARTED){this._lastPlayedStep=h.stepId;}};a.prototype.setScene=function(h){if(this._dvlRendererId){this._dvl.Renderer.AttachScene(h&&h._getDvlSceneId()||null,this._dvlRendererId);this._dvlSceneId=h?h._getDvlSceneId():null;if(h){this._dvl.Client.attachUrlClicked(this._fireUrlClicked,this);var i=this._isSmart2DContent()||this._isSmart2DContentLegacy();if(i){this._dvl.Renderer.SetBackgroundColor(1,1,1,1,1,1,1,1,this._dvlRendererId);}else{var t=this._getDecomposedABGR(this.getBackgroundColorTopABGR());var j=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(t.red,t.green,t.blue,t.alpha,j.red,j.green,j.blue,j.alpha,this._dvlRendererId);}this.fireViewActivated({type:i?"2D":"3D"});}else{this._dvl.Client.detachUrlClicked(this._fireUrlClicked,this);if(this._smart2DHandler){var k=new L();k.removeHandler(this._smart2DHandler);}}}return this;};a.prototype._isSmart2DContent=function(){var h=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneId,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return h&&h.length>0;};a.prototype._isSmart2DContentLegacy=function(){var h=this._dvl.Scene.GetCurrentCamera(this._dvlSceneId),i=this._dvl.Camera.GetRotation(h),j=this._dvl.Camera.GetProjection(h);return i[0]===90&&i[1]===-90&&i[2]===0&&j===sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC;};a.prototype._initializeSmart2DHandler=function(){if(this._viewStateManager){if(this._smart2DHandler){this._loco.removeHandler(this._smart2DHandler);}this._smart2DHandler=new S(this,this._viewStateManager);this._loco.addHandler(this._smart2DHandler);}if(this.getShowAllHotspots()){var n=this._viewStateManager.getNodeHierarchy(),h=n.getHotspotNodeIds();this.showHotspots(h,true);}};a.prototype._fireUrlClicked=function(h){this.fireUrlClicked({url:h.url,nodeId:h.nodeId});};a.prototype._getStepAndProcedureIndexes=function(h,k){var m=-1,n=-1,t=false;for(var i=0;i<h.length;i++){if(!t){for(var j=0;j<h[i].steps.length;j++){if(h[i].steps[j].id===k){n=j;m=i;t=true;break;}}}else{break;}}return{stepIndex:n,procedureIndex:m};};a.prototype._getStepVeIdById=function(h){if(h){var v=this._dvl.Scene.RetrieveVEIDs(this._dvlSceneId,h);if(Array.isArray(v)){for(var i=0,j=v.length;i<j;++i){var k=v[i];if(k.source==="SAP"&&k.type==="VE_VIEWPORT"&&Array.isArray(k.fields)){for(var m=0,n=k.fields.length;m<n;++m){var t=k.fields[m];if(t.name==="ID"){return t.value;}}}}}}return null;};a.prototype._getStepIdByVeId=function(h,i){for(var j=0,k=h.length;j<k;++j){var m=h[j].steps;for(var n=0,t=m.length;n<t;++n){var u=m[n].id;if(this._getStepVeIdById(u)===i){return u;}}}return null;};var s=function(h){h.camera={};};var b=function(h){if(typeof h.camera==="object"&&h.camera!==null){h.camera.matrices=false;}};var c=function(h){if(typeof h.camera==="object"&&h.camera!==null){h.camera.useTransitionCamera=false;}};var e=function(h){h.animation=true;};var f=function(h){h.visibility=false;};var g=function(h){if(typeof h.visibility==="object"&&h.visibility!==null){h.visibility.mode=sap.ui.vk.VisibilityMode.Complete;}};a.prototype.getViewInfo=function(h){if(!this._dvlSceneId){return null;}var i={};if(typeof h!=="object"||h===null){s(i);b(i);c(i);e(i);f(i);g(i);}else{if(typeof h.camera==="object"&&h.camera!==null){i.camera={};if(typeof h.camera.matrices==="boolean"){i.camera.matrices=h.camera.matrices;}else if("matrices"in h.camera){i.camera.matrices=false;}else{b(i);}if(typeof h.camera.useTransitionCamera==="boolean"){i.camera.useTransitionCamera=h.camera.useTransitionCamera;}else if("useTransitionCamera"in h.camera){i.camera.useTransitionCamera=false;}else{c(i);}}else if(typeof h.camera==="boolean"){if(h.camera===true){i.camera={};b(i);c(i);}else{i.camera=false;}}else if("camera"in h){i.camera=false;}else{s(i);b(i);c(i);}if(typeof h.animation==="boolean"){i.animation=h.animation;}else if("animation"in h){i.animation=false;}else{e(i);}if(typeof h.visibility==="object"&&h.visibility!==null){i.visibility={};if(h.visibility.mode===sap.ui.vk.VisibilityMode.Complete||h.visibility.mode===sap.ui.vk.VisibilityMode.Differences){i.visibility.mode=h.visibility.mode;}else{g(i);}}else if(typeof h.visibility==="boolean"){if(h.visibility===true){i.visibility={};g(i);}else{i.visibility=false;}}else if("visibility"in h){i.visibility=false;}else{f(i);g(i);}}var v={};if(i.camera){var j=null;if(i.camera.useTransitionCamera){j=this._dvl.Renderer.GetTransitionCamera(this._dvlRendererId);if(j===sap.ve.dvl.DVLID_INVALID){j=null;}}if(j===null){j=this._dvl.Renderer.GetCurrentCamera(this._dvlRendererId);}var k=this._dvl.Camera.GetRotation(j),m=this._dvl.Camera.GetOrigin(j);v.camera={rotation:{yaw:k[0],pitch:k[1],roll:k[2]},position:{x:m[0],y:m[1],z:m[2]},projectionType:d.encodedProjectionType[this._dvl.Camera.GetProjection(j)],bindingType:d.encodedBindingType[this._dvl.Camera.GetFOVBinding(j)]};if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective){v.camera.fieldOfView=this._dvl.Camera.GetFOV(j);}else if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){v.camera.zoomFactor=this._dvl.Camera.GetOrthoZoomFactor(j);}if(i.camera.matrices){var n=this._dvl.Renderer.GetCameraMatrices(this._dvlRendererId);v.camera.matrices={view:n.view,projection:n.projection};}}if(i.animation){var t=this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneId,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_STEP_INFO),u=t.StepId!==sap.ve.dvl.DVLID_INVALID;var w=u?t.StepId:this._lastPlayedStep,x=u?t.StepTime:0,y=this._dvl.Scene.RetrieveProcedures(this._dvlSceneId),z=this._getStepAndProcedureIndexes(y.procedures,w),A=this._getStepVeIdById(w);v.animation={animationTime:x,stepIndex:z.stepIndex,procedureIndex:z.procedureIndex};if(A){v.animation.stepVeId=A;}}if(i.visibility&&this._viewStateManager){if(this._viewStateManager.getCanTrackVisibilityChanges()){v.visibility={mode:i.visibility.mode};if(i.visibility.mode===sap.ui.vk.VisibilityMode.Complete){var B=this._viewStateManager.getVisibilityComplete();v.visibility.visible=B.visible;v.visibility.hidden=B.hidden;}else{v.visibility.changes=this._viewStateManager.getVisibilityChanges();}}else{q.sap.log.warning(sap.ui.vk.getResourceBundle().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.Viewport");}}return v;};a.prototype.setViewInfo=function(v,h){var i=false;if(v.animation){var j=this._dvl.Scene.RetrieveProcedures(this._dvlSceneId),k=v.animation.procedureIndex,m=v.animation.stepIndex,n=v.animation.stepVeId,t,u=v.animation.animationTime||0;if(n||m>=0&&k>=0){if(n){t=this._getStepIdByVeId(j.procedures,v.animation.stepVeId);}else if(k>=0&&k<j.procedures.length){if(m>=0&&m<j.procedures[k].steps.length){t=j.procedures[k].steps[m].id;}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT26.summary),M.VIT26.code,"sap.ui.vk.Viewport");}}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT27.summary),M.VIT27.code,"sap.ui.vk.Viewport");}if(t){this._dvl.Renderer.ActivateStep(this._dvlRendererId,t,false,false,u);this._dvl.Renderer.PauseCurrentStep(this._dvlRendererId);}}else{i=true;}}if(v.camera){var w;if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective||v.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){w=d.decodedProjectionType[v.camera.projectionType];}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT19.summary),M.VIT19.code,"sap.ui.vk.Viewport");w=sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE;}var x=this._dvl.Scene.CreateCamera(this._dvlSceneId,w,sap.ve.dvl.DVLID_INVALID);if(w===sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE){this._dvl.Camera.SetFOV(x,v.camera.fieldOfView);}else if(w===sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC){this._dvl.Camera.SetOrthoZoomFactor(x,v.camera.zoomFactor);}if(v.camera.position){this._dvl.Camera.SetOrigin(x,v.camera.position.x,v.camera.position.y,v.camera.position.z);}if(v.camera.rotation){this._dvl.Camera.SetRotation(x,v.camera.rotation.yaw,v.camera.rotation.pitch,v.camera.rotation.roll);}if(v.camera.bindingType){var y=d.decodedBindingType[v.camera.bindingType]||sap.ve.dvl.DVLCAMERAFOVBINDING.MIN;this._dvl.Camera.SetFOVBinding(x,y);}h=h||0;this._dvl.Renderer.ActivateCamera(this._dvlRendererId,x,h);this._dvl.Scene.DeleteNode(this._dvlSceneId,x);}if(v.visibility){var z=this._viewStateManager.getNodeHierarchy(),A=new Map(),B=z.findNodesByName();B.forEach(function(F){var H=z.createNodeProxy(F),I=q.grep(H.getVeIds(),function(I){return I.type==="VE_LOCATOR";})[0].fields[0].value;z.destroyNodeProxy(H);A.set(I,F);});switch(v.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var D=v.visibility.visible,E=v.visibility.hidden;D.forEach(function(F){this._viewStateManager.setVisibilityState(A.get(F),true,false);},this);E.forEach(function(F){this._viewStateManager.setVisibilityState(A.get(F),false,false);},this);break;case sap.ui.vk.VisibilityMode.Differences:if(i){this.resetView({camera:false,visibility:true,transition:false});}v.visibility.changes.forEach(function(F){var H=A.get(F);this._viewStateManager.setVisibilityState(H,!this._viewStateManager.getVisibilityState(H),false);},this);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.Viewport");break;}}return this;};a.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};a.prototype.getOutputSize=function(){var h=this.getViewInfo().camera.bindingType,i=this.getDomRef().getBoundingClientRect(),v=i.width,j=i.height,k;switch(d.decodedBindingType[h]){case sap.ve.dvl.DVLCAMERAFOVBINDING.MIN:k=Math.min(v,j);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.MAX:k=Math.max(v,j);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ:k=v;break;case sap.ve.dvl.DVLCAMERAFOVBINDING.VERT:k=j;break;default:break;}return{left:(v-k)/2,top:(j-k)/2,sideLength:k};};a.prototype.onAfterRendering=function(){if(this._canvas){var h=this.getDomRef();h.appendChild(this._canvas);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:h.clientWidth,height:h.clientHeight}});}};a.prototype._handleResize=function(h){if(this._dvlRendererId&&this._canvas){var i=h.size.width*window.devicePixelRatio;var j=h.size.height*window.devicePixelRatio;this._dvl.Renderer.SetDimensions(i,j,this._dvlRendererId);this._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*window.devicePixelRatio,this._dvlRendererId);this._canvas.width=i;this._canvas.height=j;this._canvas.style.width=h.size.width+"px";this._canvas.style.height=h.size.height+"px";this.fireResize({size:{width:h.size.width,height:h.size.height}});return true;}};a.prototype.setViewStateManager=function(v){if(this._dvl){if(this._viewStateManager){this._viewStateManager.detachTintColorChanged(this._handleTintColorChanged,this);this._viewStateManager.detachOpacityChanged(this._handleOpacityChanged,this);this._viewStateManager.detachSelectionChanged(this._handleSelectionChanged,this);this._viewStateManager.detachVisibilityChanged(this._handleVisibilityChanged,this);}this._viewStateManager=v;this._dvl.Renderer.SetViewStateManager(v,this._dvlRendererId);if(this._viewStateManager&&(this._isSmart2DContent()||this._isSmart2DContentLegacy())){this._initializeSmart2DHandler();}if(this._viewStateManager){this._viewStateManager.attachVisibilityChanged(this._handleVisibilityChanged,this);this._viewStateManager.attachSelectionChanged(this._handleSelectionChanged,this);this._viewStateManager.attachOpacityChanged(this._handleOpacityChanged,this);this._viewStateManager.attachTintColorChanged(this._handleTintColorChanged,this);}}return this;};a.prototype._handleVisibilityChanged=a.prototype._handleSelectionChanged=a.prototype._handleOpacityChanged=a.prototype._handleTintColorChanged=function(h){this.renderFrame();};a.prototype.showHotspots=function(n,h,i){var j=sap.ui.vk.NodeProxy.prototype[typeof i==="string"?"setTintColor":"setTintColorABGR"];var k=function(t,i,x){var y=t.createNodeProxy(x);j.call(y,i);t.destroyNodeProxy(y);};if(!Array.isArray(n)){n=[n];}var m=i===undefined?this.getHotspotColorABGR():i;if(!h){m=0;}var t=this._viewStateManager.getNodeHierarchy();if(this._isSmart2DContent()){var u=[];n.forEach(function(x){var y=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneId,x,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN).ChildNodes);Array.prototype.push.apply(u,y);}.bind(this));Array.prototype.push.apply(u,n);u.forEach(k.bind(null,t,m));}else{var v=[];var w=function(x){var u=t.getChildren(x);Array.prototype.push.apply(v,u);u.forEach(w);};n.forEach(w);Array.prototype.push.apply(v,n);v.forEach(k.bind(null,t,m));}return this;};a.prototype.setHotspotColorABGR=function(v){this.setProperty("hotspotColorABGR",v,true);this.setProperty("hotspotColor",sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(v)),true);return this;};a.prototype.setHotspotColor=function(v){this.setProperty("hotspotColor",v,true);this.setProperty("hotspotColorABGR",sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(v)),true);return this;};a.prototype._getDecomposedABGR=function(i){return{red:(i>>>0&0xff)/255,green:(i>>>8&0xff)/255,blue:(i>>>16&0xff)/255,alpha:(i>>>24&0xff)/255};};a.prototype._setBackgroundColor=function(){var t=this._getDecomposedABGR(this.getBackgroundColorTopABGR()),h=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(t.red,t.green,t.blue,t.alpha,h.red,h.green,h.blue,h.alpha,this._dvlRendererId);};a.prototype.setBackgroundColorTopABGR=function(i){this.setProperty("backgroundColorTopABGR",i,true);this._setBackgroundColor();return this;};a.prototype.setBackgroundColorTop=function(v){this.setProperty("backgroundColorTop",v,true);return this.setBackgroundColorTopABGR(sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(v)));};a.prototype.setBackgroundColorBottomABGR=function(i){this.setProperty("backgroundColorBottomABGR",i,true);this._setBackgroundColor();return this;};a.prototype.setBackgroundColorBottom=function(v){this.setProperty("backgroundColorBottom",v,true);return this.setBackgroundColorBottomABGR(sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(v)));};a.prototype.shouldRenderFrame=function(){return this._dvlRendererId&&this._dvl.Renderer.ShouldRenderFrame(this._dvlRendererId);};a.prototype.renderFrame=function(){if(this._dvlRendererId){this._dvl.Renderer.RenderFrame(this._dvlRendererId);}return this;};a.prototype.renderFrameEx=function(v,h){if(this._dvlRendererId){this._dvl.Renderer.RenderFrameEx.apply(this,[].concat(v,h),this._dvlRendererId);}return this;};a.prototype.resetView=function(h){if(h!==undefined&&!q.isPlainObject(h)){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT31.summary),M.VIT31.code,"sap.ui.vk.Viewport");}var i={camera:true,transition:true,visibility:false};q.extend(i,h);if(i.camera||i.visibility){var j=(i.camera?sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA:0)|(i.transition?sap.ve.dvl.DVLRESETVIEWFLAG.SMOOTHTRANSITION:0)|(i.visibility?sap.ve.dvl.DVLRESETVIEWFLAG.VISIBILITY:0);if(this._dvlRendererId){this._dvl.Renderer.ResetView(j,this._dvlRendererId);this._lastPlayedStep=null;}}return this;};a.prototype.canIsolateNode=function(n){if(this._dvlRendererId){return this._dvl.Renderer.CanIsolateNode(n,this._dvlRendererId);}else{return false;}};a.prototype.setIsolatedNode=function(n){if(this._dvlRendererId){this._dvl.Renderer.SetIsolatedNode(n,this._dvlRendererId);}return this;};a.prototype.getIsolatedNode=function(){if(this._dvlRendererId){return this._dvl.Renderer.GetIsolatedNode(this._dvlRendererId);}else{return sap.ve.dvl.DVLID_INVALID;}};a.prototype.hitTest=function(x,y){if(this._dvlRendererId){var h=this._dvl.Renderer.HitTest(x*window.devicePixelRatio,y*window.devicePixelRatio,this._dvlRendererId).id;this.renderFrame();return h;}else{return sap.ve.dvl.DVLID_INVALID;}};a.prototype.setShowDebugInfo=function(v){this.setProperty("showDebugInfo",v,true);if(this._dvlRendererId){this._dvl.Renderer.SetOption(sap.ve.dvl.DVLRENDEROPTION.DVLRENDEROPTION_SHOW_DEBUG_INFO,v,this._dvlRendererId);}return this;};a.prototype._handleFrameFinished=function(h){if(h.rendererId===this._dvlRendererId){this.fireFrameRenderingFinished();}};a.prototype.beginGesture=function(x,y){if(this._dvlRendererId){this._dvl.Renderer.BeginGesture(x*window.devicePixelRatio,y*window.devicePixelRatio,this._dvlRendererId);}return this;};a.prototype.endGesture=function(){if(this._dvlRendererId){this._dvl.Renderer.EndGesture(this._dvlRendererId);}return this;};a.prototype.pan=function(h,i){if(this._dvlRendererId){this._dvl.Renderer.Pan(h*window.devicePixelRatio,i*window.devicePixelRatio,this._dvlRendererId);this.firePan({dx:h,dy:i});}return this;};a.prototype.rotate=function(h,i){if(this._dvlRendererId){this._dvl.Renderer.Rotate(h*window.devicePixelRatio,i*window.devicePixelRatio,this._dvlRendererId);this.fireRotate({dx:h,dy:i});}return this;};a.prototype.zoom=function(h){if(this._dvlRendererId){this._dvl.Renderer.Zoom(h,this._dvlRendererId);this.fireZoom({zoomFactor:h});}return this;};a.prototype.zoomTo=function(w,n,h,m){if(this._dvlRendererId){var j=0;if(Array.isArray(w)){for(var i in w){j|=d.decodedZoomTo[w[i]];}}else{j=d.decodedZoomTo[w];}this._dvl.Renderer.ZoomTo(j,n,h,m,this._dvlRendererId);}return this;};a.prototype.tap=function(x,y,i){if(this._dvlRendererId){var h=x*window.devicePixelRatio,j=y*window.devicePixelRatio;if(!i){var n=this.hitTest(x,y);if(this._viewStateManager&&(n===sap.ve.dvl.DVLID_INVALID||!this._viewStateManager.getSelectionState(n))){var k=[];this._viewStateManager.enumerateSelection(Array.prototype.push.bind(k));if(k.length>0){this._viewStateManager.setSelectionState(k,false,false);}}if(n!==sap.ve.dvl.DVLID_INVALID){this.fireNodeClicked({nodeId:n,x:x,y:y},true,true);if(this._viewStateManager){this._viewStateManager.setSelectionState(n,true);}}}else{this._dvl.Renderer.Tap(h,j,i,this._dvlRendererId);}}return this;};a.prototype.queueCommand=function(h){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(h,this._dvlRendererId);}return this;};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){a.prototype["onsap"+i.key]=function(h){this.beginGesture(o.x,o.y);this.rotate(i.dx,i.dy);this.endGesture();this.renderFrame();h.preventDefault();h.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){a.prototype["onsap"+i.key+"modifiers"]=function(h){if(h.shiftKey&&!(h.ctrlKey||h.altKey||h.metaKey)){this.beginGesture(o.x,o.y);this.pan(i.dx,i.dy);this.endGesture();this.renderFrame();h.preventDefault();h.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){a.prototype["onsap"+i.key]=function(h){this.beginGesture(this.$().width()/2,this.$().height()/2);this.zoom(i.d);this.endGesture();this.renderFrame();h.preventDefault();h.stopPropagation();};});return a;});
