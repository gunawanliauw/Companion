/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/base/ManagedObject"],function(q,l,M){"use strict";var V,a=q.sap.log;var b=M.extend("sap.ui.vk.ViewStateManager",{metadata:{publicMethods:["enumerateSelection","getNodeHierarchy","getOpacity","getSelectionState","getTintColor","getVisibilityChanges","getVisibilityState","setOpacity","setSelectionState","setTintColor","setVisibilityState"],events:{visibilityChanged:{parameters:{visible:{type:"string[]"},hidden:{type:"string[]"}},enableEventBubbling:true},selectionChanged:{parameters:{selected:{type:"string[]"},unselected:{type:"string[]"}},enableEventBubbling:true},opacityChanged:{parameters:{changed:{type:"string[]"},opacity:{type:"float"}},enableEventBubbling:true},tintColorChanged:{parameters:{changed:{type:"string[]"},tintColor:{type:"sap.ui.core.CSSColor"},tintColorABGR:"int"},enableEventBubbling:true}}},constructor:function(n,c,d){a.debug("sap.ui.vk.ViewStateManager.constructor() called.");M.apply(this);var e=n.getScene(),f=e._getDvlSceneId();this._nodeHierarchy=n;this._dvl=e.getGraphicsCore()._getDvl();this._canTrackVisibilityChanges=d;this._shouldTrackVisibilityChanges=c;this._nodeHierarchy.attachChanged(this._handleNodeHierarchyChanged,this);this._handleNodeHierarchyChanged();this._nodeStates=new Map();this._selectedNodes=new Set();var t=this;function h(i){var j=t._dvl.Scene.RetrieveNodeInfo(f,i,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS|sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN);t._nodeStates.set(i,{flags:j.Flags});if(j.Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED){t._selectedNodes.add(i);}j.ChildNodes.forEach(h);}t._dvl.Scene.RetrieveSceneInfo(f,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN|sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes.forEach(h);}});b.prototype.destroy=function(){a.debug("sap.ui.vk.ViewStateManager.destroy() called.");this._newlyHiddenNodes=null;this._newlyVisibleNodes=null;this._selectedNodes=null;this._nodeStates=null;if(this._dvl){this._dvl.Client.detachStepEvent(this._handleStepEvent,this);}this._dvl=null;this._scene=null;this._nodeHierarchy.detachChanged(this._handleNodeHierarchyChanged,this);M.prototype.destroy.apply(this);};b.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};b.prototype.getVisibilityChanges=function(){return(this._getShouldTrackVisibilityChanges()&&this.getCanTrackVisibilityChanges())?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};b.prototype.getVisibilityComplete=function(){var n=this.getNodeHierarchy(),c=n.findNodesByName(),v=[],h=[];q.sap.require("sap.ui.vk.NodeProxy");c.forEach(function(d){var e=new sap.ui.vk.NodeProxy(n,d),f=q.grep(e.getVeIds(),function(f){return f.type==="VE_LOCATOR";})[0].fields[0].value;e.destroy();if(this.getVisibilityState(d)){v.push(f);}else{h.push(f);}},this);return{visible:v,hidden:h};};var g=function(n,f,c){return n.has(c)&&(n.get(c).flags&f)!==0;};b.prototype._getVisibilityFlagState=function(n){return g(this._nodeStates,sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE,n);};b.prototype._getSelectionFlagState=function(n){return g(this._nodeStates,sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED,n);};var s=function(n,f,c,d){if(n.has(d)){var i=n.get(d);i.flags=i.flags&~c|f&c;}else{n.set(d,{flags:f&c});}};b.prototype._setFlags=function(n,f,c){if(c&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE){this.setVisibilityState(n,(f&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE)!==0,false);}if(c&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED){this.setSelectionState(n,(f&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED)!==0,false);}s(this._nodeStates,f,c&~(sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE|sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED),n);return this;};b.prototype._getFlags=function(n,f){var c=this._nodeStates.get(n),d=c&&c.flags;return d!==undefined?d&f:null;};b.prototype.getVisibilityState=function(n){return Array.isArray(n)?n.map(this._getVisibilityFlagState,this):this._getVisibilityFlagState(n);};b.prototype.setVisibilityState=function(n,v,r){if(!Array.isArray(n)){n=[n];}var c=q.sap.unique(r?this._collectNodesRecursively(n):n).filter(function(d){return this._getVisibilityFlagState(d)!==v;},this);if(c.length>0){c.forEach(function(d){var e=this._nodeStates.get(d);if(e){if(e.flags===undefined){e.flags=0;}if(v){e.flags|=sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE|sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_TEMPORARY_PREVIOUS_VISIBILITY;}else{e.flags&=~(sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE|sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_TEMPORARY_PREVIOUS_VISIBILITY);}}else{this._nodeStates.set(d,{flags:v?sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_VISIBLE:0});}},this);if(this._getShouldTrackVisibilityChanges()&&this.getCanTrackVisibilityChanges()){c.forEach(this._visibilityTracker.trackNodeId,this._visibilityTracker);}this.fireVisibilityChanged({visible:v?c:[],hidden:v?[]:c});}return this;};b.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};b.prototype.getSelectionState=function(n){return Array.isArray(n)?n.map(this._getSelectionFlagState,this):this._getSelectionFlagState(n);};b.prototype.setSelectionState=function(n,c,r){if(!Array.isArray(n)){n=[n];}var d=q.sap.unique(r?this._collectNodesRecursively(n):n).filter(function(e){return this._getSelectionFlagState(e)!==c;},this);if(d.length>0){d.forEach(function(e){var f=this._nodeStates.get(e);if(f){if(f.flags===undefined){f.flags=0;}if(c){f.flags|=sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED;}else{f.flags&=~sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED;}}else{this._nodeStates.set(e,{flags:c?sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_SELECTED:0});}this._selectedNodes[c?"add":"delete"](e);},this);this.fireSelectionChanged({selected:c?d:[],unselected:c?[]:d});}return this;};b.prototype._handleNodeHierarchyChanged=function(){if(this._getShouldTrackVisibilityChanges()&&this.getCanTrackVisibilityChanges()){if(!this._visibilityTracker){this._visibilityTracker=new V();this._dvl.Client.attachStepEvent(this._handleStepEvent,this);}}};b.prototype._handleStepEvent=function(e){if(e.type===sap.ve.dvl.DVLSTEPEVENT.DVLSTEPEVENT_STARTED){this._visibilityTracker.clear();}};b.prototype.getCanTrackVisibilityChanges=function(){return this._canTrackVisibilityChanges;};b.prototype.setCanTrackVisibilityChanges=function(c){this._canTrackVisibilityChanges=c;};b.prototype._getShouldTrackVisibilityChanges=function(){return this._shouldTrackVisibilityChanges;};b.prototype._collectNodesRecursively=function(n){var r=[],t=this;n.forEach(function collectChildNodes(c){r.push(c);t._nodeHierarchy.enumerateChildren(c,collectChildNodes,false,true);});return r;};b.prototype._getOpacity=function(n){if(this._nodeStates.has(n)){var o=this._nodeStates.get(n).opacity;return o===undefined?null:o;}else{return null;}};b.prototype.getOpacity=function(n){if(Array.isArray(n)){return n.map(this._getOpacity,this);}else{return this._getOpacity(n);}};b.prototype.setOpacity=function(n,o,r){if(!Array.isArray(n)){n=[n];}var c=q.sap.unique(r?this._collectNodesRecursively(n):n).filter(function(d){return this._getOpacity(d)!==o;},this);if(c.length>0){c.forEach(function(d){var e=this._nodeStates.get(d);if(e){if(o===null){delete e.opacity;}else{e.opacity=o;}}else if(o!==null){this._nodeStates.set(d,{opacity:o});}},this);this.fireOpacityChanged({changed:c,opacity:o});}return this;};b.prototype._getTintColorABGR=function(n){if(this._nodeStates.has(n)){var t=this._nodeStates.get(n).tintColorABGR;return t===undefined?null:t;}else{return null;}};b.prototype._getTintColor=function(n){if(this._nodeStates.has(n)){var t=this._nodeStates.get(n).tintColorABGR;return t===undefined?null:sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(t));}else{return null;}};b.prototype.getTintColor=function(n,i){var c=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(n)){return n.map(this[c],this);}else{return this[c](n);}};b.prototype.setTintColor=function(n,t,r){if(!Array.isArray(n)){n=[n];}var c=null;switch(typeof t){case"number":c=t;break;case"string":if(sap.ui.core.CSSColor.isValid(t)){c=sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(t));}break;default:t=null;break;}var d=q.sap.unique(r?this._collectNodesRecursively(n):n).filter(function(e){return this._getTintColorABGR(e)!==c;},this);if(d.length>0){d.forEach(function(e){var f=this._nodeStates.get(e);if(f){if(c===null){delete f.tintColorABGR;}else{f.tintColorABGR=c;}}else if(c!==null){this._nodeStates.set(e,{tintColorABGR:c});}},this);this.fireTintColorChanged({changed:d,tintColor:t,tintColorABGR:c});}return this;};V=function(){this._visibilityChanges=new Set();};V.prototype.getInfo=function(n){var f=function(v){return v.type==="VE_LOCATOR";};q.sap.require("sap.ui.vk.NodeProxy");var c=[];this._visibilityChanges.forEach(function(d){var e=new sap.ui.vk.NodeProxy(n,d),v=q.grep(e.getVeIds(),f)[0].fields[0].value;e.destroy();c.push(v);});return c;};V.prototype.clear=function(){this._visibilityChanges.clear();};V.prototype.trackNodeId=function(n){if(this._visibilityChanges.has(n)){this._visibilityChanges.delete(n);}else{this._visibilityChanges.add(n);}};return b;});
