/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/model/base/ManagedObjectModel','./FieldRenderer','sap/ui/base/Object','sap/ui/mdc/FieldHelp','sap/ui/model/BindingMode','sap/ui/mdc/FieldDisplay'],function(q,C,M,F,B,a,b,c){"use strict";var d=C.extend("sap.ui.mdc.Field",{constructor:function(i,s){this._oManagedObjectModel=null;this._oActiveDelegate=null;C.apply(this,arguments);},metadata:{library:"sap.ui.mdc",properties:{value:{type:"any",defaultValue:null},dataType:{type:"string",defaultValue:'string'},dataTypeOptions:{type:"object"},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:""},editable:{type:"boolean",group:"Data",defaultValue:true},contextEditable:{type:"boolean",group:"Data",defaultValue:true},required:{type:"boolean",group:"Data",defaultValue:false},icon:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:null},description:{type:"string",defaultValue:null},display:{type:"sap.ui.mdc.FieldDisplay",defaultValue:sap.ui.mdc.FieldDisplay.Value},textAlign:{type:"sap.ui.core.TextAlign",group:"Appearance",defaultValue:sap.ui.core.TextAlign.Initial},textDirection:{type:"sap.ui.core.TextDirection",group:"Appearance",defaultValue:sap.ui.core.TextDirection.Inherit},placeholder:{type:"string",group:"Misc",defaultValue:null},valueState:{type:"sap.ui.core.ValueState",group:"Appearance",defaultValue:sap.ui.core.ValueState.None},valueStateText:{type:"string",group:"Misc",defaultValue:null}},events:{validate:{},change:{parameters:{value:{type:"string"},valid:{type:"boolean"}}},dataChanged:{}},aggregations:{content:{type:"sap.ui.core.Control",multiple:false}},associations:{fieldHelp:{type:"string",group:"Behavior",defaultValue:"Auto"}},publicMethods:[],defaultAggregation:"content",defaultProperty:"value"},_bAvoidParentTextAlign:true});var F=d.getMetadata().getRenderer();d.prototype.applySettings=function(s){this._bIsInitializing=true;C.prototype.applySettings.apply(this,arguments);var D=this.getDataType();if(this._sInternalFieldHelp){var g=a._getDataType(this._sInternalFieldHelp,this._getDataTypeForFieldHelp());if(!D||D=="string"||D!=g){D=g;}}if(D&&D!="string"){this._applyDataType(D);}this._bIsInitializing=false;this.invalidate();return this;};d.prototype.exit=function(){if(this._oValueStateMessage){this._oValueStateMessage.destroy();this._oValueStateMessage=null;}};d.prototype.setContextEditable=function(v){this.setProperty("contextEditable",v);if(this.getContent()){this._oManagedObjectModel.checkUpdate();}};d.prototype._getEditable=function(){return this.getEditable()&&this.getContextEditable();};d.prototype.setDescription=function(v){var o=this.getDescription();this.setProperty("description",v);F.updateDom("value",this,v,o);return this;};d.prototype.setValue=function(v){var o=this.getValue();this._vInternalValue=this._determineInternalValue(v);if(this._oManagedObjectModel){this._oManagedObjectModel.setProperty("/@custom/internalValue",this._vInternalValue);}this.setProperty("value",v);F.updateDom("value",this,v,o);this._bValid=true;return this;};d.prototype._determineInternalValue=function(v){var i=v;var o=this.getBinding("value");if(o){i=o.getValue();}return i;};d.prototype._determineExternalValue=function(i){var E=i;var o=this.getBinding("value");if(o&&o.oType&&o.oType.formatValue){E=o.oType.formatValue(i,o.sInternalType);}return E;};d.prototype._setInternalValue=function(v,u){if(this._checkInternalValue){this._checkInternalValue(v);}this._vInternalValue=v;if(u){var E=this._determineExternalValue(v);var o=this.getBinding("value");if(o){o.setValue(this._vInternalValue);o.resume();}else{this.setProperty("value",E);}}else{this.invalidate();}if(this._oManagedObjectModel){this._oManagedObjectModel.setProperty("/@custom/internalValue",this._vInternalValue);}return this;};d.prototype._fireChange=function(){var v;if(!this._bValid&&!this.getContent()){v=this.$("input").val();}else{v=this.getValue();}this.fireChange({value:v,valid:this._bValid});};d.prototype.setPlaceholder=function(v){var o=this.getPlaceholder();this.setProperty("placeholder",v,true);F.updateDom("placeholder",this,v,o);return this;};d.prototype.setIcon=function(v){var o=this.getIcon();this.setProperty("icon",v,true);F.updateDom("icon",this,v,o);return this;};d.prototype.setValueState=function(v){var o=this.getValueState();this.setProperty("valueState",v,true);F.updateDom("valueState",this,v,o);v=this.getValueState();if(v===o){return this;}if(!this.getDomRef()){return this;}if(!this.getContent()&&this.$("input")[0]===document.activeElement){if(v===sap.ui.core.ValueState.None){this.closeValueStateMessage();}else if(this.shouldValueStateMessageBeOpened()){this.openValueStateMessage();}}return this;};d.prototype.onfocusin=function(){if(!this.getContent()&&this._getEditable()){this._activateDelegate();}if(this.shouldValueStateMessageBeOpened()){this.openValueStateMessage();}};d.prototype.onfocusout=function(){this.closeValueStateMessage();};d.prototype.getIdForLabel=function(){var i;var o=this.getContent();if(o){i=o.getId();}else{i=this.getId()+"-input";}return i;};d.prototype._activateDelegate=function(){this.addDelegate(f.attach(this,this.getDomRef().firstChild),false,false);};d.prototype._getFormattedValue=function(){var v;if(this.formatValue){v=this.formatValue(this._vInternalValue);}else{v=this.getValue();}return v;};d.prototype._getOutputValue=function(){if(this._bValid){var v=this._getFormattedValue()||"";var D=this.getDisplay();if(D===c.Value){return v;}var s=this.getDescription();if(D===c.Description){return s;}else if(D===c.ValueDescription){return v+(s?" ("+s+")":"");}else if(D===c.DescriptionValue){return(s?s:"")+" ("+v+")";}}else{if(!this.getContent()&&this.getDomRef()){return this.$("input").val();}}};d.prototype._applyDataType=function(D){if(this._sEnrichedDataType&&this._sEnrichedDataType==D){return this;}q.sap.require("sap.ui.mdc.FieldDataTypes");var g=sap.ui.mdc.FieldDataTypes;g.enrich(this,D);this.setValue(this.getValue());return this;};d.prototype.updateModelProperty=function(n,v,o){if(this.isBound(n)){var g=this.getBinding(n);if(g&&g.getBindingMode()===b.TwoWay){var t=typeof v;if(t==="string"){g.sInternalType="string";}else if(t==="number"){g.sInternalType="float";}else if(v instanceof Date){g.sInternalType="string";}}}return C.prototype.updateModelProperty.apply(this,arguments);};d.prototype._handleContextChange=function(){var o=this.getContent();if(o&&this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true);o.invalidate();o.setModel(this._oManagedObjectModel,"$field");}};d.prototype._activateManagedObjectModel=function(){var o=this.getContent();if(o){this._oManagedObjectModel=new M(this);o.setModel(this._oManagedObjectModel,"$field");o.bindElement({path:"/",model:"$field"});this._oManagedObjectModel.setProperty("/@custom/internalValue",this._vInternalValue);}};d.prototype._deactivateManagedObjectModel=function(){var o=this.getContent();if(o){o.unbindElement("$field");this.detachModelContextChange(this._handleContextChange,this);this._oManagedObjectModel.destroy();this._oManagedObjectModel=null;}};d.prototype.setParent=function(){C.prototype.setParent.apply(this,arguments);if(!this.getParent()){this._deactivateManagedObjectModel();}else{this._activateManagedObjectModel();}};d.prototype.setContent=function(o,s){this._deactivateManagedObjectModel();var O=this.getContent();if(O&&O.getMetadata().getEvents().change){o.detachEvent("change",_,this);}var r=this.setAggregation("content",o,s);if(o&&this.getParent()){this._activateManagedObjectModel();}if(o&&o.getMetadata().getEvents().change){o.attachEvent("change",_,this);}return r;};function _(E){var v=this.getValue();var V=true;if(E.getParameters().valid){V=E.getParameter("valid");}this.fireChange({value:v,valid:V});}d.prototype.getFocusDomRef=function(){if(this._getEditable()){return this.getDomRef().firstChild;}return this.getDomRef();};d.prototype.onmousedown=function(E){if(this._getEditable()){this.focus();if(E.target&&E.target.className.indexOf("sapUiMdcFHButton")>-1){E.stopPropagation();this._toggleFieldHelp();}}};d.prototype.shouldValueStateMessageBeOpened=function(){return((this.getValueState()!==sap.ui.core.ValueState.None)&&this.getEditable());};d.prototype.openValueStateMessage=function(){if(!this._oValueStateMessage){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap.m.delegate.ValueStateMessage");var V=sap.m.delegate.ValueState;this._oValueStateMessage=new V(this);}this._oValueStateMessage.open();};d.prototype.closeValueStateMessage=function(){if(this._oValueStateMessage){this._oValueStateMessage.close();}};d.prototype.getDomRefForValueStateMessage=function(){return this.getFocusDomRef();};d.prototype.iOpenMessagePopupDuration=0;d.prototype.getValueStateMessageId=function(){return this.getId()+"-message";};d.prototype.setFieldHelp=function(v,s){this.setAssociation("fieldHelp",v,true);this._sInternalFieldHelp=v.substring(v.lastIndexOf("--")+2);if(!a._isDefaultType(this._sInternalFieldHelp)){this._sInternalFieldHelp=v;}return this;};d.prototype._getDataTypeForFieldHelp=function(){if(this.isBound("value")){var o=this.getBinding("value");if(o&&o.getType()){return o.getType();}else{return typeof(this._vInternalValue);}}return null;};d.prototype._getDataTypeOptionsForFieldHelp=function(){return this.getDataTypeOptions();};d.prototype._handleFieldHelpSelect=function(E){if(this.isBound("value")){this.getBinding("value").resume();}this._bValid=true;this._setInternalValue(E.getParameter("value"),true);this._fireChange();};d.prototype._handleFieldHelpChange=function(E){this.setValue(E.getParameter("value"));this._fireChange();};d.prototype._handleFieldHelpClose=function(E){this.oFieldHelp=null;E.getSource().detachSelect(this._handleFieldHelpSelect,this);};d.prototype._toggleFieldHelp=function(){if(this.oFieldHelp){if(this.isBound("value")){this.getBinding("value").resume();}this.oFieldHelp.close();}else{var t=this._sInternalFieldHelp;if(this.isBound("value")){this.getBinding("value").suspend();}if(this._checkInternalValue){this._checkInternalValue(this._vInternalValue);}this.oFieldHelp=a.open(this,{type:t,dataType:this._getDataTypeForFieldHelp(),dataTypeOptions:this._getDataTypeOptionsForFieldHelp(),value:this._vInternalValue,select:this._handleFieldHelpSelect,close:this._handleFieldHelpClose,liveChange:this._handleFieldHelpChange});}};d.prototype.onsapshow=d.prototype.onsaphide=function(E){this._toggleFieldHelp();};d.prototype._getFieldHelpIcon=function(){if(this._sInternalFieldHelp==="None"){return null;}return a._getIcon(this._sInternalFieldHelp,this._getDataTypeForFieldHelp());};d.prototype.destroy=function(){this._deactivateManagedObjectModel();C.prototype.destroy.apply(this,arguments);};var e=B.extend("sap.ui.mdc.FieldInputDelegate",{constructor:function(o){B.apply(this);this._oOwner=null;}});e.prototype.destroy=function(){this.detach();};e.prototype.detach=function(){if(this._oOwner){this._oOwner.removeDelegate(this);}this._oOwner=null;this._oDomRef=null;};e.prototype.attach=function(o,D){this.detach();this._oOwner=o;this._oDomRef=D;return this;};e.prototype.onfocusin=function(E){if(!this._oOwner._getEditable()){return;}if(this._oOwner.getDescription()){this._oDomRef.value=this._oOwner._getFormattedValue();}};e.prototype.onfocusout=function(E){this._checkChange(E);this.detach();};e.prototype.onsapenter=function(E){this._checkChange(E);};e.prototype._checkChange=function(E){if(this._oOwner._getEditable()&&E.target===this._oDomRef){var v=this._oDomRef.value;if(this._oOwner.parseValue&&this._oOwner.formatValue){if(v!=this._oOwner.formatValue(this._oOwner._vInternalValue)){var i=this._oOwner.parseValue(v);if(v&&!i){this._oOwner._bValid=false;}else{this._oOwner._bValid=true;this._oOwner._setInternalValue(i,true);}this._oOwner._fireChange();}else if(this._oOwner.getValue()!=this._oOwner.formatValue(this._oOwner._vInternalValue)&&this._oOwner._bValid){this._oOwner._setInternalValue(this._oOwner._vInternalValue,true);this._oOwner._fireChange();}}else if(v!=this._oOwner.getValue()){this._oOwner.setValue(v);this._oOwner._fireChange();}if(this._oOwner._bValid){this._oDomRef.value=this._oOwner._getOutputValue();}}};var f=new e();return d;},true);
